* ox-astro: An Org Mode Exporter for Astro MDX

~ox-astro.el~ is a specialized back-end for the Org export engine, designed to convert Org mode files into Astro-compatible MDX (~.mdx~) files. It streamlines the process of writing blog posts in Org mode for publication on an Astro website.

The exporter automates many of the tedious parts of content creation, including front-matter generation, image handling, and Markdown-specific formatting, allowing you to focus on writing.

* Installation and Setup

To use this exporter, save the following files to your Emacs load path:
- ~ox-astro.el~ (the main file)
- ~ox-astro-config.el~ (configuration options)
- ~ox-astro-helpers.el~ (internal helper functions)
- ~ox-astro-handlers.el~ (export and filter handlers)

Then, add the following to your Emacs configuration (~init.el~):

#+begin_src emacs-lisp
(with-eval-after-load 'ox
  (require 'ox-astro))
#+end_src

* Core Features

- **MDX Export**: Converts Org files to ~.mdx~ format, ready for Astro.
- **Automatic Front Matter**: Generates YAML front matter from Org keywords and content.
- **Advanced Image Handling**: Automatically detects, copies, and processes images from anywhere on your filesystem, converting them into optimized Astro `<Image>` components.
- **Interactive Workflow**: Prompts for a destination folder if one isn't specified, making it easy to work with multiple Astro projects.
- **Advanced Formatting**: Intelligently handles Org-specific syntax (like TODOs and tables) and converts it to the correct Markdown equivalent.
- **org-roam Integration**: Respects org-roam file structure and properties blocks.
- **Subtree Export**: Export individual subtrees as standalone blog posts.
- **Mixed Link Support**: Preserves existing Markdown links while processing Org links and converting raw URLs into custom components.

* How to Use

1.  Open the Org file you want to export.
2.  Set the destination folder using the `#+DESTINATION_FOLDER` keyword. You can use a nickname from your `org-astro-known-posts-folders` list or provide a full, absolute path to any directory.
3.  Run the command ~M-x org-astro-export-to-mdx~.
4.  If the destination is not specified in the file, you will be prompted to select one from your pre-configured list.
5.  The ~.mdx~ file will be generated in the specified destination.

** Subtree Export

You can export individual subtrees as standalone blog posts. This is especially useful for org-roam workflows where you might have multiple blog posts as subtrees in a single file.

1.  Position your cursor on the heading you want to export.
2.  Run ~M-x org-narrow-to-subtree~ to narrow to just that subtree.
3.  Run ~M-x org-astro-export-to-mdx~ with the subtree parameter: ~C-u M-x org-astro-export-to-mdx~
4.  Keywords like ~#+EXCERPT~ and ~#+PUBLISH_DATE~ will be inserted within the subtree, below the heading.

* Front Matter Generation

The exporter automatically generates YAML front matter based on keywords in your Org file.

**Supported Keys:**
| Org Keyword          | YAML Key    | Description                                 |
|----------------------+-------------+---------------------------------------------|
| ~#+TITLE~              | ~title~       | The title of the post.                      |
| ~#+AUTHOR~             | ~author~      | The author's name. Defaults to "Jay Dixit". |
| ~#+DATE~               | ~publishDate~ | The publication date.                       |
| ~#+EXCERPT~            | ~excerpt~     | A short summary of the post.                |
| ~#+COVER_IMAGE~        | ~image~       | Path to the post's cover image.             |
| ~#+COVER_IMAGE_ALT~    | ~imageAlt~    | Alt text for the cover image.               |
| ~#+TAGS~               | ~tags~        | A comma- or space-separated list of tags.   |
| ~#+AUTHOR_IMAGE~       | ~authorImage~ | Path to the author's image.                 |
| ~#+VISIBILITY~         | ~hidden~      | Set to "hidden" to mark post as hidden.     |
| ~#+STATUS~             | ~draft~       | Set to "draft" to mark post as draft.       |
| ~#+DESTINATION_FOLDER~ | (none)      | Specifies the export destination folder.    |

**Fallback Logic:**
- If ~#+TITLE~ is not found, the exporter uses the first level-1 headline.
- If ~#+EXCERPT~ is not found, it uses the first paragraph of the document.
- If ~#+DATE~ is not found, it uses the current time.
- If ~#+COVER_IMAGE_ALT~ is not found, it generates a human-readable alt text from the image's filename.

* Advanced Image Handling

The exporter simplifies image management by automatically processing and importing them. It uses Astro's built-in `<Image>` component to ensure all images are optimized.

The process is the same for cover images and images in the body of the text:
1.  **Detection**: The exporter finds images specified as standard Org links (`[[file:...]]`) *and* raw absolute paths (e.g., `/Users/jay/Downloads/my-pic.png`) placed on their own line.
2.  **Copying**: The image file is copied from its original location to your Astro project's `src/assets/images/posts/` directory. Filenames are sanitized to be web-friendly.
3.  **Import Generation**: An ES6 import statement is added to the top of the `.mdx` file. The path uses Astro's `~/` alias for robustness.
    #+begin_src javascript
    import { Image } from 'astro:assets';
    import myPic from '~/assets/images/posts/my-pic.png';
    #+end_src
4.  **Component Conversion**: The Org link or raw path is converted into an `<Image>` component that uses the imported image variable, ready for Astro's optimization pipeline.
    #+begin_src html
    <Image src={myPic} alt="My pic" />
    #+end_src

**Example Workflow**

Simply drop an absolute path to an image on its own line:
#+begin_example
This is my introductory paragraph.

/Users/jay/Pictures/my-diagram.png

And the text continues here.
#+end_example

The exporter handles the rest automatically, making it incredibly fast to add images to your content.

* Link Handling

The exporter distinguishes between standard links with descriptions and raw, bare URLs.

**Standard Links**
A standard Org link with a description is converted directly to its Markdown equivalent.
- *Org*: ~[[https://google.com][Search with Google]]~
- *MDX*: ~[Search with Google](https://google.com)~

**Preserve Existing Markdown Links**
If your Org text already includes Markdown-formatted links, they are preserved verbatim. This allows pasting Markdown prose directly into Org without reformatting.

**Raw URLs (LinkPeek)**
A bare URL without a description is automatically converted into a custom ~<LinkPeek>~ component, which can be styled to provide rich link previews.
- *Org*: ~https://google.com~
- *MDX*: ~<LinkPeek href="https://google.com"></LinkPeek>~

When any ~<LinkPeek>~ is emitted, ox-astro automatically adds the necessary import to the top of the MDX file.

* Special Formatting Rules

~ox-astro~ includes several rules to convert Org syntax to modern Markdown.

**TODO Items**
Org TODO items are converted into Markdown task lists.
- ~*** TODO Buy milk~ becomes ~- [ ] Buy milk~
- ~*** DONE Pay bills~ becomes ~- [x] Pay bills~

**Tables**
Org tables are converted to clean Markdown table format instead of HTML.

* Customization

You can customize the exporter's behavior using ~M-x customize-group~ and selecting ~org-export-astro~.

- ~org-astro-known-posts-folders~ :: A list of your frequently used destination folders, each with a convenient nickname.
- ~org-astro-default-author-image~ :: Sets a default path for the author's image.
- ~org-astro-date-format~ :: A string to control the format of the ~publishDate~ in the front matter.