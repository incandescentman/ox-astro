#+TITLE: ox-astro Work Log
#+AUTHOR: Jay Dixit & Claude
#+DATE: 2025-10-17

* 2025-11-02 Saturday - OG Images for Movie Pages

** Summary
Created AI-generated OG images for watchlist and movies pages featuring Criterion Collection-style and film noir aesthetics. Images capture cinephile sophistication with rain/storm motifs and neon signage. Optimized aspect ratio from 1:1 to 3:2 for better iOS/social media display.

** Goal
Design and implement distinctive OG images that:
1. *Reflect cinephile aesthetic* - Sophisticated, curated film collection vibe
2. *Use atmospheric imagery* - Rain, storms, noir lighting for dramatic impact
3. *Clear branding* - "WATCHLIST" and "MOVIES" text clearly readable
4. *Optimize for social sharing* - Work well on iOS/iMessage and social platforms
5. *Correct aspect ratio* - 1536x1024 (3:2) for minimal cropping

** Implementation

*** Watchlist Page OG Image
*File*: =/apps/jaydocs/public/watchlist-og.png= (1536x1024px)
*Page*: =/watchlist=
*Initial versions*: =man-criterion-2.png= (1024x1024), =man-criterion.png=, =motel-watchlist.png=

Design approach:
- Criterion Collection/Saul Bass aesthetic
- Silhouetted figure walking through geometric rain
- Warm color palette (cream, rust/burgundy, black)
- "WATCHLIST - A FILM COLLECTION" typography
- Diagonal rain lines creating dynamic composition
- Mid-century modern/Bauhaus influence

Image generation prompt focused on:
#+begin_quote
Abstract geometric composition showing a silhouetted figure walking through torrential rain, depicted with stark vertical lines and angular shapes. Use only black, white, and one accent color (deep red). Bold sans-serif text: "WATCHLIST" in uppercase. Bauhaus/Swiss design influence. Museum-quality aesthetic. Reminiscent of Akira Kurosawa rain scenes abstracted to geometric forms.
#+end_quote

Alternative versions generated:
- =man-criterion.png= - Blue rain variant with more contemporary feel
- =motel-watchlist.png= - Neon cyan "WATCHLIST" motel sign in storm

*** Movies Page OG Image
*File*: =/apps/jaydocs/public/movies-og.png= (1536x1024px)
*Page*: =/movies=
*Initial version*: =movies-motel.png= (1024x1024)

Design approach:
- Film noir neon motel sign aesthetic
- Flickering neon "MOVIES" sign in cyan/magenta
- Torrential rain with dramatic vertical streaks
- Dark, moody atmosphere with wet pavement reflections
- Small film reel silhouette in motel window
- Neo-noir/David Lynch atmospheric dread

Image generation prompt focused on:
#+begin_quote
Moody film noir scene: a flickering neon motel sign glowing with the word "MOVIES" during a torrential rainstorm at night. Dominant vertical rain lines in stark white/cyan against deep black. The neon sign buzzes with electric blue and magenta, casting eerie reflections on wet pavement. Neo-noir meets 1950s thriller movie poster aesthetic.
#+end_quote

** Technical Implementation

*** Initial Implementation (Square Images)
First iteration used 1024x1024px square images, which were suboptimal for OG display.

*** Aspect Ratio Issue Discovery
Testing with Facebook OG debugger revealed:
- Square 1:1 images get cropped awkwardly on social platforms
- iOS/iMessage prefers 2:1 ratio (1200x600px ideal)
- Facebook uses 1.91:1 ratio (1200x630px)
- Compromise: 3:2 ratio (1536x1024px) works well across platforms

*** Prop Name Fix
Layout component expected =ogImage= prop, not =image=:
#+begin_src astro
// Fixed prop name from 'image' to 'ogImage'
<Layout ogImage="/watchlist-og.png">
#+end_src

*** Final Implementation
Updated Astro Layout component calls with corrected prop and wider images:
#+begin_src astro
// watchlist.astro
<Layout
  title="Watch List"
  description="Movies I want to watch"
  ogImage="/watchlist-og.png"
>

// movies.astro
<Layout
  title="Most Beloved Movies"
  description="My favorite movies from Letterboxd"
  ogImage="/movies-og.png"
>
#+end_src

Images placed in =/apps/jaydocs/public/= for direct URL access.

Layout component OG meta tag generation (Layout.astro:33):
#+begin_src astro
{ogImage && <meta property="og:image" content={new URL(ogImage, Astro.url).href} />}
#+end_src

** Design Philosophy

*Watchlist (Criterion style)*:
- Warm, sophisticated, editorial
- Timeless classic cinema aesthetic
- Museum-quality curation vibe
- Inviting rather than brooding

*Movies (Noir motel)*:
- Atmospheric, dramatic, moody
- Midnight cinema energy
- Psychological thriller undertones
- Unique and memorable

Both approaches convey "serious cinephile with refined taste" through different aesthetic lenses.

** User Impact
- Social media shares of =/watchlist= and =/movies= now display custom OG images
- Distinctive visual identity differentiates the two film-related pages
- Professional, curated aesthetic reinforces quality of film selections
- Images work well at small social media thumbnail sizes

** Files Modified

*** Initial Square Images (1024x1024, deprecated)
- =apps/jaydocs/public/man-criterion-2.png= (1.7M, Criterion style)
- =apps/jaydocs/public/man-criterion.png= (1.9M, blue variant)
- =apps/jaydocs/public/motel-watchlist.png= (2.0M, neon sign)
- =apps/jaydocs/public/movies-motel.png= (2.3M, movies neon)

*** Final Optimized Images (1536x1024, 3:2 ratio)
- =apps/jaydocs/public/watchlist-og.png= (personalized "JAY'S WATCHLIST")
- =apps/jaydocs/public/movies-og.png= (personalized "JAY'S FAVORITE MOVIES")
- =apps/jaydocs/public/books-og.png= (new - "JAY'S FAVORITE BOOKS", Penguin aesthetic)
- =apps/jaydocs/public/reading-list-og.png= (new - "JAY'S READING LIST", treasure map)

*** Page Updates
- =apps/jaydocs/src/pages/watchlist.astro= (added ogImage prop)
- =apps/jaydocs/src/pages/movies.astro= (added ogImage prop)
- =apps/jaydocs/src/pages/books.astro= (added ogImage prop)
- =apps/jaydocs/src/pages/readlist.astro= (added ogImage prop)

** Lessons Learned
1. *AI image generation workflow* - Criterion-style geometric abstraction worked better than literal motel imagery for watchlist; motel neon worked perfectly for movies page
2. *Text legibility critical* - Explicitly stating "clearly legible and central" in prompts ensures AI renders text properly
3. *Color palette matters* - Warm palette (cream/rust) feels more sophisticated than cool blue for curated collections
4. *Storm/rain motif versatile* - Works for both elegant Criterion aesthetic and noir motel vibe
5. *Multiple variants useful* - Generated 3 watchlist options to choose best fit; kept alternatives for future use
6. *Aspect ratio critical for OG images* - Square 1:1 images get cropped badly on social platforms; 3:2 ratio (1536x1024) provides good compromise between iOS (prefers 2:1) and Facebook (1.91:1)
7. *Test with Facebook OG debugger* - Revealed aspect ratio issues and prop name mismatch; use https://developers.facebook.com/tools/debug/ to validate
8. *Prop naming matters* - Layout component expected =ogImage= not =image=; checking component interfaces prevents silent failures
9. *Iterative optimization* - Started with square images, discovered issues through testing, regenerated with better specs
10. *Personalization matters* - "JAY'S WATCHLIST" much more distinctive than generic "WATCHLIST"; personal branding makes images more memorable
11. *Theme-appropriate design language* - Films use Criterion/noir aesthetic, books use Penguin Classics/vintage covers; matching design to content type creates coherence
12. *Consistent dimensions* - Established 1536x1024 as standard across all pages; simplifies generation and ensures consistent social media display

** Iteration 2: Personalized Images

*** Discovery
Initial generic images ("WATCHLIST", "MOVIES") lacked personal touch. Regenerated with personalized text for more distinctive branding.

*** Updated Images

**** Watchlist (Final)
*File*: =watchlist-og.png= (1536x1024)
- Changed from generic "WATCHLIST" to "JAY'S WATCHLIST"
- Dramatic black and blue geometric rain design
- More striking and personal

**** Movies (Final)
*File*: =movies-og.png= (1536x1024)
- Changed from generic "MOVIES" to "JAY'S FAVORITE MOVIES"
- Noir motel sign with "MOTEL" header
- Cyan and pink neon aesthetic
- More atmospheric and personal

**** Books (New)
*File*: =books-og.png= (1536x1024)
*Page*: =/books=
- "JAY'S FAVORITE BOOKS" with open book design
- Penguin Classics aesthetic (cream, black, orange)
- Classic literary sophistication
- "A Reading Collection" subtitle with page number

**** Reading List (New)
*File*: =reading-list-og.png= (1536x1024)
*Page*: =/readlist=
- "JAY'S READING LIST" with vintage adventure book cover
- Treasure map design with compass and nautical elements
- Dark blue and gold color scheme
- Evokes exploration and discovery

** Design Evolution Summary

*** Watchlist & Movies
*First iteration*: Square 1024x1024, generic text
*Second iteration*: Rectangular 1536x1024, personalized "JAY'S" branding
*Aesthetic*: Film noir, Criterion Collection, atmospheric storm imagery

*** Books Pages
*Single iteration*: Started with correct 1536x1024 ratio and personalized text
*Aesthetic*: Penguin Classics, vintage book covers, literary sophistication
*Key difference*: Books use Penguin/classic book design language instead of Criterion Collection (film-specific)

** Current Status

All OG images implemented and tested:
- ✅ Watchlist (https://dixit.ca/watchlist)
- ✅ Movies (https://dixit.ca/movies)
- ✅ Books (https://dixit.ca/books)
- ✅ Reading List (https://dixit.ca/readlist)

All images deployed to production, using 1536x1024 (3:2 ratio), personalized "JAY'S" branding.

** Next Steps
- Consider OG images for TV pages (=/tv= and =/tv-watchlist=)
- Potential new page: =/tools= - curated list of software/apps/services Jay uses
  - Need to determine structure (category-based vs use-case-based vs simple list)
  - Need to decide what info to track (name, description, category, rating, platform, etc.)
  - Need OG image aesthetic direction (terminal/code style vs minimal/Swiss vs workspace vs blueprint)
- May add itinerary/travel OG images
- Established pattern: 1536x1024, personalized "JAY'S" branding, theme-appropriate aesthetic

* 2025-11-02 Saturday - Theme Separation & Claude Pullquote Modernization

** Summary
Created separate default theme from ChatGPT, refined ChatGPT theme styling (pure white background, lighter h2 headings, cleaner pullquotes), and modernized Claude theme pullquotes with elegant gradients, responsive typography, and warm crail-colored accents.

** Goal
1. *Separate themes* - Duplicate ChatGPT to default theme so they can diverge independently
2. *Refine ChatGPT aesthetic* - Pure white background, lighter headings, cleaner shadows
3. *Modernize Claude pullquotes* - Transform from traditional borders to elegant gradient-based design with warm sophistication
4. *Blank line preservation* - Ensure pullquotes respect blank lines in content

** Problems Discovered

*** ChatGPT and Default Themes Were Identical
No separation between baseline default styling and opt-in ChatGPT theme - couldn't evolve ChatGPT theme without affecting all posts.

*** ChatGPT Pullquotes Had Heavy Blue Glow
Multi-layered blue box-shadow (3 layers) created excessive glow around pullquotes, looked less clean and modern.

*** ChatGPT H2 Headings Too Bold
H2 weight of 700 (bold) felt heavy for the clean, modern aesthetic. Size also too large.

*** Claude Pullquotes Felt Dated
Traditional top/bottom border design with large (6rem) quote marks at 30% opacity, all-italic text, and fixed sizing felt more magazine-traditional than modern-elegant.

*** Blank Lines Not Preserved in Pullquotes
Using =white-space: pre-line= collapsed blank lines in pullquote content - users couldn't add paragraph breaks within quotes.

** Solutions Implemented

*** 1. Created Separate Default Theme
*File*: =/apps/socratic/src/styles/default-theme.css=

Duplicated chatgpt-theme.css to default-theme.css:
- Renamed all =--chatgpt-*= variables to =--default-*=
- Renamed all =.chatgpt-theme-wrapper= classes to =.default-theme-wrapper=
- Updated =[...blog]/index.astro= to import and map default theme
- Made default theme the automatic fallback: =post.theme ?? 'default'=

Default theme keeps light blue-gray background (=#f8fafc=).

*** 2. Refined ChatGPT Theme Styling
*File*: =/apps/socratic/src/styles/chatgpt-theme.css=

Background change:
#+begin_src css
--chatgpt-bg: #FFFFFF;  /* Changed from #f8fafc to pure white */
#+end_src

H2 heading refinement:
#+begin_src css
.chatgpt-theme-wrapper .prose h2 {
  font-weight: 600;      /* Reduced from 700 (bold) to 600 (semibold) */
  font-size: 1.5rem;     /* Reduced from default ~1.875rem */
}
#+end_src

Cleaner pullquote shadow:
#+begin_src css
/* Before: 3-layer blue glow */
box-shadow:
  0 1px 3px rgba(59, 130, 246, 0.08),
  0 8px 24px -8px rgba(37, 99, 235, 0.12),
  0 24px 48px -16px rgba(37, 99, 235, 0.08);

/* After: Simple clean shadow */
box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
#+end_src

Pale sky blue quote marks:
#+begin_src css
color: rgba(135, 206, 235, 0.25);  /* Changed from rgba(37, 99, 235, 0.12) */
#+end_src

*** 3. Modernized Claude Pullquote Design
*File*: =/apps/socratic/src/styles/claude-theme.css=

Responsive typography:
#+begin_src css
font-size: clamp(1.375rem, 1rem + 1.25vw, 1.875rem);  /* Was fixed 1.75rem */
line-height: 1.55;                                     /* Was 1.4 */
font-weight: 450;                                      /* Was 400 */
font-style: normal;                                    /* Was italic */
#+end_src

Warm gradient background with depth:
#+begin_src css
background: linear-gradient(135deg, rgba(249, 248, 245, 0.6), rgba(255, 255, 255, 0.4));
border-radius: 20px;
border: 1px solid rgba(193, 95, 60, 0.2);
box-shadow:
  0 2px 4px rgba(193, 95, 60, 0.08),
  0 12px 28px -8px rgba(193, 95, 60, 0.12);
/* Replaced: border-top/bottom 2px solid var(--claude-link) */
#+end_src

Responsive spacing:
#+begin_src css
padding: clamp(2.25rem, 4vw, 3.5rem);     /* Was fixed 2.5rem 3rem */
margin: clamp(3rem, 5vw, 4.5rem) auto;    /* Was fixed 3rem auto */
max-width: 48rem;                          /* Was 85% */
#+end_src

More subtle quote marks:
#+begin_src css
font-size: clamp(4rem, 3rem + 4vw, 6rem);  /* Was fixed 6rem */
opacity: 0.15;                              /* Was 0.3 */
/* Responsive positioning with clamp */
top: clamp(-0.5rem, 0.5vw, 0rem);
left: clamp(0.75rem, 3vw, 1.5rem);
bottom: clamp(-1.5rem, -0.5vw, -1rem);
right: clamp(1rem, 4vw, 2rem);
#+end_src

Strong/em styling:
#+begin_src css
.claude-theme-wrapper .pullquote strong {
  font-weight: 600;
  color: var(--claude-link);  /* Crail color for consistency */
}

.claude-theme-wrapper .pullquote em {
  font-style: italic;  /* Only italicize <em> elements */
}
#+end_src

*** 4. Fixed Blank Line Preservation
Changed =white-space= property in all three themes:
#+begin_src css
white-space: pre-wrap;  /* Was pre-line - now preserves all whitespace including blank lines */
#+end_src

** Implementation Details

*** Theme Architecture
Three independent themes with clear separation:
- *Default*: Light blue-gray background (=#f8fafc=), baseline styling for all posts without theme specified
- *ChatGPT*: Pure white background (=#FFFFFF=), lighter headings, opt-in via =theme: chatgpt=
- *Claude*: Warm cream background (=#f9f8f5=), crail accents, opt-in via =theme: claude=

*** Design Philosophy
*ChatGPT theme*: Clean, minimal, modern - lighter weights, pure white, subtle shadows
*Claude theme*: Warm, editorial, sophisticated - gradient depth, crail colors, serif typography

Both achieve "elegant and refined" through different approaches - ChatGPT through minimalism, Claude through warmth and depth.

*** Typography Improvements
All pullquotes now use:
- Responsive sizing with =clamp()= for fluid scaling
- Improved readability (=line-height: 1.55=, upright text)
- Consistent strong text colors matching theme identity
- Better mobile scaling via responsive padding/margins

** User Impact
- Posts can specify =theme: default=, =theme: chatgpt=, or =theme: claude= in frontmatter
- No theme specified → default theme applies automatically
- ChatGPT theme provides clean, modern aesthetic with pure white
- Claude theme provides warm, magazine-quality pullquotes
- Blank lines in pullquotes now render properly for paragraph breaks
- All three themes have polished, professional pullquote styling

** Testing
Verified in:
- =/claude-designs-a-goal-tracking-system= - Theme switching works correctly
- Pullquote styling consistent across all three themes
- Blank line preservation functional
- H2 headings render with correct weight/size in ChatGPT theme

** Files Modified
- =apps/socratic/src/styles/default-theme.css= (new file - 136 lines)
- =apps/socratic/src/styles/chatgpt-theme.css= (background, h2, pullquote shadow, quote marks, whitespace)
- =apps/socratic/src/styles/claude-theme.css= (complete pullquote redesign - ~70 lines changed)
- =apps/socratic/src/pages/[...blog]/index.astro= (import default theme, add to map, change default)

** Lessons Learned
1. *Theme separation enables evolution* - Creating default-theme.css allows ChatGPT theme to diverge without breaking existing posts
2. *Responsive typography scales better* - =clamp()= eliminates need for multiple media queries and provides smoother scaling
3. *Shadow subtlety matters* - Simple =0 1px 2px= shadow looks cleaner than multi-layer glows for modern aesthetic
4. *Quote mark opacity* - 15% opacity feels more sophisticated than 30%, especially with responsive sizing
5. *White-space property nuance* - =pre-line= collapses blank lines, =pre-wrap= preserves them - critical for paragraph breaks in quotes
6. *Gradient depth without borders* - Subtle gradients + box-shadow create depth more elegantly than solid borders
7. *Upright vs italic* - Roman text more readable at large sizes; reserve italic only for =<em>= emphasis

** Next Steps
- Monitor how themes evolve independently now that they're separated
- Consider adding more theme variants if needed
- Update instructions.org with new theme documentation

* 2025-11-02 Saturday - ChatGPT Theme Refinement & Default Theme Setup

** Summary
Refined ChatGPT theme with elegant pullquote styling, fixed user-block background color preservation, and made ChatGPT the default blog theme for consistent, modern styling across all posts.

** Goal
Create a polished, elegant default theme experience:
1. *Elegant pullquotes* - Magazine-quality typography with refined gradients and shadows
2. *Preserve user-block styling* - Maintain light gray backgrounds in ChatGPT theme
3. *Default theme behavior* - Apply ChatGPT theme automatically when no theme specified
4. *Visual consistency* - Use site-wide pink accent color for pullquote strong text

** Problems Discovered

*** ChatGPT Theme Lacked Pullquote Styling
ChatGPT theme had only a fallback comment for pullquotes - no actual styling was implemented.

*** User-Block Background Color Changed in ChatGPT Theme
When applying ChatGPT theme, user-block elements were picking up wrong background color (tan/beige from Claude theme variables) instead of default light gray (=#f5f5f5=).

*** No Default Theme Applied
Posts without explicit =theme:= frontmatter had no theme wrapper applied, resulting in inconsistent styling.

*** Strong Text Color Mismatched Site Accent
Pullquote strong text initially used blue, not matching Socratic's default pink link color.

** Solutions Implemented

*** 1. Elegant ChatGPT Pullquote Styling
*File*: =apps/socratic/src/styles/chatgpt-theme.css= lines 55-125

Created refined, modern pullquote design:
- Subtle gradient background (white to light slate)
- Delicate blue border (15% opacity)
- Three-tier shadow system for depth
- Charter serif font with fluid sizing
- Very subtle quotation marks (12% opacity)
- Generous 24px border radius
- Responsive clamp() scaling

#+begin_src css
.chatgpt-theme-wrapper .pullquote {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.98));
  border-radius: 24px;
  border: 1px solid rgba(59, 130, 246, 0.15);
  box-shadow:
    0 1px 3px rgba(59, 130, 246, 0.08),
    0 8px 24px -8px rgba(37, 99, 235, 0.12),
    0 24px 48px -16px rgba(37, 99, 235, 0.08);
  font-size: clamp(1.25rem, 0.875rem + 1.25vw, 1.75rem);
}
#+end_src

*Commits*:
- =7b27d20= - Add elegant pullquote styling for ChatGPT theme
- =a680407= - Move opening quote inside pullquote block
- =e632394= - Adjust opening quote position higher
- =edc34d9= - Move closing quote higher
- =5ae6136= - Adjust closing quote position lower

*** 2. Preserve User-Block Background Color
*File*: =apps/socratic/src/styles/chatgpt-theme.css= lines 55-63

Added explicit styling to maintain default light gray:

#+begin_src css
.chatgpt-theme-wrapper .user-block,
.chatgpt-theme-wrapper .prompt-block,
.chatgpt-theme-wrapper .user-prompt-block {
  background-color: #f5f5f5 !important;
}
#+end_src

*Commit*: =e428e9b= - Preserve default light gray background for user blocks

*** 3. Make ChatGPT Default Theme
*File*: =apps/socratic/src/pages/[...blog]/index.astro= line 61

Changed theme resolution to default to ChatGPT:

#+begin_src typescript
// Default to chatgpt theme if no theme specified
const themeClass = themeClassMap[post.theme ?? 'chatgpt'] ?? 'chatgpt-theme-wrapper';
#+end_src

*Commit*: =8828d82= - Make ChatGPT the default blog theme

*** 4. Use Site Accent Color for Strong Text
*File*: =apps/socratic/src/styles/chatgpt-theme.css= line 112

Matched pullquote strong text to Socratic's default pink link color:

#+begin_src css
.chatgpt-theme-wrapper .pullquote strong {
  color: rgb(244 114 182); /* pink-400 - matches site links */
}
#+end_src

*Commits*:
- =59bd243= - Use link color for pullquote strong text
- =08caef8= - Change strong text to pink-800 accent
- =fe112da= - Change strong text to pink-600 accent
- =bb24869= - Use pink accent for pullquote strong text to match Socratic default

** Implementation Details

*** Design Philosophy
The ChatGPT theme prioritizes:
- *Elegance* - Subtle gradients, refined shadows, delicate borders
- *Readability* - Smaller font size (1.25-1.75rem vs 1.625-2.25rem)
- *Modernism* - Generous border radius, layered shadows, fluid typography
- *Consistency* - Matches site-wide pink accent color

*** Quotation Mark Positioning
Quotation marks are positioned just inside the pullquote boundaries:
- Opening quote: =top: clamp(-0.25rem, 0.5vw, 0.25rem)=
- Closing quote: =bottom: clamp(-1.25rem, -0.5vw, -0.75rem)=

Creates subtle framing without overwhelming the content.

*** Theme Hierarchy
- *No theme specified* → ChatGPT theme (default)
- =theme: chatgpt= → ChatGPT theme (explicit)
- =theme: claude= → Claude theme (opt-in for warm serif aesthetic)

** User Impact

*** Default Modern Styling
All blog posts now automatically receive elegant, refined styling without requiring frontmatter configuration.

*** Consistent Visual Identity
ChatGPT theme provides cohesive design language:
- Pink accents matching site links
- Clean, modern typography
- Professional layered shadows
- Responsive fluid sizing

*** Simplified Authoring
Authors no longer need to specify =theme:= unless opting into Claude theme's warm serif aesthetic.

** Documentation
Updated =instructions.org= in astro-monorepo with:
- ChatGPT theme as default behavior
- Theme selection guidelines
- When to use Claude vs ChatGPT themes

** Testing
Manual verification:
- Goal tracking post renders with ChatGPT theme by default
- User-blocks maintain light gray background
- Pullquotes display with elegant styling
- Strong text uses pink accent color
- Responsive scaling works on mobile
- Quotation marks properly positioned

** Files Modified

*** astro-monorepo
- =apps/socratic/src/styles/chatgpt-theme.css= - Pullquote styling + user-block fix
- =apps/socratic/src/pages/[...blog]/index.astro= - Default theme logic
- =apps/socratic/src/content/blog/claude-designs-a-goal-tracking-system.mdx= - Removed theme frontmatter
- =instructions.org= - Documentation updates

** Status
✅ *COMPLETE* - ChatGPT theme refined and set as default across all blog posts.

** Lessons Learned

*** Visual Hierarchy
Pullquotes benefit from smaller font sizes than initially expected. Oversized text can overwhelm; refined proportions feel more elegant.

*** Color Consistency
Accent colors should match site-wide conventions (pink links) rather than introducing new colors per component.

*** Default Theme Strategy
Making a theme the default (rather than having "no theme" state) provides consistency and reduces configuration burden for authors.

*** Shadow Layering
Multiple subtle shadows (3-tier system) create more sophisticated depth than single heavy shadow.

* 2025-11-02 Saturday - Pull Quote Support, Gallery Columns & Code Backticks Fix

** Summary
Added magazine-style pull quote support, fixed gallery :columns attribute parsing, and resolved CSS backtick pseudo-element issues. Enabled single-row gallery layouts, typographically rich quotes with smart quotation marks, and clean inline code rendering across all themes.

** Goal
Enable new content types and fix rendering issues:
1. *Pull quotes* - Magazine-style large, centered quotes with decorative quotation marks for highlighting key insights
2. *Flexible gallery layouts* - Support custom column counts (especially single-row layouts for screenshot galleries)
3. *Clean inline code* - Remove unwanted backtick characters from rendered HTML

** Problems Discovered

*** Gallery Columns Not Working
The =:columns N= attribute in =#+BEGIN_GALLERY= blocks was being ignored during export. Users couldn't control the number of columns or create single-row layouts.

*Root Cause*: The gallery handler in =ox-astro-table-handlers.el= wasn't parsing the =:parameters= property from special blocks.

*** Pull Quote Content Not Processed as Markdown
Initial implementation wrapped content in =<div class="pullquote">= but MDX treated it as raw HTML, so:
- Straight quotes =" "= didn't convert to smart quotes =" "=
- Apostrophes ='= didn't convert to smart apostrophes ='=
- Markdown formatting =**bold**= wasn't rendered
- Spacing after colons was lost

*Root Cause*: MDX only processes markdown when there are blank lines separating HTML tags from content.

*** Pull Quotes Only in Claude Theme
Pull quotes were styled only for =.claude-theme-wrapper=, making them unavailable for posts using the default Tailwind prose theme.

*** CSS Backtick Pseudo-Elements on Inline Code
Literal backtick characters appeared around inline code elements (e.g., =`#focus`=) even though the HTML source was clean (=<code>#focus</code>=).

*Root Cause*: The Tailwind Typography plugin adds decorative backticks via =::before= and =::after= pseudo-elements on =code= tags by default, mimicking the appearance of Markdown source.

*** Pull Quote Format Support Limited
Only =#+BEGIN_PULLQUOTE= (special block) format was supported. Users couldn't use the more familiar =#+BEGIN_SRC pullquote= syntax.

*** Pullquote Content Whitespace Issues
When using =#+BEGIN_SRC pullquote= blocks, indented content from the org source was preserved in the MDX output, preventing MDX from processing it as markdown.

** Solutions Implemented

*** 1. Gallery Columns Parsing (ox-astro)
*File*: =ox-astro-table-handlers.el= lines 89-93

Added parameter parsing to extract =:columns N= from the special block's =:parameters= property:

#+begin_src emacs-lisp
;; Parse :columns attribute from #+BEGIN_GALLERY :columns N
;; Special blocks store parameters as a string like ":columns 12"
(params-string (org-element-property :parameters special-block))
(columns (when (and params-string (string-match ":columns +\\([0-9]+\\)" params-string))
           (string-to-number (match-string 1 params-string))))
#+end_src

Then pass it to the ImageGallery component when present (lines 158-159):

#+begin_src emacs-lisp
(when (and columns (> columns 0))
  (format "  columns={%d}\n" columns))
#+end_src

*Commit*: =e0af6b4= - Add support for :columns attribute in GALLERY blocks

*** 2. Pull Quote Block Handler (ox-astro)
*File*: =ox-astro-table-handlers.el= lines 164-168

Added PULLQUOTE special block handler that wraps content with blank lines for MDX processing:

#+begin_src emacs-lisp
;; Handle PULLQUOTE blocks
((string-equal block-type "PULLQUOTE")
 (concat "<div class=\"pullquote\">\n\n"
         contents
         "\n</div>\n"))
#+end_src

The double newlines after the opening =<div>= tag signal MDX to process the content as markdown, enabling:
- Smart quote conversion (=" "= → =" "=)
- Smart apostrophe conversion (='= → ='=)
- Bold/italic/formatting rendering
- Proper spacing preservation

*Commits*:
- =5a43ceb= - Add support for PULLQUOTE blocks
- =0933094= - Fix PULLQUOTE content to be processed as markdown in MDX

*** 3. Pull Quote CSS - Claude Theme
*File*: =apps/socratic/src/styles/claude-theme.css= lines 213-285

Magazine-style design with:
- Large italic serif text (1.75rem / 28px)
- Centered layout with top/bottom borders in Claude link color
- Smart curly quotation marks (Unicode =\201C= and =\201D=) at 6rem with 30% opacity
- =white-space: pre-line= to preserve line breaks
- Font feature settings for ligatures and contextual alternates
- Responsive: smaller text and quotes on mobile

*Commits*:
- =2b6441d= - Add magazine-style pull quote CSS
- =e52c1ce= - Use smart/curly quotation marks in pull quotes
- =f434635= - Fix pullquote spacing with white-space: pre-line

*** 4. Pull Quote CSS - Default Theme
*File*: =apps/socratic/src/layouts/MarkdownLayout.astro= lines 33-126

Added =<style is:global>= block with pull quote styling for =.prose= context:
- Georgia serif font matching Tailwind prose
- Blue borders (=#3b82f6=) matching the default link color
- Dark mode support with lighter blue (=#60a5fa=)
- Same smart quotes and responsive behavior as Claude theme

*Commit*: =a1586b2= - Add pullquote support to default theme

*** 5. Remove CSS Backtick Pseudo-Elements (Astro CSS)
*Files*:
- =apps/socratic/src/styles/claude-theme.css= lines 176-179
- =apps/socratic/src/layouts/MarkdownLayout.astro= lines 113-116
- =apps/socratic/src/styles/chatgpt-theme.css= lines 41-44

Override Tailwind Typography's default by setting =code::before= and =code::after= content to =none=:

#+begin_src css
.claude-theme-wrapper .prose code::before,
.claude-theme-wrapper .prose code::after {
  content: none !important;
}
#+end_src

Also added spacing between adjacent code elements:
#+begin_src css
.prose code + code {
  margin-left: 0.2em;
}
#+end_src

Plus inline code styling with padding and border-radius for better visual treatment.

*Commits*:
- =ad6ca44= - Style inline code in lists with Claude crail color
- =982db6e= - Add crail color to bold inline code in paragraphs
- =88e1de2= - Add typography features to pullquote styling
- =3a90c25= - Add complete styling to ChatGPT theme

*** 6. Support SRC Block Format for Pullquotes (ox-astro)
*File*: =ox-astro-helpers.el= lines 1190-1194

Added pullquote handling in =org-astro-src-block= function:

#+begin_src emacs-lisp
;; Handle pullquote blocks specially - wrap in div with blank lines
(if (string-equal lang "pullquote")
    (concat "<div class=\"pullquote\">\n\n"
            (org-trim code)
            "\n\n</div>\n")
#+end_src

Uses =org-trim= to remove both leading and trailing whitespace from content, ensuring clean MDX processing.

*Commits*:
- =61301b8= - Add pullquote support for SRC blocks
- =81ec410= - Fix pullquote SRC block whitespace handling

*** 7. Pull Quote CSS - ChatGPT Theme
*File*: =apps/socratic/src/styles/chatgpt-theme.css= lines 55-130

Restored full theme styling with magazine-style pullquotes:
- Tailwind blue color palette (=#2563eb=)
- Inter sans-serif for body text, Georgia serif for pullquotes
- Clean inline code with backtick removal
- Consistent with Claude theme structure but matching default Tailwind aesthetic

*Commit*: =3a90c25= - Add complete styling to ChatGPT theme

** Implementation Details

*** Smart Quote Strategy
Used CSS Unicode escapes for decorative quotation marks instead of literal characters:
- =\201C= - Left double quotation mark ="=
- =\201D= - Right double quotation mark ="=

This ensures consistent rendering across all fonts and eliminates encoding issues.

*** MDX Processing Trick
The key insight: MDX treats content differently based on surrounding whitespace:

#+begin_example
BAD (treated as raw HTML):
<div class="pullquote">
Content here
</div>

GOOD (processed as markdown):
<div class="pullquote">

Content here

</div>
#+end_example

The blank lines after opening tag and before closing tag signal "process this as markdown."

*** Gallery Columns Pattern
Users can now create single-row galleries by setting =:columns= equal to or greater than the image count:

#+begin_src org
#+BEGIN_GALLERY :columns 12
[[image1.png]]
[[image2.png]]
...
[[image12.png]]
#+END_GALLERY
#+end_src

For 12 images with =:columns 12=, desktop shows all in one row; mobile still uses 2 columns for readability.

** User Impact

*** Pull Quotes
*Usage* (two equivalent formats):
#+begin_src org
#+BEGIN_PULLQUOTE
Your important quote text here.
#+END_PULLQUOTE
#+end_src

Or:
#+begin_src org
#+BEGIN_SRC pullquote
Your important quote text here.
#+END_SRC
#+end_src

*Benefits*:
- Magazine-quality typography with smart quotes
- Automatic markdown processing (bold, italic, etc.)
- Works in Claude theme, ChatGPT theme, and default theme
- No manual quote mark insertion needed
- Responsive design for mobile
- Both special block and source block syntax supported

*** Gallery Columns
*Usage*:
#+begin_src org
#+BEGIN_GALLERY :columns 12
[[screenshot1.png]]
[[screenshot2.png]]
#+END_GALLERY
#+end_src

*Benefits*:
- Create single-row screenshot galleries
- Control layout precisely (2, 3, 4, or more columns)
- Responsive: auto-adjusts to 2 columns on mobile
- PhotoSwipe lightbox for full-size viewing

*** Inline Code Rendering
*Usage*: Standard markdown inline code (backticks in org converted to =<code>= tags)

*Benefits*:
- Clean rendering without decorative backticks
- Consistent across all themes (Claude, ChatGPT, default)
- Special color treatment for code in lists and bold contexts
- Better spacing between adjacent code elements

** Documentation
Updated =instructions.org= in astro-monorepo with:
- Complete pull quote usage guide with both syntax formats
- Visual style documentation
- When to use pull quotes (best practices)
- Gallery columns reference with real-world examples
- Troubleshooting for both features

** Testing
Manual verification:
- Exported goal tracking system post with 12-image gallery in single row
- Created pull quote examples in all three themes (Claude, ChatGPT, default)
- Verified smart quotes render correctly
- Confirmed markdown processing (bold, spacing) works
- Tested responsive behavior on mobile viewport
- Verified inline code renders without backticks in all themes
- Tested both =#+BEGIN_PULLQUOTE= and =#+BEGIN_SRC pullquote= formats

** Files Modified

*** ox-astro
- =ox-astro-table-handlers.el= - Gallery columns parsing + PULLQUOTE handler
- =ox-astro-helpers.el= - SRC block pullquote support with whitespace handling
- =work-log.org= - This entry

*** astro-monorepo
- =apps/socratic/src/styles/claude-theme.css= - Pull quote styling + code backtick removal
- =apps/socratic/src/styles/chatgpt-theme.css= - Full theme restoration with pullquotes + code styling
- =apps/socratic/src/layouts/MarkdownLayout.astro= - Default theme pull quotes + code styling
- =apps/socratic/src/content/blog/claude-designs-a-goal-tracking-system.mdx= - Gallery example
- =instructions.org= - Comprehensive documentation

*** emacs-settings
- =shared-functions.org= - Added =jay/reload-ox-astro= function for hot-reloading

** Status
✅ *COMPLETE* - All features implemented, tested, and documented across all themes.

** Lessons Learned

*** MDX Content Processing Rules
Understanding when MDX processes content as markdown vs. raw HTML is crucial. The blank line pattern (=<tag>\n\nContent\n</tag>=) is the key signal.

*** Special Block Parameters
Org special blocks store parameters as a single string in the =:parameters= property, not as a plist. Pattern matching with regex is the reliable extraction method.

*** CSS Pseudo-Element Debugging
When rendered output shows characters not present in HTML source, investigate CSS =::before= and =::after= pseudo-elements. The Tailwind Typography plugin adds decorative elements by default that may need overriding.

*** Whitespace Handling in SRC Blocks
Use =org-trim= instead of =string-trim-right= to remove both leading and trailing whitespace from source block content before wrapping in HTML tags.

*** Typography Matters
Smart quotes, proper spacing, and font features (ligatures, contextual alternates) elevate pull quotes from "styled text" to magazine-quality typography.

*** Theme Portability
Implementing the same feature for both Claude theme and default theme ensures all blog posts can use the feature, not just themed ones.

* 2025-10-28 Tuesday - Hero Image Dedup + Import Hygiene

** Summary
Eliminated duplicate hero renders in MDX exports and straightened the surrounding import bookkeeping after re-running the blueberry scone post through the converter.

** Changes
- Propagated the hero image path into render-map generation so the matched record carries a `:hero` flag (`ox-astro-image-handlers.el`) and taught `org-astro--image-component-for-record` to skip only the first inline hero instance (`ox-astro-helpers.el`).
- Added a front-matter fallback for `:astro-hero-image`, rebuilt the render map during the body filter, and removed unused imports only when the hero variable truly drops out of the body (`ox-astro-handlers.el`).
- Relaxed the image pipeline test to accept regenerated imports while still asserting seven `<Image />` usages and key alt text (`test-image-rendering.el`).

** Impact
- Posts keep the hero image confined to the layout slot while preserving subsequent inline references and avoiding stale imports.
- Export runs leave MDX bodies with consistent JSX and import blocks, preventing build failures from stray `Image` imports.
- Regression coverage continues to exercise the full image pipeline with the updated assertions.

** Verification
- `emacs --batch --eval "(setq load-path (cons \"~/Library/CloudStorage/Dropbox/github/ox-astro\" load-path))" --eval "(require 'ert)" --eval "(load \"~/Library/CloudStorage/Dropbox/github/ox-astro/ox-astro-config.el\")" --eval "(load \"~/Library/CloudStorage/Dropbox/github/ox-astro/ox-astro-helpers.el\")" --eval "(load \"~/Library/CloudStorage/Dropbox/github/ox-astro/ox-astro-image-handlers.el\")" --eval "(load \"~/Library/CloudStorage/Dropbox/github/ox-astro/ox-astro-handlers.el\")" --eval "(load \"~/Library/CloudStorage/Dropbox/github/ox-astro/ox-astro.el\")" --eval "(load \"~/Library/CloudStorage/Dropbox/github/ox-astro/test-image-rendering.el\")" --eval "(ert-run-tests-batch-and-exit)"'

* 2025-10-20 Monday - Manifest Closure + Compatibility Shim

** Summary
Restored manifest collection after the register-entry refactor and ensured exports run on Emacs builds that lack native `cl-putf`.

** Changes
- Routed every manifest callback through a captured `register-entry` function so `org-element-map` invocations no longer raise `void-function` errors.
- Added a guarded `cl-putf` implementation in `ox-astro-helpers.el` for older Emacs installations.

** Impact
- Image manifests are stable again, even when callbacks execute outside the original lexical scope.
- Export pipeline now succeeds on legacy Emacs releases, unblocking gallery exports that previously failed during plist updates.

* 2025-10-20 Monday - Shared ImageGallery Import

** Summary
Switched gallery exports to import `ImageGallery` from the shared `@jaydixit/astro-utils` package and verified the gallery test org file exports cleanly.

** Changes
- Updated `ox-astro-handlers.el` to emit the package import instead of a relative path.
- Exported `20250828203848-gallery_test_rigorous.org` to confirm the component resolves via the shared package.

** Impact
- All future MDX exports consume the single shared ImageGallery implementation, eliminating the prior build failure caused by app-relative imports.
- Gallery diagnostics confirm each image import matches the generated manifest entries.

* 2025-10-20 Monday - Gallery Export Regression Test

** Summary
Captured the rigorous gallery org file as a fixture and wired an automated ERT around the exporter.

** Changes
- Added `test/gallery_test_rigorous.org` and the expected MDX snapshot used for diffing.
- Implemented `test/image-pipeline-test.el` to export a temporary copy, normalize volatile tokens, and assert six `<ImageGallery>` blocks plus two standalone `<Image />` components.
- Verified the suite passes via `emacs --batch -Q --eval "(add-to-list 'load-path \".\" t)" -l ert -l test/image-pipeline-test.el -f ert-run-tests-batch-and-exit`.

** Impact
- Provides end-to-end regression coverage for gallery detection, imports, and rendering so future changes surface immediately.
- Keeps the test self-contained by isolating exports in temporary projects and cleaning up after itself.

* 2025-10-20 Monday - Stage 3: Render Map + Hero Cleanup

** Summary
Completed the exporter refactor by precomputing render data, simplifying transcoders to read from that map, and deleting all hero-suppression branches.

** Changes
- Built a render map (`org-astro--build-render-map`) that packages imports and JSX snippets for each processed image and stored it via `:astro-render-map`/`:astro-render-imports`.
- Simplified `org-astro-prepare-images-filter`, `org-astro-body-filter`, and the MDX transcoders (`org-astro-link`, `org-astro-paragraph`, `org-astro-plain-text`, final output filter) to look up render records instead of reconstructing data or skipping the first image.
- Removed hero-specific imports/filters so every image is emitted uniformly; layout code can now decide how to present hero media.
- Added `test-files/image-rendering/` fixtures and `test-image-rendering.el` to assert imports, JSX output, and alt text for local, spaced, underscored, repeated, and remote images.
- Reintroduced the manifest helper as a `cl-labels` local function (`register-entry`) so all `org-element-map` callbacks share the same scope and gallery exports stay stable.

** Impact
- Rendering is now deterministic: every phase reads the same precomputed JSX, eliminating duplicated logic and hero-based conditionals.
- Imports are generated once from the render map, preventing drift between filters and body generation.
- The exporter exports all images verbatim, relying on downstream layout for hero presentation as intended.

** Next Steps
- Monitor layout consumers for styling adjustments now that hero suppression is gone.
- Consider adding regression fixtures that assert multiple render-map lookups (links, raw paths, markdown images) produce consistent output.

* 2025-10-20 Monday - Stage 2: Image Materialization Drivers

** Summary
Hooked the manifest into a dedicated processing pipeline that materializes images, rewrites source paths via targeted helpers, and threads the resulting state through a reusable export context.

** Changes
- Added `org-astro--materialize-image` and `org-astro--process-image-manifest` to split filesystem work from buffer rewrites and return structured results for downstream consumers.
- Updated `org-astro-export-to-mdx` to build the manifest, invoke the new driver, refresh the export environment after rewrites, and cache the context on `info` for subsequent phases.
- Rewrote `org-astro-prepare-images-filter` to reuse the cached context (or lazily build one) instead of re-scanning the buffer, ensuring filters operate on the same processed data without global state churn.

** Impact
- File copying, remote downloads, and org-buffer rewrites now live in focused helpers, eliminating the previous mix of responsibilities inside the export filter.
- The export context (`:astro-export-context`) carries manifest and processed entries forward, so later stages no longer rely on duplicative scans or the global fallback.
- Buffer updates occur exactly once during preflight; subsequent export passes simply consume the processed data, keeping the pipeline deterministic.

** Next Steps
- Stage 3: Generate a render map (imports + JSX snippets) from the processed entries, have transcoders fetch precomputed JSX, and remove hero-image suppression from the exporter.

* 2025-10-20 Monday - Stage 1: Image Manifest Collector & Context Seeds

** Summary
Implemented the first stage of the refactor plan by introducing a single-pass image manifest that centralizes discovery, records metadata, and seeds an explicit export context.

** Changes
- Added `org-astro--build-image-manifest` in `ox-astro-image-handlers.el` to capture every image reference (links, raw paths, paragraph repairs, buffer scans) as structured entries with occurrence metadata.
- Updated `ox-astro.el` and `ox-astro-handlers.el` preflight/filter logic to consume the manifest, cache it on the export `info` plist, and derive path lists from the manifest rather than re-scanning via ad-hoc helpers.
- Adjusted `org-astro--collect-images-from-tree` to delegate to the manifest builder, keeping existing callers working while ensuring all discovery flows through the new collector.

** Impact
- Image detection now runs through a single code path, ensuring preflight and export filters share the same discovery logic and metadata.
- The manifest (including occurrence descriptors) is stored on `info`, laying the groundwork for a threaded export context that will replace the current dual global/plist storage.
- Preflight and filter runs no longer juggle separate tree vs. raw scans, reducing divergent behaviour and simplifying future refactors.

** Next Steps
- Stage 2: Use the manifest to drive filesystem copying and buffer rewrites via dedicated helpers that emit canonical asset paths without mixing concerns.
- Stage 3: Replace importer/transcoder reliance on globals with manifest-derived JSX data and drop hero-image suppression from the exporter once layout handling is ready.

* 2025-01-06 Monday - Align Front Matter with Astro 5 IDs

** Summary
Astro 5 now derives `slug` internally from each file path, so the exporter should stop emitting a redundant `slug` field in MDX front matter while still preserving slugs for filenames and asset folders.

** Changes
- Removed the `slug` entry from the data returned by `org-astro--get-front-matter-data`.
- Updated `test-slug-generation.org` to document that front matter no longer includes `slug` even though filenames still do.
- Added a change-log entry noting the new front matter contract.

** Impact
- Exported MDX files match the streamlined schema consumed by `roam-life-web`.
- `astro check` passes without `slug` validation errors, while slug-dependent image and PDF handling continues to work.

** Follow-ups
- Run a batch export of representative notes to ensure no consumers depend on `slug` being present in YAML.
- Consider adding an automated assertion within `test-export.el` for front matter keys.

* 2025-01-06 Monday - Restore Hero Images in Exported Content

** Summary
The image exporter was skipping the first entry entirely to avoid duplicate hero output, which also removed the image from the generated `# Images` section in the MDX. Dropped the suppression branch so hero assets render wherever the Org file references them.

** Impact
- All inline `[[file:...]]` references now render `<Image />` components, including the first occurrence.
- `# Images` sections once again list every linked image.

** Follow-ups
- If duplicate hero output becomes distracting, consider handling it in the Astro layout instead (e.g., hide the first `<Image />` via CSS when the hero front matter is present).

* 2025-01-06 Monday - Image Pipeline Deep Dive

** Summary
Reviewed the current image-export pipeline (preflight collection, asset copying, buffer mutations, rendering) to surface maintenance pain points and outline simplification ideas.

** Findings
- Image discovery happens three different ways (tree traversal, raw buffer scan, paragraph repair), each mutating shared globals. This redundancy keeps behavior robust but makes the flow hard to follow and reason about.
- Two mutable stores (`info :astro-body-images-imports` and `org-astro--current-body-images-imports`) try to keep the same data in sync. When they drift, downstream code falls back to guesses.
- “Hero image suppression” leaked into multiple layers (link transcode, paragraph repair) causing special-case branches and state flags.
- The asset-copy helpers mix responsibilities: they rewrite paths in-place, manage filesystem copies, and emit final MDX imports all in one pass.

** Opportunities
- Centralize image discovery into a single collector that returns structured entries (source, target, metadata) and reuse it across later phases.
- Replace global state with an explicit context object threaded through export steps, so each phase reads/writes predictable fields.
- Separate concerns: one module copies/updates assets, another maps discovered images to MDX `import` entries, and the renderer only formats JSX.
- Defer hero-specific behavior to the layout layer (or a post-processing step) instead of branching inside the exporter.

** Next Steps
- Prototype a refactored collector/context on a branch and run regression exports against representative notes.
- Add focused tests for the new collector to ensure raw-path edge cases remain covered.

** Implementation Plan
1. Prototype a unified image collector that returns structured results and stores them in an explicit export context. Run regression exports against representative notes.
2. Split asset copying, buffer rewriting, and MDX import emission into focused helpers that consume the shared context.
3. Remove hero-specific branching from the exporter and handle duplicate hero presentation inside the Astro layout instead.
4. Add targeted fixtures and tests that exercise raw-path edge cases to guard the refactored pipeline.
** Handoff
- Pick up the unified collector/context prototype (Step 1 of implementation plan).
- Validate layout-side hero handling to ensure we don't reintroduce suppression logic in the exporter.
* 2025-10-24 Friday - Enrich org-roam Metadata Export

** Summary
Taught the exporter to surface the full set of org-roam enrichment fields (date occurred, era, place, people, emotions, places, themes, story type) so downstream sites like roam-life-web can drive richer navigation and search experiences.

** Changes
- Added `ox-astro-metadata.el` helpers for parsing/normalizing list-style keywords (handles quoted tokens, optional `ASTRO_` prefixes, and story type validation).
- Registered the new keywords in `ox-astro.el` and wired `org-astro--get-front-matter-data` to emit `dateOccurred`, `era`, `place`, `people`, `emotions`, `places`, `themes`, and `storyType` when present.
- Updated the change log with guidance for validating org frontmatter slugs and array fields.
- Rebuilt `org-astro--split-quoted-list` as a small state machine to avoid parenthesis mismatches and correctly tokenize quoted/whitespace-separated values.

** Impact
- MDX frontmatter now mirrors the enriched schema expected by `roam-life-web/src/content/config.ts`.
- Arrays such as `people`/`emotions` are always emitted as trimmed lists, preventing schema validation errors.
- Authors can keep using either `#+field` or `#+ASTRO_field` conventions without breaking exports.

** Follow-ups
- Run a regression export on representative stories and characters to confirm real data covers the new fields.
- Consider adding ERT fixtures that exercise the parser against the sample org files mentioned in the exporter guide.

** Handoff for Next Session
- Please run exports for the sample notes to catch any lingering schema issues, especially around `place` vs `places`.
- If time permits, add an ERT fixture covering `org-astro--split-quoted-list` with mixed quoted tokens.
- Review `docs/instructions.org` metadata section for clarity; expand with screenshots if users stumble.

* 2025-10-17 Thursday - Org Headings Breaking User Blocks

** Summary
Fixed a critical parsing issue where org-mode heading syntax (`***`, `****`) inside user/prompt/quote src blocks was breaking the block structure during export, resulting in malformed MDX output.

** Problem Discovery

*** Symptom
MDX blog post [[/Users/jay/Library/CloudStorage/Dropbox/github/astro-monorepo/apps/socratic/src/content/blog/wherein-chatgpt-helps-me-launch-this-substack.mdx][wherein-chatgpt-helps-me-launch-this-substack.mdx]] had content breaking out of styled "user" bubbles. Instead of rendering inside the CSS-styled code block, markdown headings and lists were rendering as page-level elements.

*** Root Cause
The exported MDX contained `\#+begin_src_ user` (escaped/literal text) instead of proper triple backticks. This happened because the org-mode source file [[/Users/jay/Library/CloudStorage/Dropbox/roam/socratic/20250825182342-wherein_chatgpt_helps_me_launch_this_substack.org][20250825182342-wherein_chatgpt_helps_me_launch_this_substack.org]] had org heading syntax inside the src blocks:

#+begin_example
#+begin_src user
OK here are my thoughts...

*** 1. Clarify your audience

#### Who do you want reading this?
#+end_src
#+end_example

Org-mode's parser was interpreting the `***` at line start as actual org headlines, which *broke the src block structure before export even began*.

** Approach to Solution

*** First Attempt: Export-Time Conversion
*Strategy*: Modify `org-astro-src-block` function to convert org headings to markdown during export.

*Implementation*: Added regex replacements in [[/Users/jay/Library/CloudStorage/Dropbox/github/ox-astro/ox-astro-helpers.el][ox-astro-helpers.el]] lines 726-750:

#+begin_src emacs-lisp
(defun org-astro-src-block (src-block contents info)
  "Transcode a SRC-BLOCK element into fenced Markdown format.
For 'user', 'prompt', and 'quote' blocks, preserve org-mode syntax
literally - convert org headings to markdown equivalents."
  (if (not (org-export-read-attribute :attr_md src-block :textarea))
      (let* ((lang (org-element-property :language src-block))
             (code (org-element-property :value src-block)))
        ;; For user/prompt/quote blocks, convert org-mode syntax to markdown
        (when (member lang '("user" "prompt" "quote"))
          ;; Convert org headings to markdown headings
          (setq code (replace-regexp-in-string "^\\*\\*\\*\\* \\(.*\\)$" "#### \\1" code))
          (setq code (replace-regexp-in-string "^\\*\\*\\* \\(.*\\)$" "### \\1" code))
          (setq code (replace-regexp-in-string "^\\*\\* \\(.*\\)$" "## \\1" code))
          (setq code (replace-regexp-in-string "^\\* \\(.*\\)$" "# \\1" code)))
        (setq code (string-trim-right code))
        (format "```%s\n%s\n```" (or lang "") code))
#+end_src

*Problem*: This approach was **too late** - the src block had already been broken during parsing, so there was no intact block structure to process.

*Result*: Still produced malformed output with `\#+begin_src_ user`

*** Second Attempt: Pre-Processing Before Parse
*Strategy*: Run transformation BEFORE org-mode's parser processes the buffer, converting asterisks to markdown heading syntax.

*Why This Works*: Org-mode's parser is what interprets asterisks at line start as headlines. By converting them to markdown syntax (`###`) before parsing, we prevent the parser from seeing them as org elements.

** Final Solution: Automatic Normalization

*** Implementation Architecture

**** 1. Created Normalization Function
Added `org-astro--normalize-user-blocks` in [[/Users/jay/Library/CloudStorage/Dropbox/github/ox-astro/ox-astro-helpers.el][ox-astro-helpers.el]] lines 247-282:

#+begin_src emacs-lisp
(defun org-astro--normalize-user-blocks ()
  "Convert org headings to markdown inside user/prompt/quote blocks.
This prevents org-mode from interpreting asterisks as headings inside
these special blocks, which would break the block structure."
  (save-excursion
    (goto-char (point-min))
    (let ((modified nil))
      (while (re-search-forward "^#\\+begin_src \\(user\\|prompt\\|quote\\)" nil t)
        (let ((block-start (point))
              (block-end (save-excursion
                          (when (re-search-forward "^#\\+end_src" nil t)
                            (match-beginning 0)))))
          (when block-end
            (save-restriction
              (narrow-to-region block-start block-end)
              (goto-char (point-min))
              ;; Convert org headings to markdown (must go from most to least asterisks)
              (while (re-search-forward "^\\(\\*\\*\\*\\*\\) \\(.*\\)$" nil t)
                (replace-match "#### \\2")
                (setq modified t))
              (goto-char (point-min))
              (while (re-search-forward "^\\(\\*\\*\\*\\) \\(.*\\)$" nil t)
                (replace-match "### \\2")
                (setq modified t))
              (goto-char (point-min))
              (while (re-search-forward "^\\(\\*\\*\\) \\(.*\\)$" nil t)
                (replace-match "## \\2")
                (setq modified t))
              (goto-char (point-min))
              (while (re-search-forward "^\\(\\*\\) \\(.*\\)$" nil t)
                (replace-match "# \\2")
                (setq modified t)))
            (goto-char block-end))))
      (when modified
        (message "[ox-astro] Auto-converted org headings to markdown in user/prompt/quote blocks")))))
#+end_src

*Key Design Decisions*:
- Uses `save-excursion` to preserve cursor position
- Processes from most to least asterisks to avoid double-conversion
- Uses `narrow-to-region` to limit replacements to within each block
- Provides user feedback when conversions are made
- Non-destructive to the original buffer (unless export proceeds)

**** 2. Integrated Into Export Workflow
Modified [[/Users/jay/Library/CloudStorage/Dropbox/github/ox-astro/ox-astro.el][ox-astro.el]] line 94 to call normalization BEFORE parsing:

#+begin_src emacs-lisp
;; Clear any stale image import state before running export filters.
(setq org-astro--current-body-images-imports nil)
;; --- AUTO-NORMALIZE: Convert org headings to markdown in user/prompt/quote blocks ---
;; This must run BEFORE org-mode parses the buffer, otherwise asterisks at start
;; of lines inside src blocks will be interpreted as org headlines and break the block.
(org-astro--normalize-user-blocks)
;; --- PREPROCESSING: Process and update all image paths BEFORE export ---
(let* ((tree (org-element-parse-buffer))
#+end_src

*Critical Timing*: This runs **before** `org-element-parse-buffer`, which is when org-mode's parser would normally interpret the asterisks as headlines.

*** Manual Fix Applied
Also manually fixed the source org file [[/Users/jay/Library/CloudStorage/Dropbox/roam/socratic/20250825182342-wherein_chatgpt_helps_me_launch_this_substack.org][20250825182342-wherein_chatgpt_helps_me_launch_this_substack.org]] at lines 187-213 to demonstrate proper format:

#+begin_example
#+begin_src user
OK here are my thoughts on your questions from above. I'll run them by you one at a time.

### 1. Clarify your audience

Before you write anything, ask:

#### Who do you want reading this? Professors? Writers? Students? AI-curious professionals?
#+end_src
#+end_example

** Technical Insights

*** Org Export Pipeline Order
Understanding the correct order of operations was crucial:

1. *Pre-processing* (custom code before parsing) ← Our normalization runs here
2. *Parsing* (`org-element-parse-buffer`) ← Where asterisks would be interpreted
3. *Parse-tree filters* (modify AST)
4. *Transcoding* (convert elements to output format)
5. *Body filters* (modify body string)
6. *Final filters* (modify complete output)

*** Why Export-Time Processing Failed
By the time `org-astro-src-block` was called to transcode the element, org-mode had already:
- Parsed the asterisks as headlines
- Broken the src block structure
- Created malformed AST nodes

The transcoder received an already-broken structure, so it couldn't fix it.

*** Why Pre-Processing Works
By running before the parser:
- We transform the raw buffer text
- Org-mode parser sees markdown syntax (`###`) not org syntax (`***`)
- Src block structure remains intact through parsing
- Export proceeds normally with well-formed blocks

*** Conversion Order Matters
Must process from most to least asterisks:
- `****` → `####` (first)
- `***` → `###`
- `**` → `##`
- `*` → `#` (last)

Otherwise `****` would become `###*` after the first pass.

** Prevention Strategy

*** User Experience
The automatic normalization provides:
1. **Zero friction**: Users don't need to remember special syntax
2. **Automatic correction**: Problematic syntax is fixed on every export
3. **User notification**: Message confirms when conversions are made
4. **No manual intervention**: Works transparently in the background

*** Alternative Options Considered
1. ✅ *Automatic pre-processing* (implemented) - Best UX
2. ⚠️ *Export-time warning* - Requires user action
3. ⚠️ *Documentation* - Relies on user memory

Chose Option 1 for optimal user experience and reliability.

** Files Modified

*** [[/Users/jay/Library/CloudStorage/Dropbox/github/ox-astro/ox-astro-helpers.el][ox-astro-helpers.el]]
- Lines 247-282: Added `org-astro--normalize-user-blocks` function
- Lines 726-750: Updated `org-astro-src-block` with heading conversion (this became redundant but kept as defense in depth)

*** [[/Users/jay/Library/CloudStorage/Dropbox/github/ox-astro/ox-astro.el][ox-astro.el]]
- Line 94: Integrated normalization call before parsing

*** [[/Users/jay/Library/CloudStorage/Dropbox/roam/socratic/20250825182342-wherein_chatgpt_helps_me_launch_this_substack.org][Source org file]]
- Lines 187-213: Manually fixed as demonstration of proper format

** User Impact

*** Immediate Benefits
- Blog post now renders correctly with content staying inside styled bubbles
- No more escaped literal text in MDX output
- Proper triple-backtick code fences generated

*** Long-Term Benefits
- Users can freely use conversational markdown syntax inside user blocks
- No need to remember special escaping rules
- Automatic handling prevents future issues
- Works for all three block types: user, prompt, quote

** Lessons Learned

*** 1. Pre-Processing vs Post-Processing
When working with structured parsers like org-mode:
- Some problems must be solved BEFORE parsing
- Post-processing (during export) can be too late
- Understanding the pipeline order is critical

*** 2. Defensive Programming Layers
Multiple intervention points provide robustness:
- Pre-processing catches the issue early (primary defense)
- Export-time conversion provides backup (defense in depth)
- Both together ensure reliable output

### 3. User Experience Design
Best solutions:
- Work automatically without user intervention
- Provide feedback when taking action
- Don't require users to memorize special rules
- Fix problems at the source, not with workarounds

*** 4. Testing with Real Content
The problem was discovered in a real blog post with complex conversational content, not in simplified test cases. Real-world content reveals edge cases that simple tests miss.

** Status
✅ **RESOLVED** - Automatic normalization implemented and integrated. Future exports will handle this automatically.

* Session Handoff
- Completed: Stage 3 render-map refactor; manifest helper fixed via `cl-labels` closure
- Next: Check downstream hero layout behavior; run `emacs --batch -Q -L . -l test-image-rendering.el` after image changes
- Context: Core files touched — `ox-astro-image-handlers.el`, `ox-astro-helpers.el`, `ox-astro-handlers.el`; test fixtures in `test-files/image-rendering/`

* 2025-11-23
** Session Summary
- Reinstated date-only title handling: date-like `#+TITLE`/filename now swap to the first heading for title/slug/outfile while respecting later non-date titles.
- Restored narrowed-buffer exports: if the buffer is narrowed, export treats it as a subtree in both passes.
- Added regression tests for date-title replacement, date-filename fallback, and narrowed subtree export.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Date-only title guard implemented across title/slug/outfile: `ox-astro-helpers.el`, `ox-astro.el`
- [x] Narrowed-buffer subtree export honored on both passes: `ox-astro.el`
- [x] Regression tests added: `test/date-title-and-subtree-test.el`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `ox-astro.el`, `test/date-title-and-subtree-test.el`
- Known unknowns: None
- Recommendations: Re-export date-named journal files; spot-check front matter in Astro output for expected titles/slugs.
