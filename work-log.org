* 2025-12-26 - GIF handling: copy to public folder, bypass Sharp optimization

** Summary
GIFs now bypass Astro's Sharp image optimization by copying to ~public/~ folder
instead of ~src/assets/~. This fixes Vercel build failures caused by Sharp's
65500 pixel dimension limit on animated GIFs.

** Problem
Animated GIFs caused Vercel build failures:
#+begin_example
VipsJpeg: Maximum supported image dimension is 65500 pixels
#+end_example
Sharp tries to process all frames of animated GIFs, exceeding dimension limits.

** Solution
1. Detect GIF files via ~org-astro--gif-p~
2. Copy GIFs to ~public/images/posts/<slug>/~ instead of ~src/assets/~
3. Generate markdown syntax ~![alt](/images/...)~ instead of ~<Image>~ component
4. Set ~:rewrite-path nil~ to prevent org file path rewriting
5. Add ~gif~ to image extension patterns throughout
6. Detect GIFs already in ~public/~ folder - extract web path without copying

** Files Modified
- ~ox-astro-image-handlers.el~:
  - Added ~org-astro--gif-p~ predicate (line 48)
  - Added ~org-astro--get-public-folder~ helper (line 596)
  - Added condition for GIFs already in ~public/images/~ (lines 251-263)
  - Modified ~org-astro--materialize-image~ for GIF handling
  - Set ~:rewrite-path nil~ for local GIFs
  - Set ~:rewrite-path nil~ for downloaded remote GIFs
  - Modified ~org-astro--build-render-map~ to generate markdown for public images
  - Modified ~org-astro--process-image-path~ to handle GIF cover images

- ~ox-astro-helpers.el~:
  - Added ~gif~ to image detection regex in ~org-astro-link~ (lines 1729-1730)
  - Modified ~org-astro--get-cover-image~ to prefer ~:public-path~ for fallback

- ~ox-astro-handlers.el~:
  - Added ~gif~ to markdown image pattern in ~org-astro-final-output-filter~ (line 623)

** Also Fixed: Theme/Model Banner Issues
- Document-level ~#+MODEL:~ now emits banner for first section
- Duplicate theme markers eliminated
- First section gets inline theme marker for multi-AI posts

** Impact
- GIFs served as static assets without optimization
- No more Vercel build failures from animated GIFs
- GIFs already in public/ detected and web path extracted
- Hero image selection works with GIF fallback

* 2025-12-04 - Inline THEME hoist + regression tests

** Summary
- Hoist inline `#+THEME:` markers that appear immediately after a heading so the theme marker is emitted before the heading in MDX.
- Skip consumed THEME keywords to avoid duplicate markers when hoisted.
- Added regression coverage for misordered inline themes and adjusted existing title expectation tests for quoted frontmatter values.

** Changes
- `ox-astro-helpers.el`: `org-astro-heading` hoists following THEME keyword via `org-astro--theme-prefix-for-heading`, strips the original from contents to prevent duplication.
- `ox-astro-handlers.el`: `org-astro-keyword` ignores keywords marked `:astro-consumed`.
- `test/theme-reorder-test.el`: new tests for misordered inline THEME and document-level theme behavior.
- `test/date-title-and-subtree-test.el`: updated assertions to match quoted frontmatter titles.

** Impact
- Inline theme sections render correctly even when authors place `#+THEME:` after the heading; headings stay inside themed wrappers without double markers.
- Tests lock the behavior to prevent regressions in marker ordering and title formatting.

** Tests
- `emacs -Q --batch -L . -l test/theme-reorder-test.el -f ert-run-tests-batch-and-exit`

* 2025-12-03 - Remote image URL replacement in source files

** Summary
Fixed remote image URLs not being replaced in org source files after download. Remote images are now downloaded to assets AND the source .org file is automatically updated to point to the local path, matching the behavior for local images.

** Problem
Remote URLs like ~[[https://example.com/image.jpg]]~ were:
- Successfully downloaded to assets folder
- Generated correct imports in MDX
- BUT remained as remote URLs in the source .org file

Root cause: Org-mode parses ~[[https://example.com/img.jpg]]~ as type="https" and path="//example.com/img.jpg" (stripping the protocol prefix), so buffer search for the URL failed.

** Solution
1. Added remote URL link pattern matching in ~org-astro--update-image-path-in-buffer~ to handle ~[[https://...]]~, ~[[http://...]]~, and ~[[//...]]~ patterns
2. Reconstruct full URL from org link type + path when searching buffer:
   - Manifest stores path as parsed by org: ~"//example.com/..."~
   - Extract link-type from occurrences: ~"https"~
   - Reconstruct for search: ~"https:" + "//example.com/..."~ = ~"https://example.com/..."~
3. Use reconstructed URL to find and replace in source buffer

** Files Modified
- ~ox-astro-image-handlers.el~:
  - Added remote URL pattern matching in ~org-astro--update-image-path-in-buffer~ (lines 394-404)
  - Added URL reconstruction logic in ~org-astro--process-image-manifest~ (lines 367-377)
  - Extracts link-type from manifest occurrences to rebuild full URL for buffer search

** Verification
Tested with ~https://img.youtube.com/vi/.../maxresdefault.jpg~ - successfully downloaded and source file updated to local path.

** Impact
Remote images now have identical behavior to local images - automatic download and source file rewriting.

* 2025-11-30 - Audio file support for media imports

** Summary
Added support for audio files (.mp3, .wav, .ogg, .m4a, .aac, .flac) alongside images.
Audio files are now:
- Detected in org links and plain text
- Copied to assets folder
- Import statements generated
- But NO <Image> JSX generated (audio imports are for manual use with custom components)
- Audio links stripped from MDX body (only import kept)

** Usage in org files
Add audio file path as a link:
#+begin_example
[[/path/to/audio.mp3]]
#+end_example

The export will generate:
#+begin_example
import audioFile from '~/assets/images/posts/slug/audio.mp3';
#+end_example

Then manually use with AudioPlayer component in MDX.

** Files Modified
- `ox-astro-image-handlers.el`:
  - Added `org-astro--audio-extension-regexp` and `org-astro--media-extension-regexp`
  - Added `org-astro--audio-path-matches-p` and `org-astro--media-path-matches-p` helpers
  - Updated `org-astro--build-image-manifest` to use media matcher (images + audio)
  - Updated `org-astro--build-render-map` to skip JSX generation for audio files
  - Audio entries marked with `:audio t` for downstream identification
- `ox-astro-helpers.el`:
  - Added audio file clause to `org-astro-link` to return empty string
  - Prevents audio links from appearing as `<file:///...>` in MDX body

** Impact
- Audio files now get copied and imported automatically
- No breaking changes to existing image handling
- Manual component usage gives full control over audio player styling
- Audio links cleanly removed from body (only import statement generated)

* 2025-12-02 - MDX caption escaping & media import hardening

** Summary
- Escape caption attributes with HTML entities to prevent MDX parse errors from backslash escapes in data-pswp-* attributes.
- Handle same-file media paths (assets already in destination) without failing copies; still generate imports for audio/images.
- Removed image prompts from `20251130134152-richard_ii.org` per request.

** Files
- `ox-astro-helpers.el`: attribute escaping now encodes &, <, >, and ".
- `ox-astro-image-handlers.el`: treat source/target-equal media as existing and still emit imports.
- `ox-astro-handlers.el`: rebuild render imports if missing to keep audio imports.
- `ox-astro.el`: defensive `org-astro-date-format` default.
- `20251130134152-richard_ii.org`: cleared `#+IMAGE-PROMPT` lines; kept credits.

** Impact
- MDX exports no longer error on backslash-escaped captions.
- Audio imports persist even when assets already live in destination.
- Prompts removed from the referenced org file.

* 2025-11-30 - Image credits/captions polish and reliability

** Summary
- Remove baked-in "Image:" labels; authors supply their own prefixes (e.g., "Generated With:").
- Use real image dimensions for PhotoSwipe links when available; omit attrs when unknown.
- Avoid credit/caption collisions by keying metadata on normalized relative paths (source root/source file), not just filenames.
- More reliable IMAGE-* association: scan forward from each image paragraph, skipping blanks, to pick up following IMAGE-CREDIT/CAPTION/PROMPT keywords.

* 2025-12-06 - Default TOC off for Astro exports

** Summary
- Disabled auto Table of Contents during Astro exports so MDX bodies no longer get an injected TOC unless explicitly requested in the Org source.

** Change
- `ox-astro.el`: bind `org-export-with-toc` to nil inside `org-astro-export-as-mdx` and `org-astro-export-to-mdx`. Authors can still enable a TOC via Org keywords if desired.

* 2025-12-06 - Preserve collapsible metadata on coding-agent blocks

** Summary
- Ensured coding-agent fences stay collapsible/open in MDX even when Org header args are missing from the parse tree.
- Default coding-agent fences to `collapsible open` so transcript blocks remain foldable in the site UI.

** Change
- `ox-astro-helpers.el`: when emitting coding-agent fences, treat them as collapsible/open by default (still honors explicit `collapsible`/`open` flags when present).

** Files
- `ox-astro-helpers.el`: normalize-image-key, image-dimensions helper, format-image-component, image-component-for-record.
- `ox-astro-handlers.el`: collect-image-metadata-filter (forward scan, normalized keys).

** Impact
- Consistent wording controlled by content; no surprise prefixes.
- Better lightbox sizing; safer defaults when dimensions are unknown.
- Credits/captions stick to the correct image even when filenames repeat across folders.
- IMAGE-* keywords immediately after an image are picked up more reliably.

** Fixes
- Corrected paren balance in `org-astro--image-component-for-record` to restore clean load.

* 2025-11-26 Wednesday - Absolute Route Links & Narrowing Fix

** Summary
Addressed two major issues:
1.  **Narrowed Buffer Export**: Fixed a bug where exporting a narrowed buffer (e.g., a subtree) would fail to capture metadata or export the full content if the cursor was deep in the buffer.
2.  **Astro Routing**: Implemented an "Absolute Route Mode" for org-roam ID links to ensure they resolve to valid Astro URLs (e.g., `/notes/collection/id`) instead of broken relative MDX file paths (e.g., `../collection/id.mdx`).
3.  **Portability**: Removed hardcoded debug log paths from the source code, making the package distributable.

** Changes
- **`ox-astro.el`**:
  - Updated `org-astro-export-to-mdx` to unconditionally reset `point` to `(point-min)` before processing. This ensures exports always start from the beginning of the visible region (whether full buffer or narrowed subtree).
  - Replaced hardcoded debug log path with `org-astro-debug-log-file` custom variable.
- **`ox-astro-config.el`**:
  - Added `org-astro-id-link-base-path` custom variable (default: `nil`) to control absolute route generation.
- **`ox-astro-helpers.el`**:
  - Updated `org-astro-link` to check `org-astro-id-link-base-path`. If set, it computes the absolute route using the new `org-astro--compute-collection-id` helper. If nil, it falls back to relative MDX paths.
  - Updated debug helpers to use the new customizable log file variable.
- **Tests**:
  - Added `test/date-title-and-subtree-test.el` to regression test the narrowing/cursor fix.
  - Added `test-id-links.el` test case for absolute route mode.
  - Updated `test-debug.el` to use the portable log file variable.

** Impact
- **Reliable Subtree Exports**: Users can now export subtrees confidently regardless of cursor position.
- **Working Navigation**: Links between posts now work correctly in deployed Astro sites when `org-astro-id-link-base-path` is configured (e.g. to `/notes`).
- **Portability**: The package no longer depends on a specific user's filesystem for debug logging.

* 2025-11-26 Wednesday - Enhancements Documentation Updated

** Summary
Updated `suggested-enhancements.org` to reflect the current implementation status and prioritization of various features, including new opportunities from Astro 5.x image handling.

** Changes
- Reorganized `suggested-enhancements.org` into priority-based sections (High, Medium, Low Priority / Future Opportunities, Implemented / Completed).
- Marked "Remote Image Caching", "Absolute Route Mode for ID Links", and "PDF Asset Handling" as "Implemented / Completed".
- Added "Responsive Images" and "SVG Components" as "High Priority" opportunities, and "Picture Component Support" as "Low Priority / Future Opportunity", reflecting their status based on Astro 5.x features.

* 2025-12-01 - Exporter link handling hardening
** Summary
Fixed MDX parse failures caused by raw `<file:///...>` links when exporting `file+emacs`/`file+sys` links.
** Changes
- `ox-astro-helpers.el`: `org-astro-link` now rewrites non-image `file+emacs`/`file+sys` links to standard Markdown links (`file://...`), preventing invalid JSX autolinks in MDX output. Org buffers remain untouched during export.
** Impact
- Eliminates MDX parse errors from valid org file links (e.g., project references) without mutating source org files. 

* 2025-12-01 - Duplicate ID noise reduction
** Summary
Made duplicate org-roam ID handling deterministic and quiet during batch exports.
** Changes
- `ox-astro-helpers.el`: added scoring to prefer canonical sources (penalize “conflicted copy”/“ copy.org” paths) when the same ID appears in multiple files.
- Logging now defaults to a compact summary; set `OX_ASTRO_DUP_LOG_MODE=verbose` for per-ID detail.
** Impact
- Export output is readable again while still warning about ID collisions; exports pick stable winners for duplicated IDs without touching source org files.
- Strip PROPERTIES drawer output and org-roam boilerplate from MDX bodies, keeping IDs only in frontmatter (add property-drawer translator + final body cleanup of Links/Source lines). Addresses leaked `:ID:` lines like in journal/monday-february-12-2024.mdx.
