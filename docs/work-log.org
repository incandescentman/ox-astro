#+TITLE: ox-astro Work Log
#+DATE: 2025-10-07

* 2025-11-24
** Session Summary: Use SUBHED for Auto-Generated Excerpts
- Changed auto-inserted excerpt keyword from =#+EXCERPT:= to =#+SUBHED:= to match legacy convention.
- Both keywords map to the same =excerpt= front matter field in MDX output.
- Priority order unchanged: =ASTRO_EXCERPT= → =EXCERPT= → =SUBHED= → =DESCRIPTION= → fallback paragraph.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Modified =ox-astro.el:298= to insert =SUBHED= instead of =EXCERPT= when auto-generating
- [x] Added explanatory comment noting SUBHED is alias for excerpt

*CONTEXT FOR NEXT SESSION*
- Files touched: =ox-astro.el=
- No breaking changes—MDX output identical since both keywords map to =excerpt=

* 2025-11-15
** Session Summary: Formatting Issues Documentation
- Analyzed exported MDX output from goal tracking blog post to identify systematic formatting problems in the ox-astro exporter.
- Documented 5 major formatting issues: escaped org-mode markers, orphaned code block closers, double-encoded timestamps, nested code block confusion, and malformed list numbering.
- Created comprehensive issue report with line numbers, examples, root causes, and suggested fixes at [[file:formatting-issues-2025-11-15.org][formatting-issues-2025-11-15.org]].
- Issues prioritized into High Priority (breaking code block structure) and Medium Priority (visual/semantic problems).

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Full formatting analysis completed on real-world export output
- [x] Documentation created with links to source org file and MDX output for reference
- [x] 5 issues identified with detailed before/after examples and line numbers
- [x] Priority recommendations and testing suggestions provided
- [x] Test case specifications written for future regression testing

*IN-PROGRESS (Requires completion)*
- [ ] Fix Issue #1: Escaped org-mode markers with trailing underscores (=\#+begin_src_= → =#+begin_src=)
- [ ] Fix Issue #2: Orphaned =#+end_src_= closing markers appearing without opening markers
- [ ] Fix Issue #4: Nested code block confusion (code examples containing code blocks)
- [ ] Fix Issue #5: Malformed nested list numbering (flattened hierarchy)
- [ ] Fix Issue #3: Double-encoded HTML timestamps (lower priority)

*CONTEXT FOR NEXT SESSION*
- Files to review: [[file:formatting-issues-2025-11-15.org][formatting-issues-2025-11-15.org]]
- Test files referenced:
  - Source: [[file:/Users/jay/Dropbox/roam/chatgpt-outputs/20251030123203-claude_designs_a_goal_tracking_system.org][20251030123203-claude_designs_a_goal_tracking_system.org]]
  - Output: [[file:/Users/jay/Library/CloudStorage/Dropbox/github/astro-monorepo/apps/anthropic/src/content/blog/claude-designs-a-goal-tracking-system.mdx][claude-designs-a-goal-tracking-system.mdx]]
- Known unknowns: Root cause likely in =ox-astro-src-block= and =org-astro-src-block= functions; need to investigate code block nesting tracking
- Recommendations:
  - Start with Issues #1, #2, #4 (all related to code block handling) as they share common root cause
  - Create test file with nested code blocks and org-mode examples before fixing
  - Issue #5 (list numbering) is separate concern in list export logic

* 2025-11-13
** Session Summary: Link Conversion in User Blocks
- Fixed bug where org-mode links inside `user`, `prompt`, and `quote` blocks were being exported in raw org-mode format (`[[link][text]]`) instead of being converted to Markdown format (`[text](link)`).
- Enhanced `org-astro-src-block` function to convert org-mode links to Markdown during special block processing.
- Link conversion now handles both forms: `[[path][description]]` → `[description](path)` and `[[path]]` → `[path](path)`.
- This conversion happens alongside existing transformations (em dashes, org headings) for these special blocks.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Link conversion regex added to `org-astro-src-block` for `user`, `prompt`, and `quote` blocks (`ox-astro-helpers.el:1206-1216`)
- [x] Tested with real export file - links now correctly convert to Markdown format in user blocks
- [x] Verified git diff shows correct Markdown link output

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`
- Known unknowns: None - feature is complete and tested
- Recommendations: None

** Previous Session: Destination Keyword Alias
- Added `#+DESTINATION` as a shorter alias for `#+DESTINATION_FOLDER` and `#+DESTINATION-FOLDER`, providing users with a more concise option for specifying export destinations.
- Updated all regex patterns across the codebase to recognize all three forms: `#+DESTINATION_FOLDER:`, `#+DESTINATION-FOLDER:`, and `#+DESTINATION:`.
- Enhanced keyword preservation logic to maintain user's preferred format when updating existing destination keywords.
- Updated documentation across README, concept map, and config files to reflect the new shorter alias.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Regex patterns updated in three locations to support `#+DESTINATION:` (`ox-astro-helpers.el:399`, `update-image-paths.el:76`, `ox-astro.el:345`)
- [x] Keyword preservation logic enhanced to handle all three format variants (`ox-astro.el:348-351`)
- [x] Documentation updated: `README.org:82,129`, `docs/concept-map.org:80`, `ox-astro-config.el:16,53,61`
- [x] Regex tests created and passing for all three keyword variants

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `update-image-paths.el`, `ox-astro.el`, `README.org`, `docs/concept-map.org`, `ox-astro-config.el`
- Known unknowns: None - feature is complete and tested
- Recommendations: Consider adding to CHANGE-LOG.org if this warrants a version bump or release note

* 2025-10-30
** Session Summary
- Added `#+SUBHED` as an accepted excerpt keyword so Org sources can map legacy decks into MDX front matter without duplication.
- Refreshed metadata documentation (design architecture, concept map) and recorded the behavior change in the change log.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Excerpt priority now considers `ASTRO_EXCERPT`, `EXCERPT`, `SUBHED`, `DESCRIPTION`, then paragraph fallback (`ox-astro-helpers.el:887-905`).
- [x] Documentation updates: `docs/design-architecture.org:152-168`, `docs/concept-map.org:99-106`, `CHANGE-LOG.org:5-15`.

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `docs/design-architecture.org`, `docs/concept-map.org`, `CHANGE-LOG.org`
- Known unknowns: Need an export smoke test confirming SUBHED usage emits `excerpt` as expected.
- Recommendations: Export a representative Org note using `#+SUBHED` to verify front matter output.

* 2025-10-26
** Session Summary
- Exporter now preserves `#+MEDIA`, `#+INCOMPLETE`, and the connection keywords so regenerated MDX matches the enriched schema in life-web.
- Front-matter generator learned how to embed nested YAML blocks, enabling us to emit the `connections` map without rewriting the serializer.
- Metadata parsers gained normalization for attachment lists and boolean draft flags, keeping input tolerance consistent with other list fields.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Keyword plumbing (`ox-astro.el:560-596`) covers media, incomplete, and connection variants alongside existing metadata.
- [x] Parsers for media/incomplete/connections added to `ox-astro-metadata.el:160-225`, trimming empty items and coercing booleans.
- [x] Front-matter assembly & YAML output updated to handle raw nested blocks (`ox-astro-helpers.el:774-990`).
- [x] Work log updated; standalone `CHANGE-LOG.org` entry removed per guidance.

*IN-PROGRESS (Requires completion)*
- [ ] Run an end-to-end export on representative notes to confirm the new fields align with life-web ingestion (attachments, draft flags, connections).

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro.el`, `ox-astro-metadata.el`, `ox-astro-helpers.el`
- Known unknowns: No automated fixture yet for nested connection emission; consider adding an ERT around `org-astro--format-connections-yaml`.
- Recommendations: Re-export one of the new story org files and verify `media`, `incomplete`, and `connections` materialize correctly in the MDX front matter.

* 2025-10-22
** Session Summary
- Enabled `#+DESTINATION-FOLDER` as a synonym for `#+DESTINATION_FOLDER` across the exporter and tooling.
- Normalized destination keyword detection in helper scripts and refreshed documentation to advertise both forms.
- Logged the change in CHANGE-LOG with guidance on pending test coverage.
- Updated ID link guidance and fixtures to demonstrate Markdown links with preserved directory structure.
- Refreshed operational instructions with the Markdown link behavior for org-roam exports.

** Handoff

- [x] Destination keyword aliasing implemented: `ox-astro.el:97`, `ox-astro-helpers.el:211`
- [x] Auto-insert preserves user delimiter and absorptive docs updated: `ox-astro.el:309`, `README.org:82`, `docs/concept-map.org:80`
- [x] Tooling aware of both forms (`update-image-paths.el:72`, config docs)
- [x] Change log entry added: `CHANGE-LOG.org:5`
- [x] ID link docs/tests reinforced Markdown relative outputs: `docs/lab/org-roam-links.org`, `test-id-links.el`, `test-files/id-links/*`
- [x] Instructions updated to highlight Markdown link outputs: `docs/instructions.org:15`
- [x] Absolute-path destinations now populate ID map metadata: `ox-astro-helpers.el:181`, `test-id-links.el`
- [x] Source-root detection auto-falls back to the note's org-roam vault, keeping ID links working even when exporting from another profile: `ox-astro-helpers.el:339`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro.el`, `ox-astro-helpers.el`, `update-image-paths.el`, documentation set
- Known unknowns: Automated regression suite beyond `test-id-links.el` not re-run; alias relies on shared keyword helper
- Recommendations: Export a sample Org file using `#+DESTINATION-FOLDER:` and run `emacs --batch -Q -l test-id-links.el -f ert-run-tests-batch-and-exit`

* 2025-11-15
** Session Summary
- Hardened the destination-folder resolution in `org-astro-prepare-images-filter` so whitespace-laden nicknames reuse the same helper as the main exporter.
- Replaced the regex-based hero suppression with a multi-line safe removal helper and tightened the MDX final-output filter to respect code fences and list continuations.
- Added regression ERTs covering fenced-code + list indentation handling and ensured the test harness loads the repo modules reliably.
- Taught the list transcoder to keep dash bullets nested under numbered items and documented the verification in `formatting-issues-2025-11-15.org`.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Shared destination resolution + info plists updated: `ox-astro-handlers.el:60-110`
- [x] Hero component removal recognizes multi-line Image tags: `ox-astro-handlers.el:140-170`
- [x] Final output filter skips code fences/lists + new tests added: `ox-astro-handlers.el:240-320`, `test/image-pipeline-test.el:1-124`
- [x] Inline dash bullets stay nested with updated translator + regression test: `ox-astro-handlers.el:40-120, 140-210`, `test/image-pipeline-test.el:101-140`

*IN-PROGRESS (Requires completion)*
- [ ] Gallery regression fixture (`test/gallery_test_rigorous.expected.mdx`) no longer matches exporter output; needs refresh or relaxed assertions.

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-handlers.el`, `test/image-pipeline-test.el`
- Known unknowns: Gallery snapshot diverges (extra Image import, column props, missing legacy images). Decide whether to update expected MDX or adjust exporter to retain prior behavior.
- Recommendations: Re-run `emacs --batch -Q -l ert -l test/image-pipeline-test.el -f ert-run-tests-batch-and-exit` after reconciling the gallery fixture; confirm hero-image removal still suppresses duplicates in real posts.

* 2025-10-20
** Session Summary
- ID links disappearing traced to user hook `org-export-id-link-removal` running during export copy.
- Added hook sanitization helper and wrapped Astro exports so blocklisted hooks are removed.
- Documented investigation resolution and added regression test for hook scrubbing.
- Lesson learned: when a feature works locally but fails for the user, inspect their hooks/config before blaming exporter internals.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Hook sanitization macro + export wrappers: `ox-astro.el:69`
- [x] Regression test `org-astro-export-sanitizes-id-stripping-hooks`: `test-id-links.el:113`
- [x] Investigation doc updated with root cause and fix: `docs/INVESTIGATION-id-links-stripped.org:285`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro.el`, `test-id-links.el`, `docs/INVESTIGATION-id-links-stripped.org`
- Known unknowns: Need live export from org-roam vault to confirm hook sanitization covers whole pipeline.
- Recommendations: Verify no other user hooks in init files rewrite links or other elements during export.

* 2025-10-10
** Session Summary
- Added DESCRIPTION keyword as fallback for EXCERPT in front matter generation
- Updated excerpt extraction logic to check EXCERPT first, then DESCRIPTION, then first paragraph
- Updated documentation in concept-map.org, design-architecture.org, and CHANGE-LOG.org

** Handoff

*COMPLETED (Safe to rely on)*
- [x] DESCRIPTION fallback implemented: `ox-astro-helpers.el:392-414`
- [x] Priority order: ASTRO_EXCERPT → EXCERPT → DESCRIPTION → first paragraph
- [x] Documentation updated: `docs/concept-map.org:103`, `docs/design-architecture.org:161`
- [x] Change log entry added: `CHANGE-LOG.org:5-29`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `docs/concept-map.org`, `docs/design-architecture.org`, `CHANGE-LOG.org`
- Known unknowns: None - feature is complete and self-contained
- Recommendations:
  - Test with an org file that has both DESCRIPTION and EXCERPT to verify priority works correctly
  - Consider whether README.org needs updating (currently skipped per user request)

* 2025-10-07
** Session Summary
- Updated table cell sanitization to wrap generic type signatures and normalize `<br>` tags for MDX compatibility.
- Normalized `<br>` tags during final output filtering to avoid Astro parse errors.
- Re-exported `guide-to-codex.org` to regenerate the Socratic blog post.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Generic type cells wrapped in inline code: `ox-astro-table-handlers.el`
- [x] `<br>` normalization added to final output filter: `ox-astro-handlers.el`
- [x] Export refreshed: `/Users/jay/Library/CloudStorage/Dropbox/github/astro-monorepo/apps/socratic/src/content/blog/guide-to-codex-cli.mdx`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-table-handlers.el`, `ox-astro-handlers.el`
- Known unknowns: Consider whether other HTML fragments (e.g., `<hr>`, `<img>`) need similar normalization.
- Recommendations: Review latest generated MDX in Astro dev server to confirm no additional JSX parse errors.
