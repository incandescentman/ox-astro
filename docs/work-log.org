#+TITLE: ox-astro Work Log
#+DATE: 2025-10-07

* 2025-10-30
** Session Summary
- Added `#+SUBHED` as an accepted excerpt keyword so Org sources can map legacy decks into MDX front matter without duplication.
- Refreshed metadata documentation (design architecture, concept map) and recorded the behavior change in the change log.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Excerpt priority now considers `ASTRO_EXCERPT`, `EXCERPT`, `SUBHED`, `DESCRIPTION`, then paragraph fallback (`ox-astro-helpers.el:887-905`).
- [x] Documentation updates: `docs/design-architecture.org:152-168`, `docs/concept-map.org:99-106`, `CHANGE-LOG.org:5-15`.

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `docs/design-architecture.org`, `docs/concept-map.org`, `CHANGE-LOG.org`
- Known unknowns: Need an export smoke test confirming SUBHED usage emits `excerpt` as expected.
- Recommendations: Export a representative Org note using `#+SUBHED` to verify front matter output.

* 2025-10-26
** Session Summary
- Exporter now preserves `#+MEDIA`, `#+INCOMPLETE`, and the connection keywords so regenerated MDX matches the enriched schema in life-web.
- Front-matter generator learned how to embed nested YAML blocks, enabling us to emit the `connections` map without rewriting the serializer.
- Metadata parsers gained normalization for attachment lists and boolean draft flags, keeping input tolerance consistent with other list fields.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Keyword plumbing (`ox-astro.el:560-596`) covers media, incomplete, and connection variants alongside existing metadata.
- [x] Parsers for media/incomplete/connections added to `ox-astro-metadata.el:160-225`, trimming empty items and coercing booleans.
- [x] Front-matter assembly & YAML output updated to handle raw nested blocks (`ox-astro-helpers.el:774-990`).
- [x] Work log updated; standalone `CHANGE-LOG.org` entry removed per guidance.

*IN-PROGRESS (Requires completion)*
- [ ] Run an end-to-end export on representative notes to confirm the new fields align with life-web ingestion (attachments, draft flags, connections).

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro.el`, `ox-astro-metadata.el`, `ox-astro-helpers.el`
- Known unknowns: No automated fixture yet for nested connection emission; consider adding an ERT around `org-astro--format-connections-yaml`.
- Recommendations: Re-export one of the new story org files and verify `media`, `incomplete`, and `connections` materialize correctly in the MDX front matter.

* 2025-10-22
** Session Summary
- Enabled `#+DESTINATION-FOLDER` as a synonym for `#+DESTINATION_FOLDER` across the exporter and tooling.
- Normalized destination keyword detection in helper scripts and refreshed documentation to advertise both forms.
- Logged the change in CHANGE-LOG with guidance on pending test coverage.
- Updated ID link guidance and fixtures to demonstrate Markdown links with preserved directory structure.
- Refreshed operational instructions with the Markdown link behavior for org-roam exports.

** Handoff

- [x] Destination keyword aliasing implemented: `ox-astro.el:97`, `ox-astro-helpers.el:211`
- [x] Auto-insert preserves user delimiter and absorptive docs updated: `ox-astro.el:309`, `README.org:82`, `docs/concept-map.org:80`
- [x] Tooling aware of both forms (`update-image-paths.el:72`, config docs)
- [x] Change log entry added: `CHANGE-LOG.org:5`
- [x] ID link docs/tests reinforced Markdown relative outputs: `docs/lab/org-roam-links.org`, `test-id-links.el`, `test-files/id-links/*`
- [x] Instructions updated to highlight Markdown link outputs: `docs/instructions.org:15`
- [x] Absolute-path destinations now populate ID map metadata: `ox-astro-helpers.el:181`, `test-id-links.el`
- [x] Source-root detection auto-falls back to the note's org-roam vault, keeping ID links working even when exporting from another profile: `ox-astro-helpers.el:339`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro.el`, `ox-astro-helpers.el`, `update-image-paths.el`, documentation set
- Known unknowns: Automated regression suite beyond `test-id-links.el` not re-run; alias relies on shared keyword helper
- Recommendations: Export a sample Org file using `#+DESTINATION-FOLDER:` and run `emacs --batch -Q -l test-id-links.el -f ert-run-tests-batch-and-exit`

* 2025-10-20
** Session Summary
- ID links disappearing traced to user hook `org-export-id-link-removal` running during export copy.
- Added hook sanitization helper and wrapped Astro exports so blocklisted hooks are removed.
- Documented investigation resolution and added regression test for hook scrubbing.
- Lesson learned: when a feature works locally but fails for the user, inspect their hooks/config before blaming exporter internals.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Hook sanitization macro + export wrappers: `ox-astro.el:69`
- [x] Regression test `org-astro-export-sanitizes-id-stripping-hooks`: `test-id-links.el:113`
- [x] Investigation doc updated with root cause and fix: `docs/INVESTIGATION-id-links-stripped.org:285`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro.el`, `test-id-links.el`, `docs/INVESTIGATION-id-links-stripped.org`
- Known unknowns: Need live export from org-roam vault to confirm hook sanitization covers whole pipeline.
- Recommendations: Verify no other user hooks in init files rewrite links or other elements during export.

* 2025-10-10
** Session Summary
- Added DESCRIPTION keyword as fallback for EXCERPT in front matter generation
- Updated excerpt extraction logic to check EXCERPT first, then DESCRIPTION, then first paragraph
- Updated documentation in concept-map.org, design-architecture.org, and CHANGE-LOG.org

** Handoff

*COMPLETED (Safe to rely on)*
- [x] DESCRIPTION fallback implemented: `ox-astro-helpers.el:392-414`
- [x] Priority order: ASTRO_EXCERPT → EXCERPT → DESCRIPTION → first paragraph
- [x] Documentation updated: `docs/concept-map.org:103`, `docs/design-architecture.org:161`
- [x] Change log entry added: `CHANGE-LOG.org:5-29`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `docs/concept-map.org`, `docs/design-architecture.org`, `CHANGE-LOG.org`
- Known unknowns: None - feature is complete and self-contained
- Recommendations:
  - Test with an org file that has both DESCRIPTION and EXCERPT to verify priority works correctly
  - Consider whether README.org needs updating (currently skipped per user request)

* 2025-10-07
** Session Summary
- Updated table cell sanitization to wrap generic type signatures and normalize `<br>` tags for MDX compatibility.
- Normalized `<br>` tags during final output filtering to avoid Astro parse errors.
- Re-exported `guide-to-codex.org` to regenerate the Socratic blog post.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Generic type cells wrapped in inline code: `ox-astro-table-handlers.el`
- [x] `<br>` normalization added to final output filter: `ox-astro-handlers.el`
- [x] Export refreshed: `/Users/jay/Library/CloudStorage/Dropbox/github/astro-monorepo/apps/socratic/src/content/blog/guide-to-codex-cli.mdx`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-table-handlers.el`, `ox-astro-handlers.el`
- Known unknowns: Consider whether other HTML fragments (e.g., `<hr>`, `<img>`) need similar normalization.
- Recommendations: Review latest generated MDX in Astro dev server to confirm no additional JSX parse errors.
