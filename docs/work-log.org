#+TITLE: ox-astro Work Log
#+DATE: 2025-10-07

* 2026-01-14 Fix soft break logic location (paragraph level, not plain-text)

** Problem
Single newlines within paragraphs weren't being preserved as Markdown soft breaks, despite the feature being "implemented" in commit 420d2c9.

** Root Cause
The soft break logic was in =org-astro-plain-text=, but that function only sees text fragments between other elements. For a paragraph like:

#+begin_example
*Bold line one.*
Or: *Bold line two.*
#+end_example

The parse tree is:
- paragraph
  - bold "Bold line one."
  - plain-text "\nOr: "
  - bold "Bold line two."

So =org-astro-plain-text= gets fragments like ="\nOr: "=, not the whole paragraph. The soft break logic couldn't work there.

** Fix
Moved soft break logic to the paragraph level:
1. Added =org-astro--add-soft-breaks= helper function
2. Applied it to the output of =org-md-paragraph= in =org-astro-paragraph=
3. Removed ineffective logic from =org-astro-plain-text=

** Files Modified
- =ox-astro-transcode.el= — new helper + paragraph handler update + plain-text cleanup

* 2026-01-13 YouTube auto-embed scoped to line-only URLs

** Summary
Aligned YouTube auto-embed with the documented behavior: only bare URLs on their own line embed. This prevents reference-style link definitions from being converted into iframes.

** Changes
- Added =org-astro--paragraph-only-raw-link-p= to detect URL-only paragraphs
- Gated YouTube embeds in =org-astro-link= on paragraph-only context
- Documented the issue in =bugs/20260113-youtube-url-in-reference-links.org=

** Verification
- Confirmed in =apps/socratic/src/content/blog/comparing-softboxes.mdx= that a standalone YouTube URL embeds while a reference-style YouTube definition remains intact

* 2026-01-08 Fix jaydocs email export paragraph spacing

** Problem
Email exports from jaydocs had no visual spacing between paragraphs. Paragraphs were separate =<p>= tags but all had =margin: 0= inlined.

** Root Cause
Tailwind's CSS reset sets =margin: 0= on all elements. Socratic had =email-post.css= with explicit paragraph margins that overrode this; jaydocs had =extraCssPaths: []= so nothing overrode the reset.

** Fix (in astro-monorepo)
- Created =apps/jaydocs/src/styles/email-post.css= with margins for =.email-body .prose p=, headings, lists, etc.
- Updated =apps/jaydocs/scripts/email-export.mjs= to include =email-post.css= in =extraCssPaths=

* 2026-01-08 Email export CLI implemented in astro-monorepo

** Summary
The email export feature spec was implemented in astro-monorepo (not ox-astro). Deleted the redundant spec file from ox-astro.

** Implementation (in astro-monorepo)
- Shared core: =scripts/email-export.mjs= — Astro rendering, Tailwind build, CSS inlining via juice, URL rewriting
- Socratic: =apps/socratic/scripts/email-export.mjs=, =EmailBody.astro=, =email-post.css=
- Jaydocs: =apps/jaydocs/scripts/email-export.mjs=, =EmailBody.astro=

** Usage
#+begin_src shell
pnpm -C apps/socratic email:export -- --slug does-chatgpt-believe-in-aliens
pnpm -C apps/jaydocs email:export -- --slug some-post-slug
#+end_src

** Files Removed from ox-astro
- =docs/spec-html-email-export.org= — moved to =astro-monorepo/docs/proposals/email-export-cli.org=

* 2026-01-08 Preserve single newlines as Markdown soft breaks

** Summary
Modified =org-astro-plain-text= to preserve single newlines within paragraphs as visible line breaks in the rendered output. Previously, single newlines were collapsed to spaces (standard Markdown behavior).

** Problem
AI conversation transcripts often contain meaningful line breaks:
#+begin_example
A conclusion you can draw more cleanly, with a Bayesian lens.
Neither assistant said "Bayes" explicitly...
#+end_example

Standard Markdown collapses this to one line, losing the intended formatting.

** Solution
Add two trailing spaces to each non-empty line (except the last) in =org-astro-plain-text=. This creates Markdown "soft breaks" that render as =<br>= in HTML.

** Files Modified
- =ox-astro-transcode.el= — updated =org-astro-plain-text= to add soft break trailing spaces
- =docs/design-architecture.org= — documented Line Break Preservation behavior

* 2026-01-08 Updated remarkHideAiModelHeadings to support version numbers

** Summary
Updated the =remarkHideAiModelHeadings= remark plugin in astro-monorepo to hide AI model headings that include version numbers, not just exact matches.

** Problem
Headings like "ChatGPT 5.2 Pro" or "Claude Sonnet 4.5" weren't being hidden because the plugin only matched exact strings like "ChatGPT" or "Claude".

** Solution
Changed from exact string matching to regex patterns that match model names with optional version numbers and variants:
- =chatgpt= + optional version + optional (pro|plus|mini)
- =claude= + optional version + optional (opus|sonnet|haiku) + optional version
- =gemini= + optional version + optional (pro|flash|ultra|nano)

** Files Modified
- =packages/astro-utils/src/remark/hideAiModelHeadings.ts= — switched to regex-based pattern matching

** Note
This change is in astro-monorepo, not ox-astro, but documented here for context since it relates to the AI conversation export workflow.

* 2026-01-05 Pass through example block meta to MDX code fences

** Summary
Modified ~org-astro-example-block~ to pass additional switches beyond the language as meta in the code fence.

** Example
#+begin_src org
#+begin_example fountain collapsible
INT. WAITING ROOM - LATER
...
#+end_example
#+end_src

Now exports to:

#+begin_src markdown
```fountain collapsible
INT. WAITING ROOM - LATER
...
```
#+end_src

This enables foldable fountain blocks in the Astro renderer.

** Files Modified
- ~ox-astro-transcode.el~ — updated ~org-astro-example-block~ to include meta tokens

* 2026-01-04 Split ox-astro-helpers into modules

** Summary
Split =ox-astro-helpers.el= into smaller modules to avoid loading a monolith,
keeping a thin loader for backward compatibility.

** Changes
- Added =ox-astro-helpers-core.el=, =ox-astro-transcode.el=, and =ox-astro-export-helpers.el=.
- Converted =ox-astro-helpers.el= into a loader requiring the new modules.
- Updated =declare-function= references to point at the new module locations.
- Updated concept map links to the new helper files.

** Files Modified
- =ox-astro-helpers.el=
- =ox-astro-helpers-core.el=
- =ox-astro-transcode.el=
- =ox-astro-export-helpers.el=
- =ox-astro-handlers.el=
- =ox-astro-image-handlers.el=
- =ox-astro.el=
- =docs/concept-map.org=

** Verification
- =emacs --batch -Q -L . -f batch-byte-compile ox-astro-helpers-core.el ox-astro-transcode.el ox-astro-export-helpers.el= (clean)

* 2026-01-04 Byte-compile warning cleanup

** Summary
Cleaned up byte-compile warnings introduced by the helper-module split.

** Changes
- Reflowed docstrings and fixed quoting/unused-arg warnings.
- Updated image-dimension detection to avoid obsolete APIs.
- Added missing requires/declares and corrected a debug log call.

** Files Modified
- =ox-astro-helpers-core.el=
- =ox-astro-transcode.el=
- =ox-astro-export-helpers.el=
- =docs/work-log.org=

** Verification
- =emacs --batch -Q -L . -f batch-byte-compile ox-astro-helpers-core.el ox-astro-transcode.el ox-astro-export-helpers.el= (clean)

* 2026-01-04
** Session: Fountain screenplay format support

*** Summary
Added support for exporting =#+begin_example fountain= blocks as fenced Markdown code blocks with the =fountain= language identifier.

*** Implementation
- Created =org-astro-example-block= function in =ox-astro-helpers.el=
- Registered handler in translate-alist in =ox-astro.el=
- Example blocks with switches (e.g., =#+begin_example fountain=) now emit =```fountain= fenced blocks

*** Usage
#+begin_src org
#+begin_example fountain
INT. WAITING ROOM - DAY

KUMAIL
Hey, so when are we going to talk?
#+end_example
#+end_src

Exports to:
#+begin_src markdown
```fountain
INT. WAITING ROOM - DAY

KUMAIL
Hey, so when are we going to talk?
```
#+end_src

*** Files Modified
- =ox-astro-helpers.el= — added =org-astro-example-block= function
- =ox-astro.el= — registered example-block handler in translate-alist

*** Notes
- Works with any example block switch, not just fountain
- Pairs with =remarkFountainBlocks= in astro-utils for screenplay rendering
- Ignores org example flags like =-n= / =-r= when selecting the fenced code language

* 2025-12-26
** Session: Em-dash support for emphasis boundaries

*** Summary
Extended =org-emphasis-regexp-components= to recognize em-dashes (—) and en-dashes (–) as valid boundaries for emphasis markers like =/italics/= and =*bold*=.

*** Problem
Org-mode emphasis markers require valid "pre" and "post" boundary characters. By default, em-dashes aren't recognized, so text like:
#+begin_example
consciousness—/what it feels like/—is emergent
#+end_example
Would output the =/italics/= literally instead of converting to =*italics*= in MDX.

*** Solution
Added configuration to =ox-astro-config.el= that extends the emphasis regex:
#+begin_src elisp
(with-eval-after-load 'org
  (when (boundp 'org-emphasis-regexp-components)
    (let ((pre  (nth 0 org-emphasis-regexp-components))
          (post (nth 1 org-emphasis-regexp-components)))
      (unless (string-match-p "—" pre)
        (setcar (nthcdr 0 org-emphasis-regexp-components)
                (concat "—–" pre)))
      (unless (string-match-p "—" post)
        (setcar (nthcdr 1 org-emphasis-regexp-components)
                (concat "—–" post)))
      (org-set-emph-re 'org-emphasis-regexp-components
                       org-emphasis-regexp-components))))
#+end_src

*** Files Modified
- =ox-astro-config.el= — added em-dash/en-dash to emphasis boundaries

*** Workaround (if config not loaded)
Add spaces around emphasis markers in org source:
#+begin_example
consciousness — /what it feels like/ — is emergent
#+end_example

** Session: Theme/model banners + pullquote formatting

*** Summary
- Document-level =#+MODEL:= now emits a model banner once near the top of the body.
- Page-level theme markers are injected for multi-AI posts when inline theme sections exist.
- Inline theme marker insertion no longer duplicates existing THEME keywords.
- Pullquote blocks now convert org =/italics/=, =*bold*=, and =_underline_=.
- Updated docs and added a regression test for doc-level model banners + duplicate prevention.

*** Files Modified
- =ox-astro-handlers.el=
- =ox-astro-helpers.el=
- =README.org=
- =docs/instructions.org=
- =test/theme-reorder-test.el=

*** Follow-up
- Fixed doc-level keyword detection to work when keywords live in the top-level section.
- Prevented duplicate theme markers when a THEME keyword appears immediately before a heading but is still inside the previous section.

* 2025-12-23
** Session: Auto-delete stale MDX files on slug change

*** Summary
Added automatic cleanup of old MDX files when a slug is changed and the file is re-exported. The system uses the =orgPath= field already present in MDX frontmatter to identify files from the same source.

*** Problem
When changing a slug (e.g., from =dad-s-healthy-recipes= to =dad-healthy-recipes=), re-exporting would create a new MDX file but leave the old one behind, creating duplicates.

*** Solution
1. Created =org-astro--extract-orgpath-from-mdx= helper that reads the =orgPath= field from MDX frontmatter
2. Created =org-astro--cleanup-stale-mdx-files= that:
   - Scans the output directory for all =.mdx= files
   - Skips the just-written current output file
   - Checks each file's =orgPath= against the source file
   - Deletes any that match the source but have a different filename
3. Called cleanup after export completes in =ox-astro.el=

*** Key Insight
The =orgPath= field was already being written to MDX frontmatter (line 1598 of helpers), so no changes were needed to add source tracking—only the cleanup logic.

*** Files Modified
- =ox-astro-helpers.el= — added cleanup functions (lines 2150-2192)
- =ox-astro.el= — added forward declaration and cleanup call after export

*** Usage
Automatic. When exporting, any stale MDX files from the same source are deleted:
#+begin_example
[ox-astro] Deleted stale MDX: dad-s-healthy-recipes.mdx
#+end_example

* 2025-12-07
** Session: Convert org links to HTML in image credits

*** Summary
Added support for org-mode links in =#+IMAGE-CREDIT= fields. Links like =[[url][text]]= are now converted to HTML =<a href="url">text</a>= tags in the figcaption output.

*** Problem
Image credits containing org-mode links were being output literally as =[[url][text]]= instead of being converted to clickable HTML links.

*** Solution
1. Created =org-astro--convert-org-links-to-html= helper function that converts:
   - =[[url][description]]= → =<a href="url">description</a>=
   - =[[url]]= → =<a href="url">url</a>=

2. Updated =org-astro--format-image-component= to apply this conversion to both credit and caption text before inserting into figcaption/lightbox.

*** Files Modified
- ox-astro-helpers.el — added helper function and updated format-image-component

*** Usage
#+begin_src org
[[/path/to/image.jpg]]
#+IMAGE-CREDIT: [[https://example.com][Artist Name]] / [[https://instagram.com/artist][@artist]]
#+end_src

Now renders as:
#+begin_src html
<figcaption class="image-caption">
  <a href="https://example.com">Artist Name</a> / <a href="https://instagram.com/artist">@artist</a>
</figcaption>
#+end_src

* 2025-12-04
** Session: Implement foldable code block styling in astro-utils

*** Summary
Updated the remarkFoldableBlocks remark plugin and blocks.css to implement proper collapsible code block behavior with preview, summary text, and toggle triangle.

*** Changes Made
1. *foldableBlocks.ts* - Complete rewrite of collapsible logic:
   - Blocks now start **closed by default** (only open if `open` flag is present)
   - Summary shows first 6 lines in a styled `<pre class="foldable-preview">` code block
   - Adds "This went on for a while..." text when there's more content
   - Full content in `<pre class="foldable-content">` that shows when expanded

2. *blocks.css* - Added styling for foldable blocks:
   - Preview code block has dark theme styling (#1e293b background)
   - "This went on for a while..." bar has slightly lighter background (#334155)
   - Triangle (▶) rotates 90° when expanded
   - Preview hides when open, full content hides when closed

*** Syntax
#+begin_src markdown
```coding-agent collapsible
...code here...
```

```coding-agent collapsible open
...starts expanded...
```
#+end_src

*** Files Modified (astro-monorepo)
- packages/astro-utils/src/remark/foldableBlocks.ts
- packages/astro-utils/src/styles/blocks.css

*** Follow-up: Remove "This went on for a while..." text
Removed the summary text below the preview - looked cluttered. Preview now has full rounded corners.

*** Follow-up: Add triangle label and line count
Implemented Variant 1 UI for foldable blocks:
- "▶ Show more" label with rotating triangle (via CSS ::before)
- "X more lines" count below the preview
- Both hide when expanded, showing only full content
- Fixed duplicate triangle by hiding summary ::marker and ::before

*** Follow-up: Add fixed collapse button with animations
Added a "Collapse Code Block" button that appears when foldable blocks are expanded:
- Fixed position at bottom-left of viewport (stays visible while scrolling)
- Animated entry: slides up + fades in
- Pulse animation on first appearance (2 pulses)
- Shrinks to icon-only after 3 seconds (smooth animation)
- Hover expands back to full text smoothly
- Custom SVG collapse icon (rotated 90°)
- Progress indicator ring showing scroll position through the code block
- Matches code block theme colors (#1e293b background, slate text)
- Hover glow effect

*** Follow-up: Replace triangle with expand icon
- Replaced the simple triangle on "Show more" label with a custom expand SVG icon (four arrows pointing outward from center circle)
- Kept the triangle on the line count indicator ("▶ 789 more lines")
- Button text changed from "Collapse" to "Collapse Code Block"

*** Follow-up: Remove shrink animation
- Removed the shrink-to-icon animation - button now stays full "Collapse Code Block" text permanently

*** Follow-up: Scroll to collapsed block on close
- When clicking "Collapse Code Block", page now scrolls so the bottom of the collapsed block is visible
- Prevents user from being stranded far down the page after collapsing a long code block
- Uses `scrollIntoView({block:'end', behavior:'instant'})`

*** CSS Animation Insights
Key learning: When using CSS animations with `animation-fill-mode: forwards`, hover states that use `animation: none` cause "blipping" when hovering off (the animation restarts from where it was paused). The fix is to use `!important` to override the animation's fill-mode values while letting the animation continue running in the background.

** Session: Fix folded meta syntax for coding-agent blocks

*** Summary
Fixed the folded meta flag syntax to match what the Astro remarkFoldableBlocks plugin expects.

*** Problem
ox-astro was outputting =```coding-agent :folded= but the remark plugin expects =```coding-agent folded= (without the colon).

*** Solution
Changed =" :folded"= to =" folded"= in the src-block handler.

*** Files Modified
- ox-astro-helpers.el (lines 1836 and 1887)

** Session: Fix missing parenthesis causing void-function error

*** Summary
Fixed a critical bug where =org-astro--get-title= and ~25 other functions were not being defined due to unbalanced parentheses in =ox-astro-helpers.el=.

*** Problem
Exporting org files failed with =void-function org-astro--get-title= error even after reloading the file. The function was defined in the source file but Emacs wasn't loading it.

*** Root Cause
The =org-astro--contains-markdown-link-p= function (line 1104) was missing its closing parenthesis. It ended with =text)))= (3 parens) but needed =text))))= (4 parens). This caused the Emacs reader to interpret everything from line 1104 through line 1889 as a single giant s-expression, "swallowing" ~25 function definitions including =org-astro--get-title=.

Compensating for this, =org-astro-src-block= (line 1889) had an extra closing parenthesis (5 instead of 4).

*** Solution
1. Added the missing =)= at line 1110 (=text)))= → =text))))=)
2. Removed the extra =)= at line 1889 (5 → 4 close parens)

*** Debugging Approach
- Used =load-history= to see which defuns were actually loaded (53 of 78)
- Binary searched to find that Form 89 spanned lines 1099-1889 (should have been ~7 lines)
- Traced through sexp boundaries to locate the missing paren

*** Files Modified
- ox-astro-helpers.el (lines 1110 and 1889)

** Session: Pullquote link conversion

*** Summary
Fixed org-mode links inside pullquote blocks not being converted to markdown format, causing them to appear as raw org syntax in the exported MDX.

*** Problem
Org-mode links =[[url][text]]= inside =#+BEGIN_SRC pullquote= blocks were being output literally in MDX instead of being converted to markdown link syntax =[text](url)=. This prevented the links from rendering as clickable anchors.

*** Solution
Applied the same link conversion logic already used for =user=, =prompt=, =quote=, =poetry=, and =verse= blocks to =pullquote= blocks:
- Convert =[[path][description]]= → =[description](path)=
- Convert =[[path]]= → =[path](path)=

*** Implementation
Modified =org-astro-src-block= function in =ox-astro-helpers.el= to process links before wrapping pullquote content in the div. Uses =replace-regexp-in-string= to transform org-mode link syntax to markdown.

*** Integration with Astro
This works in conjunction with the =rehypeMarkdownLinksInHtml= plugin in Astro (astro-monorepo), which then converts markdown links inside HTML blocks to proper =<a>= tags.

*** Files Modified
- ox-astro-helpers.el (org-astro-src-block function, lines 1814-1830)

* 2025-12-03
** Session: YouTube embed + hide hero flag

*** Summary
- Added responsive YouTube embedding via =#+YOUTUBE:= keyword (also catches bare YouTube URLs) emitting 16:9 iframe markup
- Plumbed =HIDE_HERO_IMAGE= frontmatter keyword through options/frontmatter to hide hero on detail pages while keeping list thumbnails

*** Files Modified
- ox-astro-helpers.el
- ox-astro-handlers.el
- ox-astro.el

* 2025-12-03
** Session: Poetry/verse block support

*** Summary
- Added poetry/verse handling to src blocks so headings/links are normalized like quote/user blocks
- Introduced shared styling for poetry via language-poetry/verse and .poetry-block with serif, left border, preserved line breaks

*** Files Modified
- ox-astro-helpers.el
- packages/astro-utils/src/styles/blocks.css

* 2025-12-04
** Session: Prevent inline THEME from setting page theme

*** Summary
- Only promote THEME to frontmatter when it appears before the first heading; inline theme markers now stay inline and no longer set page-wide theme

*** Files Modified
- ox-astro-helpers.el

* 2025-12-04
** Session: TOC hide flag support

*** Summary
- Added `HIDE_TOC`/`ASTRO_HIDE_TOC` keywords to export `hideTOC` frontmatter so Astro can suppress TOC per-page

*** Files Modified
- ox-astro.el
- ox-astro-helpers.el

* 2025-12-04
** Session: Foldable coding-agent blocks

*** Summary
- Pass through `:folded` meta on coding-agent src blocks to emit ```coding-agent :folded``` fences for the folding plugin

*** Files Modified
- ox-astro-helpers.el

* 2025-11-30
** Session 3: Image Credit and Caption Support

*** Feature Added
Implemented ~#+IMAGE-CREDIT:~ and ~#+IMAGE-CAPTION:~ (or ~#+IMAGE-PROMPT:~) keywords for body images, mirroring the ~#+HERO-CREDIT:~ and ~#+HERO-CAPTION:~ support added to frontmatter.

*** Behavior
- Credit appears below image on page as small text
- Caption/prompt appears in PhotoSwipe lightbox when image is clicked
- Both appear in lightbox caption (credit in bold, caption in italics)
- Works with PhotoSwipe via ~data-pswp-item~ and ~data-pswp-caption~ attributes

*** Syntax
#+begin_src org
[[/path/to/image.jpg]]
#+IMAGE-CREDIT: Photographer Name
#+IMAGE-CAPTION: Description or AI prompt text
#+end_src

*** Output
#+begin_src html
<figure class="image-figure">
<a href={imgVar.src} data-pswp-item="true" data-pswp-caption="..." ...>
<Image src={imgVar} alt="..." layout="responsive" />
</a>
<figcaption class="image-caption text-xs text-gray-400 mt-2">
<span class="font-medium">Image:</span> Credit
</figcaption>
</figure>
#+end_src

*** Technical Details
- Added ~org-astro--collect-image-metadata-filter~ to parse tree filter chain
- Filter scans for IMAGE-CREDIT/CAPTION/PROMPT keywords following image paragraphs
- Uses normalized filename keys (~org-astro--normalize-image-key~) to handle path rewrites
- Keywords are suppressed from output (handled by image rendering instead)
- Hero images are correctly suppressed from body (credit/caption not rendered for suppressed hero)

*** Files Modified
- ox-astro-helpers.el (format-image-component, image-component-for-record, normalize-image-key)
- ox-astro-handlers.el (keyword suppression, collect-image-metadata-filter)
- ox-astro.el (filter chain registration)

** Session 2: Body Content Cleanup for org-roam Exports

*** Bugs Fixed

1. *Property drawer leaking into MDX body*
   - ~:ID:~ lines from ~:PROPERTIES:~ drawer appeared in rendered content
   - Added ~property-drawer~ transcoder to Astro backend (returns ~""~)
   - ID now only appears in frontmatter (~orgRoamId~), not body

2. *org-roam template boilerplate in body*
   - ~- **Links:**~ and ~- **Source:**~ lines exported as content
   - Added cleanup patterns to ~org-astro-final-output-filter~
   - Strips both bold list format (~- **Links:**~) and standalone (~Links:~)

*** Files Modified
- ox-astro.el (property-drawer handler in backend definition)
- ox-astro-handlers.el (Links/Source cleanup in final filter)

** Session 1: Debug Output Cleanup and Export Bug Fixes

*** Bugs Fixed

1. *ID map regex escaping bug*
   - Regex ~"\.org\'"~ in double-quoted strings becomes literal ~.org'~
   - Fixed to ~"\\.org\\'"~ for proper matching of .org files
   - Was causing "ID map built: 0 IDs" - all files were being skipped

2. *cl-return without cl-block errors*
   - ~(no-catch --cl-block-nil-- nil)~ errors during export
   - ~cl-return~ requires a named ~cl-block~, can't be used in ~cl-loop~ or ~dolist~
   - Fixed 3 instances using ~catch/throw~ pattern instead:
     - ~org-astro--ordered-item-number~ in ox-astro-handlers.el
     - Two functions in ox-astro-image-handlers.el

3. *Duplicate ID logging noise*
   - Added ~org-astro--duplicate-ids-logged~ flag to only log duplicate ID summary once per batch
   - Fixed tracker plist missing ~:id~ key (was showing ~nil~ instead of actual IDs)

4. *DEBUG message flooding*
   - Removed ~34 ungated DEBUG: messages from ox-astro-image-handlers.el
   - Messages weren't gated behind ~org-astro-debug-console~

*** Files Modified
- ox-astro-helpers.el (regex fix, duplicate logging)
- ox-astro-handlers.el (cl-return fix)
- ox-astro-image-handlers.el (cl-return fixes, DEBUG removal)

* 2025-11-28
** Session 2: Fix Elisp Parse Errors in ox-astro-helpers.el

*** Bugs Fixed
Three elisp parse errors that caused "End of file during parsing":

1. *with-temp-buffer scoping bug in =org-astro--get-org-roam-id=* (lines 1070-1074)
   - =goto-char= and =re-search-forward= were outside the =with-temp-buffer= form
   - They ran in the original buffer instead of the temp buffer containing file contents

2. *Same bug in =org-astro--get-roam-aliases=* (lines 1096-1101)
   - Identical issue with premature closing of =with-temp-buffer=

3. *Broken regex in =org-astro--contains-markdown-link-p=* (line 813)
   - Changed from =\\([^)]\\|\\n\\)+= to =[^)]+= (simpler, avoids parse issues)

4. *Broken regex in =org-astro--get-excerpt=* (line 987)
   - Changed from =\`\(.\{1,300\}?[.?!]\)= to =^\\(.\\{1,300\\}?[.?!]\\)=
   - Fixed missing closing paren for =when first-paragraph= form

*** Verification
- Ran =emacs --batch -f batch-byte-compile ox-astro-helpers.el=
- No syntax errors, only expected warnings (free variables from other modules, wide docstrings)

** Session 1: Per-Destination ID Link Routes and Metadata Fixes

*** Changes Made
- Fixed comma-separated list parsing to preserve internal spaces (e.g., =#+places: Brooklyn, Hungry Ghost Coffee= stays "Hungry Ghost Coffee" instead of stripping spaces)
- Added =filetags= passthrough into front matter =tags= (deduped with =TAGS=/=ASTRO_TAGS=)
- Added "conversation" to valid =story_type= values
- Implemented per-destination =:id-link-base-path= config option for absolute routes
- Added export-scoped =org-astro--current-id-link-base-path= so routing style is bound per destination, falling back to global then relative paths

*** Per-Destination ID Link Base Path
New =:id-link-base-path= option in destination config allows different routing styles per project:

#+begin_src emacs-lisp
(setq org-astro-known-posts-folders
      '(("roam-life" . (:path "/path/to/life-web/src/content/notes/"
                        :preserve-folder-structure t
                        :id-link-base-path "/notes"))  ; absolute routes
        ("socraticai" . (:path "/path/to/socratic/src/content/blog"))))  ; relative .mdx paths
#+end_src

Priority: destination config → global =org-astro-id-link-base-path= → nil (relative paths)

*** Verification
Re-exported =~/Dropbox/roam-life/stories/20251022-brooklyn-coffee-ai.org= and confirmed:
- [x] =places:= shows "Hungry Ghost Coffee" (spaces preserved)
- [x] =tags:= includes filetags (story, conversation, ai, career, purpose)
- [x] =storyType: conversation= now exports
- [x] ID links render as =/notes/characters/rachel= (absolute route)

** Handoff

*COMPLETED (Safe to rely on)*
- [x] List splitting preserves internal spaces in comma-separated items (=ox-astro-metadata.el=)
- [x] Filetags merged into front matter tags with deduplication (=ox-astro-metadata.el=)
- [x] "conversation" added to valid story types (=ox-astro-metadata.el=)
- [x] Per-destination =:id-link-base-path= config (=ox-astro.el=, =ox-astro-helpers.el=)
- [x] New dynamic var =org-astro--current-id-link-base-path= for export-scoped routing

*CONTEXT FOR NEXT SESSION*
- Files touched: =ox-astro-metadata.el=, =ox-astro-helpers.el=, =ox-astro.el=, =docs/instructions.org=

* 2025-11-26
** Session Summary: Add Responsive Images Support

Added =org-astro-image-default-layout= config to generate =<Image />= components with Astro 5.10+ responsive layout support.

*** Changes Made
- Added =org-astro-image-default-layout= defcustom in =ox-astro-config.el= (default: ="responsive"=)
- Updated =org-astro--format-image-component= in =ox-astro-helpers.el= to include layout prop
- Updated render map JSX generation in =ox-astro-image-handlers.el= for consistency
- Added 3 new tests: layout enabled, layout disabled (nil), layout disabled ("none")
- Updated =docs/instructions.org= with Image Configuration section
- Marked as DONE in =suggested-enhancements.org=

*** Usage
#+begin_src emacs-lisp
;; Default (responsive)
(setq org-astro-image-default-layout "responsive")

;; Disable responsive images
(setq org-astro-image-default-layout nil)
#+end_src

*** Output
#+begin_src jsx
// With layout="responsive" (default)
<Image src={myImage} alt="description" layout="responsive" />

// With layout disabled
<Image src={myImage} alt="description" />
#+end_src

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Config =org-astro-image-default-layout= in =ox-astro-config.el=
- [x] JSX generation updated in =ox-astro-helpers.el= and =ox-astro-image-handlers.el=
- [x] Tests: 4 image rendering tests passing, 6 ID link tests passing
- [x] Documentation in =docs/instructions.org=

*CONTEXT FOR NEXT SESSION*
- Files touched: =ox-astro-config.el=, =ox-astro-helpers.el=, =ox-astro-image-handlers.el=, =test-image-rendering.el=, =docs/instructions.org=

* 2025-11-26
** Session Summary: Add Absolute Route Mode for ID Links

Added new configuration option =org-astro-id-link-base-path= to support absolute routes for org-roam ID links, specifically for life-web project which uses =/notes/[...id].astro= routing.

*** Changes Made
- Added =org-astro-id-link-base-path= defcustom in =ox-astro-config.el=
- Added =org-astro--compute-collection-id= helper function in =ox-astro-helpers.el=
- Modified =org-astro-link= to check for absolute route mode and output =/base-path/collection-id= instead of relative =.mdx= paths
- Added =life-web= and =roam-life= to known posts folders config
- Added test =org-astro-id-link-absolute-route-mode= in =test-id-links.el=

*** Usage
#+begin_src emacs-lisp
(setq org-astro-id-link-base-path "/notes")
#+end_src

Now =[[id:char-001-mom][Mom]]= exports as =[Mom](/notes/characters/mom)= instead of =[Mom](../characters/mom.mdx)=.

*** Backward Compatibility
When =org-astro-id-link-base-path= is nil (default), behavior unchanged—relative MDX paths are produced.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] New config option =org-astro-id-link-base-path= in =ox-astro-config.el=
- [x] Helper =org-astro--compute-collection-id= in =ox-astro-helpers.el=
- [x] Modified =org-astro-link= for absolute route support
- [x] Test added and all 6 ID link tests passing
- [x] Documentation added to life-web and roam-life READMEs

*CONTEXT FOR NEXT SESSION*
- Files touched: =ox-astro-config.el=, =ox-astro-helpers.el=, =test-id-links.el=
- Related projects: life-web, roam-life

* 2025-11-26
** Session Summary: Fix narrowed export when point is deep
- Ensured narrowed exports anchor to region start for env/generation so full subtree exports even if cursor is far down.
- Added regression test exercising narrowed export with point at end of subtree; all tests passing.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Narrowed export now repositions before env collection and both export passes (`ox-astro.el`)
- [x] Regression test for deep-point narrowed export added (`test/date-title-and-subtree-test.el`)
- [x] Tests passing: `emacs -Q --batch -L . -l test/date-title-and-subtree-test.el -f ert-run-tests-batch-and-exit`

*CONTEXT FOR NEXT SESSION*
- Files touched: =ox-astro.el=, =test/date-title-and-subtree-test.el=
- No known follow-ups

* 2025-11-24
** Session Summary: Use SUBHED for Auto-Generated Excerpts
- Changed auto-inserted excerpt keyword from =#+EXCERPT:= to =#+SUBHED:= to match legacy convention.
- Both keywords map to the same =excerpt= front matter field in MDX output.
- Priority order unchanged: =ASTRO_EXCERPT= → =EXCERPT= → =SUBHED= → =DESCRIPTION= → fallback paragraph.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Modified =ox-astro.el:298= to insert =SUBHED= instead of =EXCERPT= when auto-generating
- [x] Added explanatory comment noting SUBHED is alias for excerpt

*CONTEXT FOR NEXT SESSION*
- Files touched: =ox-astro.el=
- No breaking changes—MDX output identical since both keywords map to =excerpt=

* 2025-11-15
** Session Summary: Formatting Issues Documentation
- Analyzed exported MDX output from goal tracking blog post to identify systematic formatting problems in the ox-astro exporter.
- Documented 5 major formatting issues: escaped org-mode markers, orphaned code block closers, double-encoded timestamps, nested code block confusion, and malformed list numbering.
- Created comprehensive issue report with line numbers, examples, root causes, and suggested fixes at [[file:formatting-issues-2025-11-15.org][formatting-issues-2025-11-15.org]].
- Issues prioritized into High Priority (breaking code block structure) and Medium Priority (visual/semantic problems).

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Full formatting analysis completed on real-world export output
- [x] Documentation created with links to source org file and MDX output for reference
- [x] 5 issues identified with detailed before/after examples and line numbers
- [x] Priority recommendations and testing suggestions provided
- [x] Test case specifications written for future regression testing

*IN-PROGRESS (Requires completion)*
- [ ] Fix Issue #1: Escaped org-mode markers with trailing underscores (=\#+begin_src_= → =#+begin_src=)
- [ ] Fix Issue #2: Orphaned =#+end_src_= closing markers appearing without opening markers
- [ ] Fix Issue #4: Nested code block confusion (code examples containing code blocks)
- [ ] Fix Issue #5: Malformed nested list numbering (flattened hierarchy)
- [ ] Fix Issue #3: Double-encoded HTML timestamps (lower priority)

*CONTEXT FOR NEXT SESSION*
- Files to review: [[file:formatting-issues-2025-11-15.org][formatting-issues-2025-11-15.org]]
- Test files referenced:
  - Source: [[file:/Users/jay/Dropbox/roam/chatgpt-outputs/20251030123203-claude_designs_a_goal_tracking_system.org][20251030123203-claude_designs_a_goal_tracking_system.org]]
  - Output: [[file:/Users/jay/Library/CloudStorage/Dropbox/github/astro-monorepo/apps/anthropic/src/content/blog/claude-designs-a-goal-tracking-system.mdx][claude-designs-a-goal-tracking-system.mdx]]
- Known unknowns: Root cause likely in =ox-astro-src-block= and =org-astro-src-block= functions; need to investigate code block nesting tracking
- Recommendations:
  - Start with Issues #1, #2, #4 (all related to code block handling) as they share common root cause
  - Create test file with nested code blocks and org-mode examples before fixing
  - Issue #5 (list numbering) is separate concern in list export logic

* 2025-11-13
** Session Summary: Link Conversion in User Blocks
- Fixed bug where org-mode links inside `user`, `prompt`, and `quote` blocks were being exported in raw org-mode format (`[[link][text]]`) instead of being converted to Markdown format (`[text](link)`).
- Enhanced `org-astro-src-block` function to convert org-mode links to Markdown during special block processing.
- Link conversion now handles both forms: `[[path][description]]` → `[description](path)` and `[[path]]` → `[path](path)`.
- This conversion happens alongside existing transformations (em dashes, org headings) for these special blocks.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Link conversion regex added to `org-astro-src-block` for `user`, `prompt`, and `quote` blocks (`ox-astro-helpers.el:1206-1216`)
- [x] Tested with real export file - links now correctly convert to Markdown format in user blocks
- [x] Verified git diff shows correct Markdown link output

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`
- Known unknowns: None - feature is complete and tested
- Recommendations: None

** Previous Session: Destination Keyword Alias
- Added `#+DESTINATION` as a shorter alias for `#+DESTINATION_FOLDER` and `#+DESTINATION-FOLDER`, providing users with a more concise option for specifying export destinations.
- Updated all regex patterns across the codebase to recognize all three forms: `#+DESTINATION_FOLDER:`, `#+DESTINATION-FOLDER:`, and `#+DESTINATION:`.
- Enhanced keyword preservation logic to maintain user's preferred format when updating existing destination keywords.
- Updated documentation across README, concept map, and config files to reflect the new shorter alias.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Regex patterns updated in three locations to support `#+DESTINATION:` (`ox-astro-helpers.el:399`, `update-image-paths.el:76`, `ox-astro.el:345`)
- [x] Keyword preservation logic enhanced to handle all three format variants (`ox-astro.el:348-351`)
- [x] Documentation updated: `README.org:82,129`, `docs/concept-map.org:80`, `ox-astro-config.el:16,53,61`
- [x] Regex tests created and passing for all three keyword variants

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `update-image-paths.el`, `ox-astro.el`, `README.org`, `docs/concept-map.org`, `ox-astro-config.el`
- Known unknowns: None - feature is complete and tested
- Recommendations: Consider adding to CHANGE-LOG.org if this warrants a version bump or release note

* 2025-10-30
** Session Summary
- Added `#+SUBHED` as an accepted excerpt keyword so Org sources can map legacy decks into MDX front matter without duplication.
- Refreshed metadata documentation (design architecture, concept map) and recorded the behavior change in the change log.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Excerpt priority now considers `ASTRO_EXCERPT`, `EXCERPT`, `SUBHED`, `DESCRIPTION`, then paragraph fallback (`ox-astro-helpers.el:887-905`).
- [x] Documentation updates: `docs/design-architecture.org:152-168`, `docs/concept-map.org:99-106`, `CHANGE-LOG.org:5-15`.

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `docs/design-architecture.org`, `docs/concept-map.org`, `CHANGE-LOG.org`
- Known unknowns: Need an export smoke test confirming SUBHED usage emits `excerpt` as expected.
- Recommendations: Export a representative Org note using `#+SUBHED` to verify front matter output.

* 2025-10-26
** Session Summary
- Exporter now preserves `#+MEDIA`, `#+INCOMPLETE`, and the connection keywords so regenerated MDX matches the enriched schema in life-web.
- Front-matter generator learned how to embed nested YAML blocks, enabling us to emit the `connections` map without rewriting the serializer.
- Metadata parsers gained normalization for attachment lists and boolean draft flags, keeping input tolerance consistent with other list fields.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Keyword plumbing (`ox-astro.el:560-596`) covers media, incomplete, and connection variants alongside existing metadata.
- [x] Parsers for media/incomplete/connections added to `ox-astro-metadata.el:160-225`, trimming empty items and coercing booleans.
- [x] Front-matter assembly & YAML output updated to handle raw nested blocks (`ox-astro-helpers.el:774-990`).
- [x] Work log updated; standalone `CHANGE-LOG.org` entry removed per guidance.

*IN-PROGRESS (Requires completion)*
- [ ] Run an end-to-end export on representative notes to confirm the new fields align with life-web ingestion (attachments, draft flags, connections).

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro.el`, `ox-astro-metadata.el`, `ox-astro-helpers.el`
- Known unknowns: No automated fixture yet for nested connection emission; consider adding an ERT around `org-astro--format-connections-yaml`.
- Recommendations: Re-export one of the new story org files and verify `media`, `incomplete`, and `connections` materialize correctly in the MDX front matter.

* 2025-10-22
** Session Summary
- Enabled `#+DESTINATION-FOLDER` as a synonym for `#+DESTINATION_FOLDER` across the exporter and tooling.
- Normalized destination keyword detection in helper scripts and refreshed documentation to advertise both forms.
- Logged the change in CHANGE-LOG with guidance on pending test coverage.
- Updated ID link guidance and fixtures to demonstrate Markdown links with preserved directory structure.
- Refreshed operational instructions with the Markdown link behavior for org-roam exports.

** Handoff

- [x] Destination keyword aliasing implemented: `ox-astro.el:97`, `ox-astro-helpers.el:211`
- [x] Auto-insert preserves user delimiter and absorptive docs updated: `ox-astro.el:309`, `README.org:82`, `docs/concept-map.org:80`
- [x] Tooling aware of both forms (`update-image-paths.el:72`, config docs)
- [x] Change log entry added: `CHANGE-LOG.org:5`
- [x] ID link docs/tests reinforced Markdown relative outputs: `docs/lab/org-roam-links.org`, `test-id-links.el`, `test-files/id-links/*`
- [x] Instructions updated to highlight Markdown link outputs: `docs/instructions.org:15`
- [x] Absolute-path destinations now populate ID map metadata: `ox-astro-helpers.el:181`, `test-id-links.el`
- [x] Source-root detection auto-falls back to the note's org-roam vault, keeping ID links working even when exporting from another profile: `ox-astro-helpers.el:339`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro.el`, `ox-astro-helpers.el`, `update-image-paths.el`, documentation set
- Known unknowns: Automated regression suite beyond `test-id-links.el` not re-run; alias relies on shared keyword helper
- Recommendations: Export a sample Org file using `#+DESTINATION-FOLDER:` and run `emacs --batch -Q -l test-id-links.el -f ert-run-tests-batch-and-exit`

* 2025-11-15
** Session Summary
- Hardened the destination-folder resolution in `org-astro-prepare-images-filter` so whitespace-laden nicknames reuse the same helper as the main exporter.
- Replaced the regex-based hero suppression with a multi-line safe removal helper and tightened the MDX final-output filter to respect code fences and list continuations.
- Added regression ERTs covering fenced-code + list indentation handling and ensured the test harness loads the repo modules reliably.
- Taught the list transcoder to keep dash bullets nested under numbered items and documented the verification in `formatting-issues-2025-11-15.org`.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Shared destination resolution + info plists updated: `ox-astro-handlers.el:60-110`
- [x] Hero component removal recognizes multi-line Image tags: `ox-astro-handlers.el:140-170`
- [x] Final output filter skips code fences/lists + new tests added: `ox-astro-handlers.el:240-320`, `test/image-pipeline-test.el:1-124`
- [x] Inline dash bullets stay nested with updated translator + regression test: `ox-astro-handlers.el:40-120, 140-210`, `test/image-pipeline-test.el:101-140`

*IN-PROGRESS (Requires completion)*
- [ ] Gallery regression fixture (`test/gallery_test_rigorous.expected.mdx`) no longer matches exporter output; needs refresh or relaxed assertions.

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-handlers.el`, `test/image-pipeline-test.el`
- Known unknowns: Gallery snapshot diverges (extra Image import, column props, missing legacy images). Decide whether to update expected MDX or adjust exporter to retain prior behavior.
- Recommendations: Re-run `emacs --batch -Q -l ert -l test/image-pipeline-test.el -f ert-run-tests-batch-and-exit` after reconciling the gallery fixture; confirm hero-image removal still suppresses duplicates in real posts.

* 2025-10-20
** Session Summary
- ID links disappearing traced to user hook `org-export-id-link-removal` running during export copy.
- Added hook sanitization helper and wrapped Astro exports so blocklisted hooks are removed.
- Documented investigation resolution and added regression test for hook scrubbing.
- Lesson learned: when a feature works locally but fails for the user, inspect their hooks/config before blaming exporter internals.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Hook sanitization macro + export wrappers: `ox-astro.el:69`
- [x] Regression test `org-astro-export-sanitizes-id-stripping-hooks`: `test-id-links.el:113`
- [x] Investigation doc updated with root cause and fix: `docs/INVESTIGATION-id-links-stripped.org:285`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro.el`, `test-id-links.el`, `docs/INVESTIGATION-id-links-stripped.org`
- Known unknowns: Need live export from org-roam vault to confirm hook sanitization covers whole pipeline.
- Recommendations: Verify no other user hooks in init files rewrite links or other elements during export.

* 2025-10-10
** Session Summary
- Added DESCRIPTION keyword as fallback for EXCERPT in front matter generation
- Updated excerpt extraction logic to check EXCERPT first, then DESCRIPTION, then first paragraph
- Updated documentation in concept-map.org, design-architecture.org, and CHANGE-LOG.org

** Handoff

*COMPLETED (Safe to rely on)*
- [x] DESCRIPTION fallback implemented: `ox-astro-helpers.el:392-414`
- [x] Priority order: ASTRO_EXCERPT → EXCERPT → DESCRIPTION → first paragraph
- [x] Documentation updated: `docs/concept-map.org:103`, `docs/design-architecture.org:161`
- [x] Change log entry added: `CHANGE-LOG.org:5-29`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `docs/concept-map.org`, `docs/design-architecture.org`, `CHANGE-LOG.org`
- Known unknowns: None - feature is complete and self-contained
- Recommendations:
  - Test with an org file that has both DESCRIPTION and EXCERPT to verify priority works correctly
  - Consider whether README.org needs updating (currently skipped per user request)

* 2025-10-07
** Session Summary
- Updated table cell sanitization to wrap generic type signatures and normalize `<br>` tags for MDX compatibility.
- Normalized `<br>` tags during final output filtering to avoid Astro parse errors.
- Re-exported `guide-to-codex.org` to regenerate the Socratic blog post.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Generic type cells wrapped in inline code: `ox-astro-table-handlers.el`
- [x] `<br>` normalization added to final output filter: `ox-astro-handlers.el`
- [x] Export refreshed: `/Users/jay/Library/CloudStorage/Dropbox/github/astro-monorepo/apps/socratic/src/content/blog/guide-to-codex-cli.mdx`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-table-handlers.el`, `ox-astro-handlers.el`
- Known unknowns: Consider whether other HTML fragments (e.g., `<hr>`, `<img>`) need similar normalization.
- Recommendations: Review latest generated MDX in Astro dev server to confirm no additional JSX parse errors.

* 2025-11-26
** Session Summary
- Added custom `org-astro-underline` transcoder so placeholder underscores (3+) round-trip without emitting underline spans; other underlined text now exports as plain text.
- Wired underline transcoder into backend and removed final-output hack; front matter now also includes slug for consistency.
- Re-exported `tip_of_the_tongue.org` → `apps/socratic/src/content/blog/tip-of-the-tongue.mdx` to verify underscores stay literal.

* 2025-12-03
** Session Summary
- Added org-roam metadata to exported frontmatter: `orgRoamId`, `aliases`, and `orgPath` now emit from `ox-astro-helpers.el` (pulling from properties/keywords with file scan fallback).
- Hardened excerpt extractor to reduce paren errors; fixed helper parens and ensured file loads cleanly.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Frontmatter now includes org-roam ID/aliases/path for link resolution: `ox-astro-helpers.el`
- [x] Paren/scan errors resolved; file parses and loads cleanly.

*IN-PROGRESS (Requires completion)*
- [ ] Re-export content to pick up orgRoamId/aliases/orgPath in MDX outputs.

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `docs/work-log.org`
- Recommendations:
  - Re-export representative notes to verify org-roam fields appear.
  - Use the new metadata in link conversion/downstream index.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Underline handling fixed via `org-astro-underline`; spans no longer emitted for placeholders.
- [x] Front matter includes slug in generated data.
- [x] Post re-exported with correct placeholders: `apps/socratic/src/content/blog/tip-of-the-tongue.mdx`.

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `ox-astro.el`, `apps/socratic/src/content/blog/tip-of-the-tongue.mdx`
- Known unknowns: None observed; image copy warning is harmless (source/dest identical).
- Recommendations: If other posts use underline placeholders, re-export after pulling changes.

* 2025-11-29
** Session Summary: Clipboard Copy Opt-In and Paren Fixes

*** Changes Made
- Made clipboard copying opt-in via `org-astro-copy-to-clipboard` defcustom (defaults to nil)
- Fixed paren imbalance in `org-export-define-derived-backend` call that caused export to return nil
- Reverted to commit 1128b61 to restore working baseline after multiple paren issues

*** Clipboard Copy Behavior
The exporter previously copied source/output/debug paths to macOS clipboard via `pbcopy` on every export. This is now controlled by:

#+begin_src emacs-lisp
(setq org-astro-copy-to-clipboard t)  ; Enable clipboard copying
#+end_src

Default is nil (disabled). When enabled, paths are copied to clipboard after export completes.

*** Files Modified
- `ox-astro.el` - Added `org-astro-copy-to-clipboard` defcustom, fixed paren balance
- `ox-astro-helpers.el` - Guarded pbcopy calls at lines 257-265 and 307-315
- `ox-astro-handlers.el` - Guarded pbcopy call at lines 249-256

*** Commits
- `915bc4e` - Guard clipboard copies behind org-astro-copy-to-clipboard
- `8547ec8` - Fix paren imbalance in debug clipboard guard

** Handoff

* 2025-11-30 Fix ID Map Building (Critical Bug)
** Summary
Fixed critical bug where the ID map was always empty (0 IDs), causing all cross-file ID links to be reported as broken even though the target files existed.

*** Root Cause
The regex in `directory-files-recursively` was malformed:
#+begin_src emacs-lisp
;; BROKEN - single backslashes in double-quoted string
(directory-files-recursively root "\.org\'")
;; This became literal ".org'" - matching no files

;; FIXED - proper escaping
(directory-files-recursively root "\\.org\\'")
;; This correctly matches files ending in .org
#+end_src

*** Additional Fix
Also added fallback so files without `#+DESTINATION_FOLDER` use the first entry in `org-astro-known-posts-folders`, ensuring all IDs map to an outfile.

*** Symptoms
- `[ox-astro] ID map built: 0 IDs from root /Users/jay/dropbox/roam`
- All ID links reported as broken despite target files existing
- org-id separately reported "691 files scanned, 728 IDs found" (different system)

** Files
- `ox-astro-helpers.el` - Fixed regex, added destination fallback, added debug logging

** Lesson Learned
In Emacs Lisp, regex special sequences like `\'` (end of string) require double backslashes in double-quoted strings: `"\\'"`. Single backslashes are consumed by the string parser, leaving just `'`.

* 2025-11-30 Strip ID drawers and org-roam boilerplate from body

** Session 3: Regex Fix for Links/Source Stripping

*** Bug Fixed
The regex pattern for stripping org-roam template boilerplate wasn't matching actual output.

*Problem:* Actual export output has colon inside bold markers:
#+begin_example
    -   **Links:**
    -   **Source:**
#+end_example

Original regex expected colon after bold: =**Links**:=. Fixed to handle colon inside or outside:

#+begin_src emacs-lisp
;; Before (broken)
"^[ \t]*-[ \t]+\\*\\*\\(Links\\|Source\\)\\*\\*[ \t]*::?[ \t]*\n?"

;; After (fixed)
"^[ \t]*-[ \t]+\\*\\*\\(Links\\|Source\\):?\\*\\*[ \t]*:?[ \t]*\n?"
#+end_src

*** Verification
Re-exported MDX files now have clean body content:
- ✅ No =:ID:= lines (property drawer fix working)
- ✅ No =- **Links:**= boilerplate
- ✅ No =- **Source:**= boilerplate

*** Files Modified
- =ox-astro-handlers.el= (line 356 - regex pattern fix)

** Session 2: Body Content Cleanup for org-roam Exports
- Strip PROPERTIES drawer output and org-roam boilerplate from MDX bodies
- Keep IDs only in frontmatter (add property-drawer translator + final body cleanup)
- Addresses leaked =:ID:= lines like in journal/monday-february-12-2024.mdx

* 2025-12-01 Remote image URL rewrite

** Fix: rewrite remote links to downloaded paths
- Added remote link handling in `org-astro--update-image-path-in-buffer` so `[[https://...]]` / `[[http://...]]` / `[[//...]]` get rewritten to the downloaded local asset path, matching the behavior for local image links.

** Files Modified
- =ox-astro-image-handlers.el= — remote link replacement now supported during source rewrite.

** Verification
- Manual: export an Org file with a remote image link; confirm image downloads to `assets/images/posts/{slug}/` and the Org source link is updated to the local path.

* 2025-12-12 Add :repeat attribute for hero images

** Feature: Allow hero images to also render inline
When an image is used as the hero/frontmatter image, ox-astro normally removes it from the body to avoid duplication. The new =:repeat t= attribute allows intentional repetition.

** Usage
#+begin_src org
#+ATTR_ORG: :width 300 :repeat t
[[/path/to/image.jpg]]
#+end_src

When =:repeat t= is set, the image appears both:
1. As the hero image in frontmatter
2. Inline in the content body

** Implementation
1. Added =org-astro--get-link-repeat-attr= function to parse =:repeat t= from =#+ATTR_ORG=
2. Modified link processing in =org-astro--build-image-manifest= to capture the =:repeat= attribute
3. Propagated =:repeat= through =org-astro--process-image-manifest= to processed entries
4. Added =:repeat= to render records in =org-astro--build-render-map=
5. Modified hero removal logic in =ox-astro-handlers.el= to skip removal when =:repeat t=

** Files Modified
- =ox-astro-image-handlers.el= — attribute parsing and propagation
- =ox-astro-handlers.el= — conditional hero removal (line 370)

** Verification
- Exported org file with =:repeat t= on first image
- Confirmed MDX contains both frontmatter =image:= reference AND inline =<Image>= component
- Built Astro site and verified HTML output shows image inline

* 2025-12-31 Fix theme/model banner placement and doc-level detection

** Summary
Tightened document-level keyword detection to mean "before any body content",
normalized theme/model emission for multi-AI posts, and ensured doc-level MODEL
banners do not float above inline theme markers.

** Changes
- Added body-aware helpers to detect the first real body element, count unique
  THEME values, and detect inline MODEL keywords.
- Document-level THEME now promotes to frontmatter only for single-theme posts.
- Document-level MODEL banners are skipped when inline MODEL keywords exist.
- MODEL banners are inserted after any leading inline theme marker.
- Keywords under headline sections are never treated as document-level.

** Files Modified
- =ox-astro-helpers.el= — body-position helpers + doc-level detection changes
- =ox-astro-handlers.el= — theme/model emission and banner placement logic
- =docs/bugs/document-level-model-banner.org= — updated rules and fixes

** Verification
- Re-exported socratic posts and checked:
  - =tip-of-the-tongue.mdx= — banner now appears inside the first theme section
  - =consciousness-as-an-emergent-phenomenon.mdx= — banner follows the theme marker
  - =how-to-use-ai-to-understand-shakespeare.mdx= — no duplicate theme markers
  - =sinners.mdx= — no orphan theme marker at top; single Claude banner before heading

** Follow-up Fix: Numeric frontmatter encoding
- Adjusted YAML scalar encoding so numeric values are emitted unquoted.
- Fixes Astro content schema errors like =tocDepth= being written as a string.

** Files Modified (follow-up)
- =ox-astro-helpers.el= — numeric scalar encoding now outputs plain numbers

** Follow-up Fix: Theme+Model adjacency emission
- Emit MODEL immediately after THEME when adjacent in the same section, even
  without headings; mark MODEL as consumed to avoid duplicate banners.
- Corrected a parenthesis imbalance introduced in the THEME adjacency loop.

** Files Modified (follow-up)
- =ox-astro-handlers.el= — theme/model adjacency emission + paren fix

** Verification (follow-up)
- =tip-of-the-tongue.mdx= now renders theme marker + model banner adjacent in
  headingless sections (no floating banner, no duplicates).

* 2026-01-01 Remote image download validation and extension normalization

** Summary
Hardened remote image downloads to avoid auth prompts and HTML error pages, and
normalized file extensions based on detected content.

** Changes
- Prefer curl for downloads (fails cleanly on 4xx/5xx); fall back to url.el.
- Validate downloaded files via magic bytes + HTML sniffing; delete invalid files.
- Normalize file extensions to avoid =.png.jpg= / =.webp.jpg= mismatches.
- Case-insensitive image extension matching for remote URLs.
- Documented the new validation approach and logged the gotcha.

** Files Modified
- =ox-astro-image-handlers.el=
- =docs/image-download-validation.org=
- =docs/codebase-wisdom.org=

** Verification
- Not run in this session.

** Follow-up
- Logged remote download test results in =docs/image-download-validation.org= and marked tests complete.

** Follow-up: Normalize double extensions
- Collapsed chained image extensions (e.g., =.png.webp= -> =.webp=) during download normalization.
- Expanded normalization to existing local asset files and local copies.
- Batch test: temp WebP header renamed via =org-astro--normalize-existing-image-extension=.

* 2026-01-01 HERO_IMAGE keyword support

** Summary
Added explicit =HERO_IMAGE= / =HERO_IMAGE_ALT= keywords so authors can set the
hero image independently from the first inline image.

** Changes
- HERO_IMAGE takes precedence over COVER_IMAGE/ASTRO_IMAGE and the first inline image.
- HERO_IMAGE_ALT overrides derived alt text for the frontmatter image.
- Documented the new keywords in usage docs.
- Added an ERT test to lock in HERO_IMAGE behavior.

** Files Modified
- =ox-astro.el=
- =ox-astro-helpers.el=
- =docs/hero-image-keyword.org=
- =docs/instructions.org=
- =test/image-pipeline-test.el=

** Verification
- =emacs --batch -Q -l ert -l test/image-pipeline-test.el --eval "(ert-run-tests-batch 'ox-astro-hero-image-keyword-test)"=

* 2026-01-01 Reload guidance for local development

** Summary
Documented a hardened =ox-astro-reload= helper to avoid stale modules when
reloading ox-astro during development.

** Changes
- Added a reload snippet with =load-prefer-newer= and explicit =require= calls.

** Files Modified
- =docs/instructions.org=

** Verification
- Not run in this session.
