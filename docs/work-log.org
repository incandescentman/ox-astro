#+TITLE: ox-astro Work Log
#+DATE: 2025-10-07

* 2025-12-03
** Session: YouTube embed + hide hero flag

*** Summary
- Added responsive YouTube embedding via =#+YOUTUBE:= keyword (also catches bare YouTube URLs) emitting 16:9 iframe markup
- Plumbed =HIDE_HERO_IMAGE= frontmatter keyword through options/frontmatter to hide hero on detail pages while keeping list thumbnails

*** Files Modified
- ox-astro-helpers.el
- ox-astro-handlers.el
- ox-astro.el

* 2025-11-30
** Session 3: Image Credit and Caption Support

*** Feature Added
Implemented ~#+IMAGE-CREDIT:~ and ~#+IMAGE-CAPTION:~ (or ~#+IMAGE-PROMPT:~) keywords for body images, mirroring the ~#+HERO-CREDIT:~ and ~#+HERO-CAPTION:~ support added to frontmatter.

*** Behavior
- Credit appears below image on page as small text
- Caption/prompt appears in PhotoSwipe lightbox when image is clicked
- Both appear in lightbox caption (credit in bold, caption in italics)
- Works with PhotoSwipe via ~data-pswp-item~ and ~data-pswp-caption~ attributes

*** Syntax
#+begin_src org
[[/path/to/image.jpg]]
#+IMAGE-CREDIT: Photographer Name
#+IMAGE-CAPTION: Description or AI prompt text
#+end_src

*** Output
#+begin_src html
<figure class="image-figure">
<a href={imgVar.src} data-pswp-item="true" data-pswp-caption="..." ...>
<Image src={imgVar} alt="..." layout="responsive" />
</a>
<figcaption class="image-caption text-xs text-gray-400 mt-2">
<span class="font-medium">Image:</span> Credit
</figcaption>
</figure>
#+end_src

*** Technical Details
- Added ~org-astro--collect-image-metadata-filter~ to parse tree filter chain
- Filter scans for IMAGE-CREDIT/CAPTION/PROMPT keywords following image paragraphs
- Uses normalized filename keys (~org-astro--normalize-image-key~) to handle path rewrites
- Keywords are suppressed from output (handled by image rendering instead)
- Hero images are correctly suppressed from body (credit/caption not rendered for suppressed hero)

*** Files Modified
- ox-astro-helpers.el (format-image-component, image-component-for-record, normalize-image-key)
- ox-astro-handlers.el (keyword suppression, collect-image-metadata-filter)
- ox-astro.el (filter chain registration)

** Session 2: Body Content Cleanup for org-roam Exports

*** Bugs Fixed

1. *Property drawer leaking into MDX body*
   - ~:ID:~ lines from ~:PROPERTIES:~ drawer appeared in rendered content
   - Added ~property-drawer~ transcoder to Astro backend (returns ~""~)
   - ID now only appears in frontmatter (~orgRoamId~), not body

2. *org-roam template boilerplate in body*
   - ~- **Links:**~ and ~- **Source:**~ lines exported as content
   - Added cleanup patterns to ~org-astro-final-output-filter~
   - Strips both bold list format (~- **Links:**~) and standalone (~Links:~)

*** Files Modified
- ox-astro.el (property-drawer handler in backend definition)
- ox-astro-handlers.el (Links/Source cleanup in final filter)

** Session 1: Debug Output Cleanup and Export Bug Fixes

*** Bugs Fixed

1. *ID map regex escaping bug*
   - Regex ~"\.org\'"~ in double-quoted strings becomes literal ~.org'~
   - Fixed to ~"\\.org\\'"~ for proper matching of .org files
   - Was causing "ID map built: 0 IDs" - all files were being skipped

2. *cl-return without cl-block errors*
   - ~(no-catch --cl-block-nil-- nil)~ errors during export
   - ~cl-return~ requires a named ~cl-block~, can't be used in ~cl-loop~ or ~dolist~
   - Fixed 3 instances using ~catch/throw~ pattern instead:
     - ~org-astro--ordered-item-number~ in ox-astro-handlers.el
     - Two functions in ox-astro-image-handlers.el

3. *Duplicate ID logging noise*
   - Added ~org-astro--duplicate-ids-logged~ flag to only log duplicate ID summary once per batch
   - Fixed tracker plist missing ~:id~ key (was showing ~nil~ instead of actual IDs)

4. *DEBUG message flooding*
   - Removed ~34 ungated DEBUG: messages from ox-astro-image-handlers.el
   - Messages weren't gated behind ~org-astro-debug-console~

*** Files Modified
- ox-astro-helpers.el (regex fix, duplicate logging)
- ox-astro-handlers.el (cl-return fix)
- ox-astro-image-handlers.el (cl-return fixes, DEBUG removal)

* 2025-11-28
** Session 2: Fix Elisp Parse Errors in ox-astro-helpers.el

*** Bugs Fixed
Three elisp parse errors that caused "End of file during parsing":

1. *with-temp-buffer scoping bug in =org-astro--get-org-roam-id=* (lines 1070-1074)
   - =goto-char= and =re-search-forward= were outside the =with-temp-buffer= form
   - They ran in the original buffer instead of the temp buffer containing file contents

2. *Same bug in =org-astro--get-roam-aliases=* (lines 1096-1101)
   - Identical issue with premature closing of =with-temp-buffer=

3. *Broken regex in =org-astro--contains-markdown-link-p=* (line 813)
   - Changed from =\\([^)]\\|\\n\\)+= to =[^)]+= (simpler, avoids parse issues)

4. *Broken regex in =org-astro--get-excerpt=* (line 987)
   - Changed from =\`\(.\{1,300\}?[.?!]\)= to =^\\(.\\{1,300\\}?[.?!]\\)=
   - Fixed missing closing paren for =when first-paragraph= form

*** Verification
- Ran =emacs --batch -f batch-byte-compile ox-astro-helpers.el=
- No syntax errors, only expected warnings (free variables from other modules, wide docstrings)

** Session 1: Per-Destination ID Link Routes and Metadata Fixes

*** Changes Made
- Fixed comma-separated list parsing to preserve internal spaces (e.g., =#+places: Brooklyn, Hungry Ghost Coffee= stays "Hungry Ghost Coffee" instead of stripping spaces)
- Added =filetags= passthrough into front matter =tags= (deduped with =TAGS=/=ASTRO_TAGS=)
- Added "conversation" to valid =story_type= values
- Implemented per-destination =:id-link-base-path= config option for absolute routes
- Added export-scoped =org-astro--current-id-link-base-path= so routing style is bound per destination, falling back to global then relative paths

*** Per-Destination ID Link Base Path
New =:id-link-base-path= option in destination config allows different routing styles per project:

#+begin_src emacs-lisp
(setq org-astro-known-posts-folders
      '(("roam-life" . (:path "/path/to/life-web/src/content/notes/"
                        :preserve-folder-structure t
                        :id-link-base-path "/notes"))  ; absolute routes
        ("socraticai" . (:path "/path/to/socratic/src/content/blog"))))  ; relative .mdx paths
#+end_src

Priority: destination config → global =org-astro-id-link-base-path= → nil (relative paths)

*** Verification
Re-exported =~/Dropbox/roam-life/stories/20251022-brooklyn-coffee-ai.org= and confirmed:
- [x] =places:= shows "Hungry Ghost Coffee" (spaces preserved)
- [x] =tags:= includes filetags (story, conversation, ai, career, purpose)
- [x] =storyType: conversation= now exports
- [x] ID links render as =/notes/characters/rachel= (absolute route)

** Handoff

*COMPLETED (Safe to rely on)*
- [x] List splitting preserves internal spaces in comma-separated items (=ox-astro-metadata.el=)
- [x] Filetags merged into front matter tags with deduplication (=ox-astro-metadata.el=)
- [x] "conversation" added to valid story types (=ox-astro-metadata.el=)
- [x] Per-destination =:id-link-base-path= config (=ox-astro.el=, =ox-astro-helpers.el=)
- [x] New dynamic var =org-astro--current-id-link-base-path= for export-scoped routing

*CONTEXT FOR NEXT SESSION*
- Files touched: =ox-astro-metadata.el=, =ox-astro-helpers.el=, =ox-astro.el=, =docs/instructions.org=

* 2025-11-26
** Session Summary: Add Responsive Images Support

Added =org-astro-image-default-layout= config to generate =<Image />= components with Astro 5.10+ responsive layout support.

*** Changes Made
- Added =org-astro-image-default-layout= defcustom in =ox-astro-config.el= (default: ="responsive"=)
- Updated =org-astro--format-image-component= in =ox-astro-helpers.el= to include layout prop
- Updated render map JSX generation in =ox-astro-image-handlers.el= for consistency
- Added 3 new tests: layout enabled, layout disabled (nil), layout disabled ("none")
- Updated =docs/instructions.org= with Image Configuration section
- Marked as DONE in =suggested-enhancements.org=

*** Usage
#+begin_src emacs-lisp
;; Default (responsive)
(setq org-astro-image-default-layout "responsive")

;; Disable responsive images
(setq org-astro-image-default-layout nil)
#+end_src

*** Output
#+begin_src jsx
// With layout="responsive" (default)
<Image src={myImage} alt="description" layout="responsive" />

// With layout disabled
<Image src={myImage} alt="description" />
#+end_src

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Config =org-astro-image-default-layout= in =ox-astro-config.el=
- [x] JSX generation updated in =ox-astro-helpers.el= and =ox-astro-image-handlers.el=
- [x] Tests: 4 image rendering tests passing, 6 ID link tests passing
- [x] Documentation in =docs/instructions.org=

*CONTEXT FOR NEXT SESSION*
- Files touched: =ox-astro-config.el=, =ox-astro-helpers.el=, =ox-astro-image-handlers.el=, =test-image-rendering.el=, =docs/instructions.org=

* 2025-11-26
** Session Summary: Add Absolute Route Mode for ID Links

Added new configuration option =org-astro-id-link-base-path= to support absolute routes for org-roam ID links, specifically for life-web project which uses =/notes/[...id].astro= routing.

*** Changes Made
- Added =org-astro-id-link-base-path= defcustom in =ox-astro-config.el=
- Added =org-astro--compute-collection-id= helper function in =ox-astro-helpers.el=
- Modified =org-astro-link= to check for absolute route mode and output =/base-path/collection-id= instead of relative =.mdx= paths
- Added =life-web= and =roam-life= to known posts folders config
- Added test =org-astro-id-link-absolute-route-mode= in =test-id-links.el=

*** Usage
#+begin_src emacs-lisp
(setq org-astro-id-link-base-path "/notes")
#+end_src

Now =[[id:char-001-mom][Mom]]= exports as =[Mom](/notes/characters/mom)= instead of =[Mom](../characters/mom.mdx)=.

*** Backward Compatibility
When =org-astro-id-link-base-path= is nil (default), behavior unchanged—relative MDX paths are produced.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] New config option =org-astro-id-link-base-path= in =ox-astro-config.el=
- [x] Helper =org-astro--compute-collection-id= in =ox-astro-helpers.el=
- [x] Modified =org-astro-link= for absolute route support
- [x] Test added and all 6 ID link tests passing
- [x] Documentation added to life-web and roam-life READMEs

*CONTEXT FOR NEXT SESSION*
- Files touched: =ox-astro-config.el=, =ox-astro-helpers.el=, =test-id-links.el=
- Related projects: life-web, roam-life

* 2025-11-26
** Session Summary: Fix narrowed export when point is deep
- Ensured narrowed exports anchor to region start for env/generation so full subtree exports even if cursor is far down.
- Added regression test exercising narrowed export with point at end of subtree; all tests passing.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Narrowed export now repositions before env collection and both export passes (`ox-astro.el`)
- [x] Regression test for deep-point narrowed export added (`test/date-title-and-subtree-test.el`)
- [x] Tests passing: `emacs -Q --batch -L . -l test/date-title-and-subtree-test.el -f ert-run-tests-batch-and-exit`

*CONTEXT FOR NEXT SESSION*
- Files touched: =ox-astro.el=, =test/date-title-and-subtree-test.el=
- No known follow-ups

* 2025-11-24
** Session Summary: Use SUBHED for Auto-Generated Excerpts
- Changed auto-inserted excerpt keyword from =#+EXCERPT:= to =#+SUBHED:= to match legacy convention.
- Both keywords map to the same =excerpt= front matter field in MDX output.
- Priority order unchanged: =ASTRO_EXCERPT= → =EXCERPT= → =SUBHED= → =DESCRIPTION= → fallback paragraph.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Modified =ox-astro.el:298= to insert =SUBHED= instead of =EXCERPT= when auto-generating
- [x] Added explanatory comment noting SUBHED is alias for excerpt

*CONTEXT FOR NEXT SESSION*
- Files touched: =ox-astro.el=
- No breaking changes—MDX output identical since both keywords map to =excerpt=

* 2025-11-15
** Session Summary: Formatting Issues Documentation
- Analyzed exported MDX output from goal tracking blog post to identify systematic formatting problems in the ox-astro exporter.
- Documented 5 major formatting issues: escaped org-mode markers, orphaned code block closers, double-encoded timestamps, nested code block confusion, and malformed list numbering.
- Created comprehensive issue report with line numbers, examples, root causes, and suggested fixes at [[file:formatting-issues-2025-11-15.org][formatting-issues-2025-11-15.org]].
- Issues prioritized into High Priority (breaking code block structure) and Medium Priority (visual/semantic problems).

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Full formatting analysis completed on real-world export output
- [x] Documentation created with links to source org file and MDX output for reference
- [x] 5 issues identified with detailed before/after examples and line numbers
- [x] Priority recommendations and testing suggestions provided
- [x] Test case specifications written for future regression testing

*IN-PROGRESS (Requires completion)*
- [ ] Fix Issue #1: Escaped org-mode markers with trailing underscores (=\#+begin_src_= → =#+begin_src=)
- [ ] Fix Issue #2: Orphaned =#+end_src_= closing markers appearing without opening markers
- [ ] Fix Issue #4: Nested code block confusion (code examples containing code blocks)
- [ ] Fix Issue #5: Malformed nested list numbering (flattened hierarchy)
- [ ] Fix Issue #3: Double-encoded HTML timestamps (lower priority)

*CONTEXT FOR NEXT SESSION*
- Files to review: [[file:formatting-issues-2025-11-15.org][formatting-issues-2025-11-15.org]]
- Test files referenced:
  - Source: [[file:/Users/jay/Dropbox/roam/chatgpt-outputs/20251030123203-claude_designs_a_goal_tracking_system.org][20251030123203-claude_designs_a_goal_tracking_system.org]]
  - Output: [[file:/Users/jay/Library/CloudStorage/Dropbox/github/astro-monorepo/apps/anthropic/src/content/blog/claude-designs-a-goal-tracking-system.mdx][claude-designs-a-goal-tracking-system.mdx]]
- Known unknowns: Root cause likely in =ox-astro-src-block= and =org-astro-src-block= functions; need to investigate code block nesting tracking
- Recommendations:
  - Start with Issues #1, #2, #4 (all related to code block handling) as they share common root cause
  - Create test file with nested code blocks and org-mode examples before fixing
  - Issue #5 (list numbering) is separate concern in list export logic

* 2025-11-13
** Session Summary: Link Conversion in User Blocks
- Fixed bug where org-mode links inside `user`, `prompt`, and `quote` blocks were being exported in raw org-mode format (`[[link][text]]`) instead of being converted to Markdown format (`[text](link)`).
- Enhanced `org-astro-src-block` function to convert org-mode links to Markdown during special block processing.
- Link conversion now handles both forms: `[[path][description]]` → `[description](path)` and `[[path]]` → `[path](path)`.
- This conversion happens alongside existing transformations (em dashes, org headings) for these special blocks.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Link conversion regex added to `org-astro-src-block` for `user`, `prompt`, and `quote` blocks (`ox-astro-helpers.el:1206-1216`)
- [x] Tested with real export file - links now correctly convert to Markdown format in user blocks
- [x] Verified git diff shows correct Markdown link output

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`
- Known unknowns: None - feature is complete and tested
- Recommendations: None

** Previous Session: Destination Keyword Alias
- Added `#+DESTINATION` as a shorter alias for `#+DESTINATION_FOLDER` and `#+DESTINATION-FOLDER`, providing users with a more concise option for specifying export destinations.
- Updated all regex patterns across the codebase to recognize all three forms: `#+DESTINATION_FOLDER:`, `#+DESTINATION-FOLDER:`, and `#+DESTINATION:`.
- Enhanced keyword preservation logic to maintain user's preferred format when updating existing destination keywords.
- Updated documentation across README, concept map, and config files to reflect the new shorter alias.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Regex patterns updated in three locations to support `#+DESTINATION:` (`ox-astro-helpers.el:399`, `update-image-paths.el:76`, `ox-astro.el:345`)
- [x] Keyword preservation logic enhanced to handle all three format variants (`ox-astro.el:348-351`)
- [x] Documentation updated: `README.org:82,129`, `docs/concept-map.org:80`, `ox-astro-config.el:16,53,61`
- [x] Regex tests created and passing for all three keyword variants

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `update-image-paths.el`, `ox-astro.el`, `README.org`, `docs/concept-map.org`, `ox-astro-config.el`
- Known unknowns: None - feature is complete and tested
- Recommendations: Consider adding to CHANGE-LOG.org if this warrants a version bump or release note

* 2025-10-30
** Session Summary
- Added `#+SUBHED` as an accepted excerpt keyword so Org sources can map legacy decks into MDX front matter without duplication.
- Refreshed metadata documentation (design architecture, concept map) and recorded the behavior change in the change log.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Excerpt priority now considers `ASTRO_EXCERPT`, `EXCERPT`, `SUBHED`, `DESCRIPTION`, then paragraph fallback (`ox-astro-helpers.el:887-905`).
- [x] Documentation updates: `docs/design-architecture.org:152-168`, `docs/concept-map.org:99-106`, `CHANGE-LOG.org:5-15`.

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `docs/design-architecture.org`, `docs/concept-map.org`, `CHANGE-LOG.org`
- Known unknowns: Need an export smoke test confirming SUBHED usage emits `excerpt` as expected.
- Recommendations: Export a representative Org note using `#+SUBHED` to verify front matter output.

* 2025-10-26
** Session Summary
- Exporter now preserves `#+MEDIA`, `#+INCOMPLETE`, and the connection keywords so regenerated MDX matches the enriched schema in life-web.
- Front-matter generator learned how to embed nested YAML blocks, enabling us to emit the `connections` map without rewriting the serializer.
- Metadata parsers gained normalization for attachment lists and boolean draft flags, keeping input tolerance consistent with other list fields.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Keyword plumbing (`ox-astro.el:560-596`) covers media, incomplete, and connection variants alongside existing metadata.
- [x] Parsers for media/incomplete/connections added to `ox-astro-metadata.el:160-225`, trimming empty items and coercing booleans.
- [x] Front-matter assembly & YAML output updated to handle raw nested blocks (`ox-astro-helpers.el:774-990`).
- [x] Work log updated; standalone `CHANGE-LOG.org` entry removed per guidance.

*IN-PROGRESS (Requires completion)*
- [ ] Run an end-to-end export on representative notes to confirm the new fields align with life-web ingestion (attachments, draft flags, connections).

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro.el`, `ox-astro-metadata.el`, `ox-astro-helpers.el`
- Known unknowns: No automated fixture yet for nested connection emission; consider adding an ERT around `org-astro--format-connections-yaml`.
- Recommendations: Re-export one of the new story org files and verify `media`, `incomplete`, and `connections` materialize correctly in the MDX front matter.

* 2025-10-22
** Session Summary
- Enabled `#+DESTINATION-FOLDER` as a synonym for `#+DESTINATION_FOLDER` across the exporter and tooling.
- Normalized destination keyword detection in helper scripts and refreshed documentation to advertise both forms.
- Logged the change in CHANGE-LOG with guidance on pending test coverage.
- Updated ID link guidance and fixtures to demonstrate Markdown links with preserved directory structure.
- Refreshed operational instructions with the Markdown link behavior for org-roam exports.

** Handoff

- [x] Destination keyword aliasing implemented: `ox-astro.el:97`, `ox-astro-helpers.el:211`
- [x] Auto-insert preserves user delimiter and absorptive docs updated: `ox-astro.el:309`, `README.org:82`, `docs/concept-map.org:80`
- [x] Tooling aware of both forms (`update-image-paths.el:72`, config docs)
- [x] Change log entry added: `CHANGE-LOG.org:5`
- [x] ID link docs/tests reinforced Markdown relative outputs: `docs/lab/org-roam-links.org`, `test-id-links.el`, `test-files/id-links/*`
- [x] Instructions updated to highlight Markdown link outputs: `docs/instructions.org:15`
- [x] Absolute-path destinations now populate ID map metadata: `ox-astro-helpers.el:181`, `test-id-links.el`
- [x] Source-root detection auto-falls back to the note's org-roam vault, keeping ID links working even when exporting from another profile: `ox-astro-helpers.el:339`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro.el`, `ox-astro-helpers.el`, `update-image-paths.el`, documentation set
- Known unknowns: Automated regression suite beyond `test-id-links.el` not re-run; alias relies on shared keyword helper
- Recommendations: Export a sample Org file using `#+DESTINATION-FOLDER:` and run `emacs --batch -Q -l test-id-links.el -f ert-run-tests-batch-and-exit`

* 2025-11-15
** Session Summary
- Hardened the destination-folder resolution in `org-astro-prepare-images-filter` so whitespace-laden nicknames reuse the same helper as the main exporter.
- Replaced the regex-based hero suppression with a multi-line safe removal helper and tightened the MDX final-output filter to respect code fences and list continuations.
- Added regression ERTs covering fenced-code + list indentation handling and ensured the test harness loads the repo modules reliably.
- Taught the list transcoder to keep dash bullets nested under numbered items and documented the verification in `formatting-issues-2025-11-15.org`.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Shared destination resolution + info plists updated: `ox-astro-handlers.el:60-110`
- [x] Hero component removal recognizes multi-line Image tags: `ox-astro-handlers.el:140-170`
- [x] Final output filter skips code fences/lists + new tests added: `ox-astro-handlers.el:240-320`, `test/image-pipeline-test.el:1-124`
- [x] Inline dash bullets stay nested with updated translator + regression test: `ox-astro-handlers.el:40-120, 140-210`, `test/image-pipeline-test.el:101-140`

*IN-PROGRESS (Requires completion)*
- [ ] Gallery regression fixture (`test/gallery_test_rigorous.expected.mdx`) no longer matches exporter output; needs refresh or relaxed assertions.

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-handlers.el`, `test/image-pipeline-test.el`
- Known unknowns: Gallery snapshot diverges (extra Image import, column props, missing legacy images). Decide whether to update expected MDX or adjust exporter to retain prior behavior.
- Recommendations: Re-run `emacs --batch -Q -l ert -l test/image-pipeline-test.el -f ert-run-tests-batch-and-exit` after reconciling the gallery fixture; confirm hero-image removal still suppresses duplicates in real posts.

* 2025-10-20
** Session Summary
- ID links disappearing traced to user hook `org-export-id-link-removal` running during export copy.
- Added hook sanitization helper and wrapped Astro exports so blocklisted hooks are removed.
- Documented investigation resolution and added regression test for hook scrubbing.
- Lesson learned: when a feature works locally but fails for the user, inspect their hooks/config before blaming exporter internals.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Hook sanitization macro + export wrappers: `ox-astro.el:69`
- [x] Regression test `org-astro-export-sanitizes-id-stripping-hooks`: `test-id-links.el:113`
- [x] Investigation doc updated with root cause and fix: `docs/INVESTIGATION-id-links-stripped.org:285`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro.el`, `test-id-links.el`, `docs/INVESTIGATION-id-links-stripped.org`
- Known unknowns: Need live export from org-roam vault to confirm hook sanitization covers whole pipeline.
- Recommendations: Verify no other user hooks in init files rewrite links or other elements during export.

* 2025-10-10
** Session Summary
- Added DESCRIPTION keyword as fallback for EXCERPT in front matter generation
- Updated excerpt extraction logic to check EXCERPT first, then DESCRIPTION, then first paragraph
- Updated documentation in concept-map.org, design-architecture.org, and CHANGE-LOG.org

** Handoff

*COMPLETED (Safe to rely on)*
- [x] DESCRIPTION fallback implemented: `ox-astro-helpers.el:392-414`
- [x] Priority order: ASTRO_EXCERPT → EXCERPT → DESCRIPTION → first paragraph
- [x] Documentation updated: `docs/concept-map.org:103`, `docs/design-architecture.org:161`
- [x] Change log entry added: `CHANGE-LOG.org:5-29`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `docs/concept-map.org`, `docs/design-architecture.org`, `CHANGE-LOG.org`
- Known unknowns: None - feature is complete and self-contained
- Recommendations:
  - Test with an org file that has both DESCRIPTION and EXCERPT to verify priority works correctly
  - Consider whether README.org needs updating (currently skipped per user request)

* 2025-10-07
** Session Summary
- Updated table cell sanitization to wrap generic type signatures and normalize `<br>` tags for MDX compatibility.
- Normalized `<br>` tags during final output filtering to avoid Astro parse errors.
- Re-exported `guide-to-codex.org` to regenerate the Socratic blog post.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Generic type cells wrapped in inline code: `ox-astro-table-handlers.el`
- [x] `<br>` normalization added to final output filter: `ox-astro-handlers.el`
- [x] Export refreshed: `/Users/jay/Library/CloudStorage/Dropbox/github/astro-monorepo/apps/socratic/src/content/blog/guide-to-codex-cli.mdx`

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-table-handlers.el`, `ox-astro-handlers.el`
- Known unknowns: Consider whether other HTML fragments (e.g., `<hr>`, `<img>`) need similar normalization.
- Recommendations: Review latest generated MDX in Astro dev server to confirm no additional JSX parse errors.

* 2025-11-26
** Session Summary
- Added custom `org-astro-underline` transcoder so placeholder underscores (3+) round-trip without emitting underline spans; other underlined text now exports as plain text.
- Wired underline transcoder into backend and removed final-output hack; front matter now also includes slug for consistency.
- Re-exported `tip_of_the_tongue.org` → `apps/socratic/src/content/blog/tip-of-the-tongue.mdx` to verify underscores stay literal.

* 2025-12-03
** Session Summary
- Added org-roam metadata to exported frontmatter: `orgRoamId`, `aliases`, and `orgPath` now emit from `ox-astro-helpers.el` (pulling from properties/keywords with file scan fallback).
- Hardened excerpt extractor to reduce paren errors; fixed helper parens and ensured file loads cleanly.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Frontmatter now includes org-roam ID/aliases/path for link resolution: `ox-astro-helpers.el`
- [x] Paren/scan errors resolved; file parses and loads cleanly.

*IN-PROGRESS (Requires completion)*
- [ ] Re-export content to pick up orgRoamId/aliases/orgPath in MDX outputs.

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `docs/work-log.org`
- Recommendations:
  - Re-export representative notes to verify org-roam fields appear.
  - Use the new metadata in link conversion/downstream index.

** Handoff

*COMPLETED (Safe to rely on)*
- [x] Underline handling fixed via `org-astro-underline`; spans no longer emitted for placeholders.
- [x] Front matter includes slug in generated data.
- [x] Post re-exported with correct placeholders: `apps/socratic/src/content/blog/tip-of-the-tongue.mdx`.

*IN-PROGRESS (Requires completion)*
- [ ] None

*CONTEXT FOR NEXT SESSION*
- Files touched: `ox-astro-helpers.el`, `ox-astro.el`, `apps/socratic/src/content/blog/tip-of-the-tongue.mdx`
- Known unknowns: None observed; image copy warning is harmless (source/dest identical).
- Recommendations: If other posts use underline placeholders, re-export after pulling changes.

* 2025-11-29
** Session Summary: Clipboard Copy Opt-In and Paren Fixes

*** Changes Made
- Made clipboard copying opt-in via `org-astro-copy-to-clipboard` defcustom (defaults to nil)
- Fixed paren imbalance in `org-export-define-derived-backend` call that caused export to return nil
- Reverted to commit 1128b61 to restore working baseline after multiple paren issues

*** Clipboard Copy Behavior
The exporter previously copied source/output/debug paths to macOS clipboard via `pbcopy` on every export. This is now controlled by:

#+begin_src emacs-lisp
(setq org-astro-copy-to-clipboard t)  ; Enable clipboard copying
#+end_src

Default is nil (disabled). When enabled, paths are copied to clipboard after export completes.

*** Files Modified
- `ox-astro.el` - Added `org-astro-copy-to-clipboard` defcustom, fixed paren balance
- `ox-astro-helpers.el` - Guarded pbcopy calls at lines 257-265 and 307-315
- `ox-astro-handlers.el` - Guarded pbcopy call at lines 249-256

*** Commits
- `915bc4e` - Guard clipboard copies behind org-astro-copy-to-clipboard
- `8547ec8` - Fix paren imbalance in debug clipboard guard

** Handoff

* 2025-11-30 Fix ID Map Building (Critical Bug)
** Summary
Fixed critical bug where the ID map was always empty (0 IDs), causing all cross-file ID links to be reported as broken even though the target files existed.

*** Root Cause
The regex in `directory-files-recursively` was malformed:
#+begin_src emacs-lisp
;; BROKEN - single backslashes in double-quoted string
(directory-files-recursively root "\.org\'")
;; This became literal ".org'" - matching no files

;; FIXED - proper escaping
(directory-files-recursively root "\\.org\\'")
;; This correctly matches files ending in .org
#+end_src

*** Additional Fix
Also added fallback so files without `#+DESTINATION_FOLDER` use the first entry in `org-astro-known-posts-folders`, ensuring all IDs map to an outfile.

*** Symptoms
- `[ox-astro] ID map built: 0 IDs from root /Users/jay/dropbox/roam`
- All ID links reported as broken despite target files existing
- org-id separately reported "691 files scanned, 728 IDs found" (different system)

** Files
- `ox-astro-helpers.el` - Fixed regex, added destination fallback, added debug logging

** Lesson Learned
In Emacs Lisp, regex special sequences like `\'` (end of string) require double backslashes in double-quoted strings: `"\\'"`. Single backslashes are consumed by the string parser, leaving just `'`.

* 2025-11-30 Strip ID drawers and org-roam boilerplate from body

** Session 3: Regex Fix for Links/Source Stripping

*** Bug Fixed
The regex pattern for stripping org-roam template boilerplate wasn't matching actual output.

*Problem:* Actual export output has colon inside bold markers:
#+begin_example
    -   **Links:**
    -   **Source:**
#+end_example

Original regex expected colon after bold: =**Links**:=. Fixed to handle colon inside or outside:

#+begin_src emacs-lisp
;; Before (broken)
"^[ \t]*-[ \t]+\\*\\*\\(Links\\|Source\\)\\*\\*[ \t]*::?[ \t]*\n?"

;; After (fixed)
"^[ \t]*-[ \t]+\\*\\*\\(Links\\|Source\\):?\\*\\*[ \t]*:?[ \t]*\n?"
#+end_src

*** Verification
Re-exported MDX files now have clean body content:
- ✅ No =:ID:= lines (property drawer fix working)
- ✅ No =- **Links:**= boilerplate
- ✅ No =- **Source:**= boilerplate

*** Files Modified
- =ox-astro-handlers.el= (line 356 - regex pattern fix)

** Session 2: Body Content Cleanup for org-roam Exports
- Strip PROPERTIES drawer output and org-roam boilerplate from MDX bodies
- Keep IDs only in frontmatter (add property-drawer translator + final body cleanup)
- Addresses leaked =:ID:= lines like in journal/monday-february-12-2024.mdx

* 2025-12-01 Remote image URL rewrite

** Fix: rewrite remote links to downloaded paths
- Added remote link handling in `org-astro--update-image-path-in-buffer` so `[[https://...]]` / `[[http://...]]` / `[[//...]]` get rewritten to the downloaded local asset path, matching the behavior for local image links.

** Files Modified
- =ox-astro-image-handlers.el= — remote link replacement now supported during source rewrite.

** Verification
- Manual: export an Org file with a remote image link; confirm image downloads to `assets/images/posts/{slug}/` and the Org source link is updated to the local path.
