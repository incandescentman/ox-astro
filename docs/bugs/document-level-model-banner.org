#+TITLE: Theme and Model Banner Issues for Multi-AI Posts
#+DATE: 2025-12-26
#+UPDATED: 2025-12-31
#+STATUS: Open

* Problem Summary

Multiple related issues affect the theming system for AI blog posts:

1. Document-level ~#+MODEL:~ behavior is inconsistent (ignored OR duplicated)
2. Duplicate theme markers appear in output
3. First section lacks inline theme marker
4. Orphan theme markers (empty sections)

Underlying cause: doc-level detection is currently based on "before the first
headline" rather than "before any body content." This misclassifies no-headline
files and early inline markers as document-level, which cascades into duplicate
markers and banners.

* Test Cases

| Post | Frontmatter Theme | Issues Found |
|------|-------------------|--------------|
| equipment-for-living | =theme: chatgpt= | *Clean* ✓ |
| tip-of-the-tongue | =theme: claude= | Duplicate Claude banner |
| shakespeare | /none/ | Duplicate chatgpt marker |
| sinners | /none/ | Orphan chatgpt marker |
| consciousness | /none/ | Duplicate chatgpt marker |

** Primary Test Case: consciousness-as-an-emergent-phenomenon

- Org file: ~/Users/jay/Dropbox/roam/notes/20251226144427-consciousness_as_an_emergent_phenomenon.org~

Org structure:
#+begin_example
#+THEME: chatgpt           <- document-level (line 16)
#+MODEL: ChatGPT 5.2       <- document-level (line 17)
* Consciousness as an emergent phenomenon   <- first heading (line 18)

[ChatGPT content...]

#+THEME: claude            <- inline, before heading (line 644)
* Claude                   <- heading (line 646)
#+MODEL: Claude Sonnet 4.5 <- inline, after heading (line 647)

[Claude content...]

#+THEME: chatgpt           <- inline (line 812)
#+MODEL: ChatGPT 5.2       <- inline (line 813)
* ChatGPT                  <- heading (line 814)
#+end_example

** Secondary Test Case: tip-of-the-tongue

- Org file: ~/Users/jay/Dropbox/roam/chatgpt-outputs/20251103133432-tip_of_the_tongue.org~

Org structure (NO Org headlines — flat content):
#+begin_example
#+THEME: claude            <- document-level
#+MODEL: Claude Sonnet 4.5 <- document-level

#+begin_src user
[content...]
#+end_src

[Claude content...]

#+THEME: chatgpt           <- inline
#+MODEL: ChatGPT 5.1       <- inline

[ChatGPT content...]
#+end_example

* Issue 1: Document-Level MODEL Inconsistent Behavior

** Case A: Posts WITH Org Headlines (MODEL Ignored)

*** Expected Behavior
Document-level ~#+MODEL:~ should emit a model banner for the first section.
The banner should appear after imports, before the first heading content.

*** Actual Behavior
Document-level ~#+MODEL:~ is ignored and produces no output.
The first section has no model banner.

*** Root Cause
~org-astro-keyword~ only emits ~#+MODEL:~ when ~body-level~ is true:

#+begin_src elisp
(body-level (or (null first-headline-pos)
                (and pos first-headline-pos (>= pos first-headline-pos))))
...
((string-equal key "MODEL")
 (if body-level
     (format "<div class=\"model-banner\">%s</div>\n\n" value)
   ""))
#+end_src

Since document-level ~#+MODEL:~ appears BEFORE the first heading, ~body-level~ is nil.

** Case B: Posts WITHOUT Org Headlines (MODEL Duplicated)

*** Expected Behavior
Document-level ~#+MODEL:~ should emit exactly ONE banner.

*** Actual Behavior
In ~tip-of-the-tongue.mdx~, the Claude banner appears twice:

#+begin_example
23: <div class="model-banner">Claude Sonnet 4.5</div>   <- FIRST
...
27: {/* theme: claude */}
...
29: <div class="model-banner">Claude Sonnet 4.5</div>   <- DUPLICATE
#+end_example

*** Root Cause
When there are NO Org headlines, ~first-headline-pos~ is nil, so ~body-level~
becomes true via ~(or (null first-headline-pos) ...)~.

This causes BOTH emitters to fire:
1. ~org-astro-keyword~ emits banner (because ~body-level~ is true)
2. ~org-astro-body-filter~ ALSO emits banner via ~theme-model-prefix~

** Proposed Fix for Issue 1

Option A (preferred): Have ~org-astro-body-filter~ be the SOLE emitter of
document-level MODEL banners. Define document-level as "before any body
content" (headline, paragraph, block, etc), not merely "before first headline."
Modify ~org-astro-keyword~ to skip MODEL when the keyword is document-level:

#+begin_src elisp
((string-equal key "MODEL")
 (if (and body-level (not (org-astro--keyword-before-body-p keyword tree)))
     (format "<div class=\"model-banner\">%s</div>\n\n" value)
   ""))
#+end_src

Option B: Detect document-level ~#+MODEL:~ and store in ~:astro-page-model~,
then emit once in ~org-astro-body-filter~. Mark as consumed to prevent duplicate.

* Issue 2: Duplicate Theme Markers

** Expected Behavior
Each section should have exactly one ~{/* theme: X */}~ marker.

** Actual Behavior
MDX output shows duplicate markers in multiple posts:

consciousness-as-an-emergent-phenomenon.mdx:
#+begin_example
23: {/* theme: chatgpt */}   <- FIRST
...
26: {/* theme: chatgpt */}   <- DUPLICATE
#+end_example

how-to-use-ai-to-understand-shakespeare.mdx:
#+begin_example
308: {/* theme: chatgpt */}   <- FIRST
310: {/* theme: chatgpt */}   <- DUPLICATE
#+end_example

** Root Cause
Duplicates occur when THEME is placed immediately before or after a heading.
~org-astro--ensure-inline-theme-markers~ may insert a marker before model
headings while ~org-astro-keyword~ also emits the inline marker, or the page
theme is set from a non-doc-level THEME and ~org-astro-body-filter~ adds a
second marker. This produces back-to-back identical markers.

** Proposed Fix
Normalize THEME placement around headings so there is exactly one canonical
marker:
- Treat THEME immediately before *or* as the first child of a section as the
  same thing; move/mark it so only one marker is emitted.
- Ensure ~org-astro--ensure-inline-theme-markers~ recognizes existing keywords
  in either position and does not insert duplicates.
- Tighten doc-level detection so inline THEME does not set page theme.

* Issue 3: First Section Lacks Inline Theme Marker

** Expected Behavior
For multi-AI posts, the first section should have a ~{/* theme: X */}~ marker
at the start of body content (after imports).

** Actual Behavior
Document-level ~#+THEME: chatgpt~ goes to frontmatter only. No inline
~{/* theme: chatgpt */}~ appears before the first section content.

** Root Cause
~org-astro-keyword~ treats document-level THEME as frontmatter-only:

#+begin_src elisp
((string-equal key "THEME")
 (if (or body-level allow-inline-theme)
     (format "{/* theme: %s */}\n\n" (downcase value))
   ""))  ;; <- Document-level emits nothing
#+end_src

** Proposed Fix
Use document-level THEME *only* for single-AI posts. If multiple THEME keywords
exist, treat the doc-level THEME as the first section marker and do NOT set
frontmatter theme.

#+begin_src elisp
;; In body-filter or a new filter:
(when (and page-theme
           (org-astro--has-multiple-theme-sections tree))
  ;; Prepend {/* theme: <page-theme> */} to body
  )
#+end_src

* Issue 4: Orphan Theme Markers

** Expected Behavior
Theme markers should only appear when followed by actual content.

** Actual Behavior
In ~sinners.mdx~:

#+begin_example
30: {/* theme: chatgpt */}   <- ORPHAN (no content before next theme)
...
34: {/* theme: claude */}    <- Immediately overrides
#+end_example

** Root Cause
The org source likely has a ~#+THEME: chatgpt~ that gets immediately
overwritten by ~#+THEME: claude~ before any content appears between them.

** Proposed Fix
Prevent emission of consecutive markers by normalizing theme placement and
skipping markers when no content exists between them. As a fallback, collapse
adjacent markers during export.

* Proposed Logical Theming System

** Rule 0: Define "document level"
A keyword is document-level only if it appears before *any* body content
(headline, paragraph, block, etc). If there are multiple THEME keywords, the
post is multi-AI and page-level theming should be disabled.

** Rule 1: Single-AI Posts

Posts with content from only one AI model.

*** Org Source Pattern
#+begin_src org
#+TITLE: My Post
#+THEME: claude
#+MODEL: Claude Sonnet 4.5

#+begin_src user
Hello
#+end_src

Response content...
#+end_src

*** Expected MDX Output
#+begin_src markdown
---
theme: claude
---

<div class="model-banner">Claude Sonnet 4.5</div>

```user
Hello
```

Response content...
#+end_src

*** Key Points
- =#+THEME:= at document level → frontmatter only (page wrapper)
- =#+MODEL:= at document level → one banner near top
- *No inline theme markers needed*

** Rule 2: Multi-AI Posts

Posts with content from multiple AI models.

*** Org Source Pattern
#+begin_src org
#+TITLE: AI Comparison

* Claude's Take
#+THEME: claude
#+MODEL: Claude Sonnet 4.5

#+begin_src user
Question
#+end_src

Claude's response...

* ChatGPT's Take
#+THEME: chatgpt
#+MODEL: ChatGPT 5.2

#+begin_src user
Same question
#+end_src

ChatGPT's response...
#+end_src

*** Expected MDX Output
#+begin_src markdown
---
title: AI Comparison
---

{/* theme: claude */}

<div class="model-banner">Claude Sonnet 4.5</div>

```user
Question
```

Claude's response...

{/* theme: chatgpt */}

<div class="model-banner">ChatGPT 5.2</div>

```user
Same question
```

ChatGPT's response...
#+end_src

*** Key Points
- *No theme in frontmatter* (page uses default/neutral wrapper)
- Each section gets inline =#+THEME:= + =#+MODEL:=
- Sections are wrapped by =remarkThemeSections= plugin

** Rule 3: Never Mix Document-Level and First-Section Inline

This is *wrong*:
#+begin_src org
#+THEME: claude           <- Document level
#+MODEL: Claude Sonnet 4.5

#+THEME: claude           <- Redundant! Same as document level
#+MODEL: Claude Sonnet 4.5  <- Will emit duplicate banner
#+end_src

If you have document-level theme/model, do NOT also put inline markers
before the first content.
If multiple THEME keywords exist, treat the document-level THEME as the
*first section* marker and skip frontmatter theme.

** Rule 4: Theme Markers Only on Transitions

In multi-AI posts, the first section needs a theme marker. Subsequent
sections only need markers when *switching* themes.

** Rule 5: MODEL Banner Placement
- Document-level MODEL emits *once* at top of body.
- Inline MODEL emits only *after* a heading (never when no headings exist).

* Expected Final Output

After all fixes, the consciousness test file should produce:

#+begin_example
---
title: "For Dad: Consciousness as an emergent phenomenon"
...
---
{/* Source org: ... */}
import { Image } from 'astro:assets';
...

{/* theme: chatgpt */}
<div class="model-banner">ChatGPT 5.2</div>

# Consciousness as an emergent phenomenon

[content...]

{/* theme: claude */}
<div class="model-banner">Claude Sonnet 4.5</div>

# Claude

[content...]

{/* theme: chatgpt */}
<div class="model-banner">ChatGPT 5.2</div>

# ChatGPT

[content...]
#+end_example

* Files to Modify

- ~ox-astro-handlers.el~
  - ~org-astro-keyword~ (keyword handling)
  - ~org-astro--ensure-inline-theme-markers~ (duplicate prevention)
  - ~org-astro-body-filter~ (emit page-level model/theme)
- ~ox-astro-handlers.el~ (doc-level detection: before any body content)
- ~ox-astro-helpers.el~ (optional helper: keyword-before-body-p)
- ~README.org~ (update placement rules)
- ~docs/instructions.org~ (update documentation)
- Tests: add regression tests for all scenarios

* Testing Checklist

After implementing fixes, verify these posts render correctly:

- [ ] =tip-of-the-tongue= — Claude banner appears once (not duplicated)
- [ ] =consciousness-as-an-emergent-phenomenon= — ChatGPT marker appears once
- [ ] =shakespeare= — ChatGPT marker appears once
- [ ] =sinners= — No orphan theme markers
- [ ] =equipment-for-living= — Still works (regression test)

* References

- ~ox-astro-handlers.el~ — Main handler code
- ~packages/astro-utils/src/remark/themeSections.ts~ — Remark plugin
- ~apps/socratic/src/styles/claude-theme.css~ — Theme CSS files
- ~apps/socratic/src/pages/[...blog]/index.astro~ — Page template

* Status

Open
