#+TITLE: ox-astro Codebase Wisdom
#+DATE: [2025-09-23 Mon]

* Setup / Environment

* Codebase Quirks

** Pattern: Export happens in two distinct phases requiring careful state management
- *Mechanism:* Pre-processing phase (lines 91-178 in ox-astro.el) handles images/PDFs, then main export phase (179+) handles metadata
- *Actionable insight:* When adding metadata like SLUG, it must be added in the metadata phase (around line 180+), not earlier

** Fact: The export narrowing context affects keyword detection
- *Mechanism:* When exporting a subtree or in narrowed buffer, `org-element-parse-buffer` only sees the narrowed region
- *Actionable insight:* Always check for both title-kw and slug-kw within the narrowed context to avoid duplicate additions

* Debugging Tactics

** Technique: Use file modification notifications to track external changes
- *Mechanism:* Claude Code provides system reminders when files are modified externally
- *Actionable insight:* Pay attention to these notifications - they indicate your code may have been overwritten

* Tool Oddities (Claude Code, etc.)

** Behavior: Emacs batch mode syntax errors can be cryptic
- *Example:* "Invalid read syntax: ")", 371, 21" means extra closing parenthesis at line 371
- *Actionable insight:* Count parentheses carefully when editing Lisp code, especially in complex let* forms
- Emacs has a function (check-parens) that can help. If you still have trouble fixing mismatched parentheses, ask user to help!

* ox-astro Specific Patterns

** Pattern: Keyword insertion uses `org-astro--upsert-keyword-after-roam`
- *Mechanism:* This function intelligently places keywords after org-roam properties
- *Actionable insight:* Always use this helper instead of manual insertion to maintain consistent formatting

** Pattern: Front matter data flows through multiple functions
- *Flow:* ox-astro.el generates keywords → info plist → ox-astro-helpers.el `org-astro--get-front-matter-data` → MDX
- *Actionable insight:* To add new metadata, update both the keyword generation AND the front matter assembly

** Gotcha: Slug generation logic was split across multiple locations
- *Locations:*
  - ox-astro.el lines 118-125 (for image processing)
  - ox-astro.el lines 187-214 (for metadata addition)
  - ox-astro-helpers.el lines 552-554 (for front matter)
- *Actionable insight:* When modifying slug behavior, check ALL three locations to ensure consistency
- Question: Is this OK? should we consolidate slug generation logic to one place?

** Gotcha: Whitespace in config folder nicknames causes lookup failures
- *Date:* 2025-10-05
- *Trigger:* `#+DESTINATION_FOLDER: socratic` failed with "not found" error even though "socratic " existed in config
- *Mechanism:* `assoc` performs exact string matching, so `"socratic"` ≠ `"socratic "` (trailing space)
- *The Fix:* Implemented whitespace-tolerant lookup using `cl-find` with `string-trim` on both input and config keys (ox-astro.el:243-245, 100-103)
- *Prevention:*
  - Always trim whitespace from user input before lookup
  - Use `cl-find` with custom `:test` function instead of `assoc` for fuzzy matching
  - This pattern applies to any user-facing configuration lookups
- *Actionable insight:* Configuration errors (trailing spaces, inconsistent formatting) should be handled gracefully rather than failing with cryptic errors

** Pattern: MDX Export Blocks for Raw JSX/Components
- *Date:* 2025-10-05
- *Use Case:* Embedding Astro/React components directly in Org files
- *Mechanism:* Use `#+BEGIN_EXPORT mdx` / `#+END_EXPORT` blocks to pass JSX/MDX through verbatim
- *Implementation:* Added `org-astro-export-block` transcoder that recognizes MDX, MARKDOWN, and MD export types
- *Example:*
  ```org
  #+BEGIN_EXPORT mdx
  import CopyPromptButton from '@jaydixit/astro-utils/components/CopyPromptButton.astro';

  export const promptText = `Your text here`;

  <CopyPromptButton text={promptText} buttonText="Click me" />
  #+END_EXPORT
  ```
- *Actionable insight:* For one-off component usage, export blocks are cleaner than creating special transcoding logic

** Gotcha: Caption attributes must use HTML entities, not backslashes
- *Date:* 2025-12-02
- *Problem:* Backslash-escaped quotes inside `data-pswp-*` captions produced MDX parse errors (“Unexpected character \ in attribute name”).
- *Fix:* Attribute escaping now encodes &, <, >, and \" to HTML entities before injection.
- *Actionable insight:* If adding new caption-like attributes, escape to entities (e.g., `&quot;`) instead of backslashes.

** Gotcha: Org strips scheme from remote links in parse tree
- *Date:* 2025-12-01
- *Problem:* Remote image URLs were downloaded but not rewritten in the source buffer because Org parses `[[https://example.com/img.jpg]]` as `type="https"` and `path="//example.com/img.jpg"` (scheme removed).
- *Fix:* When rewriting, reconstruct the full URL using link type + path before searching/replacing; see `org-astro--process-image-manifest` and `org-astro--update-image-path-in-buffer`.
- *Actionable insight:* Whenever matching against remote links parsed from Org, prefer `:raw-link` or rebuild `type + path` instead of relying on `:path` alone.

** Gotcha: Remote image downloads can save HTML error pages
- *Date:* 2026-01-01
- *Trigger:* 401/403/406 responses returned HTML, saved as =.jpg= files, and caused Emacs image read errors.
- *Mechanism:* =url-copy-file= saves whatever the server returns and can prompt for auth; no validation was performed.
- *Actionable insight:* Use curl-first downloads and validate magic bytes/HTML before accepting a file; normalize extensions based on detected content.

** Gotcha: Export block indentation was converted to blockquotes
- *Date:* 2025-10-05
- *Trigger:* MDX export blocks with indented HTML (like `<button>`) were being converted to blockquote syntax (`> `)
- *Mechanism:*
  1. `org-astro-export-block` used `org-remove-indentation` which only removes *minimum* indentation, leaving some spaces
  2. `org-astro-final-output-filter` detects lines starting with 4+ spaces and converts them to blockquotes (`> `)
  3. The filter only skips this conversion for JSX components (uppercase tags like `<Image>`), not HTML elements (lowercase tags like `<div>`)
- *The Fix:* Changed export block handler to completely strip ALL leading whitespace: `(replace-regexp-in-string "^[ \t]+" "" content)`
- *Prevention:* Export blocks must output completely unindented content to avoid triggering the blockquote conversion logic
- *Actionable insight:* The final-output filter's blockquote conversion is aggressive - any content that should stay verbatim must have zero indentation

** Gotcha: User export hooks can strip org-roam links
- *Date:* 2025-10-20
- *Trigger:* User config added `org-export-id-link-removal` to `org-export-before-parsing-functions`, so Astro exports lost every `[[id:...]]` link.
- *Mechanism:* The hook runs inside Org's temporary export buffer, deleting ID objects before we ever build the parse tree; our transcoders never fire.
- *Clue we missed:* The regression only happened on the user's machine—our exports still worked. Divergent behavior means "check user hooks/config" before blaming core code.
- *Fix:* Added `org-astro--with-export-sanitization` and a blocklist that temporarily removes known-destructive hooks from both `org-export-before-processing-functions` and `org-export-before-parsing-functions` during Astro exports.
- *Prevention:*
  - When debugging export differences, diff `org-export-before-*-functions` between environments early.
  - Keep the blocklist updated if new destructive hooks appear.
  - Prefer adding guardrails in the exporter rather than relying on users to disable their tweaks.

** Gotcha: Deeply nested elisp parens cause cascading errors
- *Date:* 2025-11-29
- *Trigger:* Fixing one paren imbalance often introduced others; ended up with 56 missing parens across ~30 functions
- *Mechanism:* Complex `let*` bindings, nested `if`/`cond`/`when` forms, and multi-line `progn` blocks make manual paren counting error-prone
- *Clue we missed:* Attempting to fix parens one at a time without checking overall balance led to more errors
- *The Fix:* Reverted to last known working commit (1128b61) and applied changes incrementally
- *Prevention:*
  - Use `emacs --batch --eval '(check-parens)'` to verify paren balance before committing
  - When paren errors cascade, revert to known-good state rather than fixing forward
  - Use Emacs' `show-paren-mode` and structural editing tools during development
  - Test syntax with byte-compilation: `emacs --batch -f batch-byte-compile file.el`

** Gotcha: org-export-get-environment overwrites cached plist data
- *Date:* 2025-11-29
- *Trigger:* Export succeeds (file written) but then shows "Astro export cancelled: No posts folder selected" and returns nil
- *Mechanism:* The `info` plist gets rebuilt by `org-export-get-environment` calls during export, blowing away cached folder info from preprocessing
- *Symptom:* Folder resolution works first time, but second lookup (after buffer modifications) fails
- *Prevention:*
  - Resolve critical paths (destination folder, output file) exactly once per invocation
  - Store in local variables, not just the info plist
  - Reattach to info plist after any environment refresh if needed downstream
- *Fix strategy:* Cache folder resolution results in `let`-bound locals before any `org-export-get-environment` calls

** Design: Single newlines preserved as Markdown soft breaks
- *Date:* 2026-01-08 (fixed 2026-01-14)
- *Context:* AI conversation transcripts often contain meaningful single newlines (not paragraph breaks) that would be lost in standard Markdown rendering.
- *Mechanism:* Standard Markdown collapses single newlines to spaces. ox-astro's =org-astro-paragraph= applies =org-astro--add-soft-breaks= to add two trailing spaces to each non-empty line (except the last), creating Markdown "soft breaks" that render as =<br>= in HTML.
- *Example:*
  #+begin_example
  A conclusion with a Bayesian lens.
  Neither assistant said "Bayes" explicitly...
  #+end_example
  Without soft breaks: renders as one continuous line.
  With soft breaks: each line renders separately with a line break.
- *Implementation:* =ox-astro-transcode.el= - =org-astro--add-soft-breaks= helper called from =org-astro-paragraph=
- *Gotcha:* This must happen at the paragraph level, NOT in =org-astro-plain-text=. The plain-text transcoder only sees text fragments between other elements (bold, links, etc.), not whole paragraphs. If you have =*bold*\nmore text=, plain-text gets ="\nmore text"=, not the full paragraph.
- *Actionable insight:* This is intentional behavior for preserving formatting in AI transcripts. If a user reports "extra line breaks," explain this is by design.

** Design: Stale assets cleanup is reference-guarded
- *Date:* 2026-01-14
- *Context:* Slug changes create new asset folders under =src/assets/images/posts/{slug}/= and leave the old ones behind.
- *Mechanism:* After stale MDX deletion, ox-astro resolves the app root via =src/content= and scans =src/= and =public/= for references to =assets/images/posts/{slug}/= or =/images/posts/{slug}/= before deleting the directory.
- *Gotcha:* Asset cleanup only runs when a stale MDX is detected via =orgPath=. Missing or altered frontmatter will prevent cleanup.
- *Actionable insight:* Keep =orgPath= intact if you want slug-change cleanup (MDX + assets) to work.

** Gotcha: Babel export progress messages are emitted before language execution
- *Date:* 2026-02-12
- *Trigger:* Exporting conversation transcripts with many =#+begin_src user= / =assistant= blocks spammed messages like =org-babel-exp process user at position ...=.
- *Mechanism:* In Org's =ob-exp.el=, =org-babel-exp-src-block= calls =message= before execution dispatch, so defining =org-babel-execute:user= alone does not silence it.
- *Fix:* Add an around advice on =org-babel-exp-src-block= that binds =noninteractive= to non-nil for selected languages during astro exports.
- *Prevention:*
  - If message noise comes from =org-babel-exp-src-block=, inspect that function before assuming executors control logging.
  - Scope advice to astro export mode to avoid global behavior changes.
  - Guard advice registration with =advice-member-p= to avoid duplicate advice on reload.

** Gotcha: Conversation block content can disappear when Babel exports results
- *Date:* 2026-02-16
- *Trigger:* MDX contains empty conversation fences (e.g., =```user ... ```= with no body) or drops conversation fences entirely, even though source Org blocks contain text.
- *Mechanism:* If language-specific Babel defaults resolve to =:exports results= for conversation block languages (user/assistant/prompt/etc.), Org executes the block and exports only results. With no-op executors, results are nil, so source content is not exported.
- *Compounding factor:* Stale bytecode can make local fixes appear inactive (e.g., message: =Source file ... newer than byte-compiled file; using older file=), so expected header-arg defaults may not actually be loaded.
- *Fix:* Enforce =:exports code= inside the exporter during the actual export pass (buffer + file exports, both file passes), then restore prior values after export.
- *Prevention:*
  - Do not rely on ambient/global Babel defaults for conversation transcript correctness.
  - Keep this behavior centralized in =ox-astro.el= export entry points (not ad-hoc global =setq= in handlers).
  - Keep the export path deterministic by setting conversation-language export behavior inside exporter code.
  - If behavior is inconsistent, check runtime source with =symbol-file= and verify whether stale =.elc= is being used.
  - Keep a regression test that simulates hostile defaults (=:exports results=) and asserts non-empty exported conversation fences.

** Gotcha: Headline raw-value can be deferred (non-string) in newer Org trees
- *Date:* 2026-02-13
- *Trigger:* Parse-tree filter errored with =wrong-type-argument char-or-string-p [org-element-deferred ...]= when calling =downcase= on headline =:raw-value=.
- *Mechanism:* Some Org parses return deferred wrappers for =:raw-value= (vector form) instead of immediate strings.
- *Fix:* Resolve headline titles via a safe helper that handles deferred vectors and falls back to interpreting =:title=.
- *Prevention:*
  - Do not assume =org-element-property :raw-value= is always a string.
  - Guard string operations (e.g. =downcase=, =string-trim=) with string checks or deferred-resolution logic.
  - Prefer a shared helper for headline title extraction in parse-tree filters/transcoders.

** Gotcha: Src/example block =:value= can be deferred (non-string)
- *Date:* 2026-02-16
- *Trigger:* Export crashed in =org-astro-src-block= with =wrong-type-argument stringp [org-element-deferred ...]= when applying regex transforms to block content.
- *Mechanism:* On newer Org builds, =org-element-property :value= for block elements may be a deferred vector wrapper instead of an immediate string.
- *Fix:* Added =org-astro--resolve-deferred-string= and routed =org-astro-src-block= and =org-astro-example-block= through it before string operations.
- *Prevention:*
  - Do not assume block =:value= is always a string.
  - Resolve deferred wrappers before calling =string-match-p=, =replace-regexp-in-string=, =org-trim=, etc.
  - Reuse the shared helper for any future property reads that are fed into string-only APIs.

* CSS Animation Patterns (astro-utils)

** Gotcha: animation: none on hover causes blipping when hovering off
- *Date:* 2025-12-04
- *Trigger:* Trying to smoothly expand a button on hover that had shrunk via CSS animation
- *Mechanism:* When using `animation-fill-mode: forwards`, the animation holds at its final state. Setting `animation: none` on hover stops the animation, but when you hover off, the animation restarts from where it was paused, causing a "blip"
- *Failed approaches:*
  - `animation-play-state: paused` - just freezes at current state, doesn't expand
  - `animation: reverse` - starts from wrong point, element disappears
  - Separate expand keyframes - animations fight each other, causes double-blipping
- *The Fix:* Use `!important` to override the animation's fill-mode values while letting the animation continue running in the background:
  ```css
  .element:hover {
    padding: 0.5rem 0.85rem !important;  /* Override animation value */
  }
  .element:hover .text {
    max-width: 10rem !important;
    opacity: 1 !important;
  }
  ```
- *Prevention:* For hover states that need to override animation end states, use `!important` on the specific properties rather than trying to stop/reverse the animation
