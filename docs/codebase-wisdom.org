#+TITLE: ox-astro Codebase Wisdom
#+DATE: [2025-09-23 Mon]

* Setup / Environment

* Codebase Quirks

** Pattern: Export happens in two distinct phases requiring careful state management
- *Mechanism:* Pre-processing phase (lines 91-178 in ox-astro.el) handles images/PDFs, then main export phase (179+) handles metadata
- *Actionable insight:* When adding metadata like SLUG, it must be added in the metadata phase (around line 180+), not earlier

** Fact: The export narrowing context affects keyword detection
- *Mechanism:* When exporting a subtree or in narrowed buffer, `org-element-parse-buffer` only sees the narrowed region
- *Actionable insight:* Always check for both title-kw and slug-kw within the narrowed context to avoid duplicate additions

* Debugging Tactics

** Technique: Use file modification notifications to track external changes
- *Mechanism:* Claude Code provides system reminders when files are modified externally
- *Actionable insight:* Pay attention to these notifications - they indicate your code may have been overwritten

* Tool Oddities (Claude Code, etc.)

** Behavior: Emacs batch mode syntax errors can be cryptic
- *Example:* "Invalid read syntax: ")", 371, 21" means extra closing parenthesis at line 371
- *Actionable insight:* Count parentheses carefully when editing Lisp code, especially in complex let* forms
- Emacs has a function (check-parens) that can help. If you still have trouble fixing mismatched parentheses, ask user to help!

* ox-astro Specific Patterns

** Pattern: Keyword insertion uses `org-astro--upsert-keyword-after-roam`
- *Mechanism:* This function intelligently places keywords after org-roam properties
- *Actionable insight:* Always use this helper instead of manual insertion to maintain consistent formatting

** Pattern: Front matter data flows through multiple functions
- *Flow:* ox-astro.el generates keywords → info plist → ox-astro-helpers.el `org-astro--get-front-matter-data` → MDX
- *Actionable insight:* To add new metadata, update both the keyword generation AND the front matter assembly

** Gotcha: Slug generation logic was split across multiple locations
- *Locations:*
  - ox-astro.el lines 118-125 (for image processing)
  - ox-astro.el lines 187-214 (for metadata addition)
  - ox-astro-helpers.el lines 552-554 (for front matter)
- *Actionable insight:* When modifying slug behavior, check ALL three locations to ensure consistency
- Question: Is this OK? should we consolidate slug generation logic to one place?

** Gotcha: Whitespace in config folder nicknames causes lookup failures
- *Date:* 2025-10-05
- *Trigger:* `#+DESTINATION_FOLDER: socratic` failed with "not found" error even though "socratic " existed in config
- *Mechanism:* `assoc` performs exact string matching, so `"socratic"` ≠ `"socratic "` (trailing space)
- *The Fix:* Implemented whitespace-tolerant lookup using `cl-find` with `string-trim` on both input and config keys (ox-astro.el:243-245, 100-103)
- *Prevention:*
  - Always trim whitespace from user input before lookup
  - Use `cl-find` with custom `:test` function instead of `assoc` for fuzzy matching
  - This pattern applies to any user-facing configuration lookups
- *Actionable insight:* Configuration errors (trailing spaces, inconsistent formatting) should be handled gracefully rather than failing with cryptic errors

** Pattern: MDX Export Blocks for Raw JSX/Components
- *Date:* 2025-10-05
- *Use Case:* Embedding Astro/React components directly in Org files
- *Mechanism:* Use `#+BEGIN_EXPORT mdx` / `#+END_EXPORT` blocks to pass JSX/MDX through verbatim
- *Implementation:* Added `org-astro-export-block` transcoder that recognizes MDX, MARKDOWN, and MD export types
- *Example:*
  ```org
  #+BEGIN_EXPORT mdx
  import CopyPromptButton from '@jaydixit/astro-utils/components/CopyPromptButton.astro';

  export const promptText = `Your text here`;

  <CopyPromptButton text={promptText} buttonText="Click me" />
  #+END_EXPORT
  ```
- *Actionable insight:* For one-off component usage, export blocks are cleaner than creating special transcoding logic

** Gotcha: Caption attributes must use HTML entities, not backslashes
- *Date:* 2025-12-02
- *Problem:* Backslash-escaped quotes inside `data-pswp-*` captions produced MDX parse errors (“Unexpected character \ in attribute name”).
- *Fix:* Attribute escaping now encodes &, <, >, and \" to HTML entities before injection.
- *Actionable insight:* If adding new caption-like attributes, escape to entities (e.g., `&quot;`) instead of backslashes.

** Gotcha: Org strips scheme from remote links in parse tree
- *Date:* 2025-12-01
- *Problem:* Remote image URLs were downloaded but not rewritten in the source buffer because Org parses `[[https://example.com/img.jpg]]` as `type="https"` and `path="//example.com/img.jpg"` (scheme removed).
- *Fix:* When rewriting, reconstruct the full URL using link type + path before searching/replacing; see `org-astro--process-image-manifest` and `org-astro--update-image-path-in-buffer`.
- *Actionable insight:* Whenever matching against remote links parsed from Org, prefer `:raw-link` or rebuild `type + path` instead of relying on `:path` alone.

** Gotcha: Export block indentation was converted to blockquotes
- *Date:* 2025-10-05
- *Trigger:* MDX export blocks with indented HTML (like `<button>`) were being converted to blockquote syntax (`> `)
- *Mechanism:*
  1. `org-astro-export-block` used `org-remove-indentation` which only removes *minimum* indentation, leaving some spaces
  2. `org-astro-final-output-filter` detects lines starting with 4+ spaces and converts them to blockquotes (`> `)
  3. The filter only skips this conversion for JSX components (uppercase tags like `<Image>`), not HTML elements (lowercase tags like `<div>`)
- *The Fix:* Changed export block handler to completely strip ALL leading whitespace: `(replace-regexp-in-string "^[ \t]+" "" content)`
- *Prevention:* Export blocks must output completely unindented content to avoid triggering the blockquote conversion logic
- *Actionable insight:* The final-output filter's blockquote conversion is aggressive - any content that should stay verbatim must have zero indentation

** Gotcha: User export hooks can strip org-roam links
- *Date:* 2025-10-20
- *Trigger:* User config added `org-export-id-link-removal` to `org-export-before-parsing-functions`, so Astro exports lost every `[[id:...]]` link.
- *Mechanism:* The hook runs inside Org's temporary export buffer, deleting ID objects before we ever build the parse tree; our transcoders never fire.
- *Clue we missed:* The regression only happened on the user's machine—our exports still worked. Divergent behavior means "check user hooks/config" before blaming core code.
- *Fix:* Added `org-astro--with-export-sanitization` and a blocklist that temporarily removes known-destructive hooks from both `org-export-before-processing-functions` and `org-export-before-parsing-functions` during Astro exports.
- *Prevention:*
  - When debugging export differences, diff `org-export-before-*-functions` between environments early.
  - Keep the blocklist updated if new destructive hooks appear.
  - Prefer adding guardrails in the exporter rather than relying on users to disable their tweaks.

** Gotcha: Deeply nested elisp parens cause cascading errors
- *Date:* 2025-11-29
- *Trigger:* Fixing one paren imbalance often introduced others; ended up with 56 missing parens across ~30 functions
- *Mechanism:* Complex `let*` bindings, nested `if`/`cond`/`when` forms, and multi-line `progn` blocks make manual paren counting error-prone
- *Clue we missed:* Attempting to fix parens one at a time without checking overall balance led to more errors
- *The Fix:* Reverted to last known working commit (1128b61) and applied changes incrementally
- *Prevention:*
  - Use `emacs --batch --eval '(check-parens)'` to verify paren balance before committing
  - When paren errors cascade, revert to known-good state rather than fixing forward
  - Use Emacs' `show-paren-mode` and structural editing tools during development
  - Test syntax with byte-compilation: `emacs --batch -f batch-byte-compile file.el`

** Gotcha: org-export-get-environment overwrites cached plist data
- *Date:* 2025-11-29
- *Trigger:* Export succeeds (file written) but then shows "Astro export cancelled: No posts folder selected" and returns nil
- *Mechanism:* The `info` plist gets rebuilt by `org-export-get-environment` calls during export, blowing away cached folder info from preprocessing
- *Symptom:* Folder resolution works first time, but second lookup (after buffer modifications) fails
- *Prevention:*
  - Resolve critical paths (destination folder, output file) exactly once per invocation
  - Store in local variables, not just the info plist
  - Reattach to info plist after any environment refresh if needed downstream
- *Fix strategy:* Cache folder resolution results in `let`-bound locals before any `org-export-get-environment` calls
