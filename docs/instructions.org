#+TITLE: ox-astro Operational Instructions
#+DATE: 2025-10-20

* Pre-Session Ritual
- Read the latest entry in =docs/work-log.org= for active context
- Check =docs/codebase-wisdom.org= for relevant gotchas
- Review =docs/design-architecture.org= for any architecture implications
- Compare your local export hooks when behavior diverges. Run
  =(list org-export-before-processing-functions org-export-before-parsing-functions)=
  and ensure nothing custom strips =[[id:...]]= links. Divergent results between
  machines usually mean a hook or config difference, not exporter code.

* Export Workflow
1. Open the source Org buffer
2. Ensure either =#+DESTINATION_FOLDER:=, =#+DESTINATION-FOLDER:=, or =#+ASTRO_POSTS_FOLDER:= points to a configured nickname
3. Run =M-x org-astro-export-to-mdx=
4. Inspect any warnings emitted in the minibuffer or =*Messages*=
5. If the buffer is narrowed, the export treats it as a subtree (both passes).
6. If the title keyword or filename is purely numeric date-like, the first heading becomes the title/slug/outfile (later non-date =#+TITLE= wins when present).

* ID-Based Link Resolution
- The exporter builds an ID→path map by scanning all =.org= files under =org-astro-source-root-folder=
- During export, =[[id:...][Label]]= links become standard Markdown links pointing to the correct =.mdx= output

** Absolute vs Relative Link Paths
You can configure ID links to use absolute routes (for Astro catch-all routing) or relative =.mdx= paths:

*** Per-Destination (Recommended)
Add =:id-link-base-path= to specific destinations in your config:

#+begin_src emacs-lisp
(setq org-astro-known-posts-folders
      '(("roam-life" . (:path "/path/to/life-web/src/content/notes/"
                        :preserve-folder-structure t
                        :id-link-base-path "/notes"))  ; → /notes/characters/rachel
        ("socraticai" . (:path "/path/to/blog"))))     ; → ../characters/rachel.mdx
#+end_src

*** Global Setting
Set =org-astro-id-link-base-path= to apply absolute routes to all exports:

#+begin_src emacs-lisp
(setq org-astro-id-link-base-path "/notes")
#+end_src

*** Priority Order
1. Destination config =:id-link-base-path= (highest)
2. Global =org-astro-id-link-base-path=
3. =nil= → relative =.mdx= paths (default)

** Other Link Behavior
- Astro export sanitizes known-destructive hooks (e.g., =org-export-id-link-removal=), but
  always double-check local hook lists if links disappear—the sanitization only helps when the
  hook name is on our blocklist.
- Relative paths mirror your Org directory structure (e.g., =[Mom](../characters/mom.mdx)=); configure destinations with =:preserve-folder-structure t= to keep nested collections aligned
- Missing IDs trigger a warning and the link degrades to plain text while remaining readable
- After export, check =broken-links.json= in the destination root for unresolved IDs
- Fix missing targets by adding the note (with matching =:ID:=) and re-exporting

* Configuration Checklist
- Set =org-astro-source-root-folder= to the top-level directory containing your org-roam notes
- Add a destination nickname with =:preserve-folder-structure t= if you want exports to mirror the roam hierarchy
- Verify your notes include =:ID:= drawers when you expect cross-note linking

* org-roam Compatibility
ox-astro handles org-roam files cleanly:
- *Property drawers* (=:PROPERTIES:= / =:ID:= / =:END:=) are stripped from body content; IDs go to frontmatter as =orgRoamId=
- *Template boilerplate* is removed from output:
  - =- **Links:**= and =- **Source:**= list items (with or without content)
  - Standalone =Links:= and =Source:= lines
  - Various indentation/formatting variants
- *ID links* (=[[id:...][Title]]=) resolve to MDX paths using the ID map built from your org-roam directory

** What Gets Stripped
The final output filter removes common org-roam template artifacts:

| Pattern                    | Example                  | Status   |
|----------------------------+--------------------------+----------|
| Bold list item (empty)     | =- **Links:**=           | Stripped |
| Bold list item (content)   | =- **Links:** [[id:...]]= | Preserved (links kept) |
| Standalone label           | =Links:=                 | Stripped |
| Property drawer lines      | =:ID: abc123=            | Stripped |

Note: If you have actual content after =Links:= or =Source:= labels (not just empty placeholders), those links are preserved.

* Debug and Development Options

** Clipboard Copying (macOS)
By default, clipboard copying is disabled. To enable copying of source/output/debug paths to macOS clipboard after export:

#+begin_src emacs-lisp
(setq org-astro-copy-to-clipboard t)
#+end_src

When enabled, exports copy the following paths to the system clipboard via =pbcopy=:
- Source Org file path
- Output MDX file path
- Debug log path (when debug mode is active)

** Debug Logging
Enable verbose debug logging for image processing:

#+begin_src emacs-lisp
(setq org-astro-debug-images t)
#+end_src

Debug output is written to the file specified by =org-astro-debug-log-file= (defaults to =ox-astro-debug.log= in the system temp directory).

* Image Configuration

** Responsive Images (Default)
By default, ox-astro generates =<Image />= components with =layout="responsive"=, which enables Astro 5.10+'s automatic srcset and sizes generation for optimal performance.

#+begin_src emacs-lisp
;; Default (responsive images enabled)
(setq org-astro-image-default-layout "responsive")
#+end_src

** Layout Options
- ="responsive"= (default): Image scales with container, auto srcset
- ="fixed"=: Image maintains exact dimensions
- ="full-width"=: Image spans full container width
- =nil= or ="none"=: No layout prop (basic behavior, pre-5.10 compatibility)

** Disabling Responsive Images
To revert to basic image behavior without the layout prop:

#+begin_src emacs-lisp
(setq org-astro-image-default-layout nil)
#+end_src

** Image Credits and Captions

Add credit and caption metadata to images using keywords that follow the image link.

*** Hero Image Metadata (Frontmatter)
For the hero/cover image, use keywords at document level:

#+begin_src org
[[/path/to/hero-image.png]]
#+HERO-CREDIT: Photographer Name or AI Model
#+HERO-CAPTION: Prompt or description text
#+end_src

These appear in the frontmatter as ~heroCredit~ and ~heroCaption~, and are displayed:
- Credit: On the page below the hero image
- Caption: In the PhotoSwipe lightbox when the image is clicked

*** Body Image Metadata
For images within the body content:

#+begin_src org
[[/path/to/body-image.jpg]]
#+IMAGE-CREDIT: Jay Dixit
#+IMAGE-CAPTION: Description or AI prompt text
#+end_src

Alternative keyword: ~#+IMAGE-PROMPT:~ (alias for ~IMAGE-CAPTION~)

*** Display Behavior
- *On page*: Credit appears as small gray text below the image (exact text you provide)
- *In lightbox*: Both credit (bold) and caption (italic) appear at the bottom (no automatic prefix)

*** Generated Output
Body images with credit/caption produce a figure wrapper:

#+begin_src html
<figure class="image-figure">
<a href={imgVar.src} data-pswp-item="true"
   data-pswp-caption="<strong>Generated With:</strong> Model<br/><em>Caption</em>" ...>
<Image src={imgVar} alt="..." layout="responsive" />
</a>
<figcaption class="image-caption text-xs text-gray-400 mt-2">
Generated With: Model
</figcaption>
</figure>
#+end_src

*** Notes
- Keywords must immediately follow the image (or other IMAGE-* keywords for the same image); blank lines in between are ok
- Underscores and hyphens are interchangeable (e.g., ~IMAGE_CREDIT~ = ~IMAGE-CREDIT~)
- The hero image is automatically suppressed from the body; its credit/caption only appear in the header area

* Verifying Broken Links
- Open the generated MDX file and click through the links to confirm navigation
- Review =broken-links.json= and resolve outstanding IDs before publishing
- Re-export once missing IDs exist—the links will auto-heal on the next run

* Metadata Fields

The exporter recognizes both plain and =ASTRO_= prefixed keywords for front matter.

** Standard Astro Fields
These are common fields used by most Astro content collections:

| Org Keyword        | Front Matter    | Notes                              |
|--------------------+-----------------+------------------------------------|
| =#+title:=         | =title=         | Required                           |
| =#+date:=          | =publishDate=   | ISO date format                    |
| =#+author:=        | =author=        | Defaults to "Jay Dixit"            |
| =#+excerpt:=       | =excerpt=       | Also accepts =SUBHED=, =DESCRIPTION= |
| =#+tags:=          | =tags=          | Array (comma-separated)            |
| =#+filetags:=      | =tags=          | Merged with =#+tags:=, deduped     |
| =#+categories:=    | =categories=    | Array                              |
| =#+image:=         | =image=         | Cover/hero image                   |
| =#+draft:=         | =draft=         | Boolean                            |

** Extended Fields (life-web project)
These fields are custom extensions for narrative/memoir content. They require a matching schema in your Astro content collection config. Standard Astro users can ignore these or adapt them for their own projects.

| Org Keyword             | Front Matter     | Notes                                        |
|-------------------------+------------------+----------------------------------------------|
| =#+date_occurred:=      | =dateOccurred=   | When the story happened (vs publish date)    |
| =#+era:=                | =era=            | Time period identifier                       |
| =#+place:=              | =place=          | Single location string                       |
| =#+places:=             | =places=         | Array of locations                           |
| =#+people:=             | =people=         | Array of people involved                     |
| =#+emotions:=           | =emotions=       | Array of emotional themes                    |
| =#+themes:=             | =themes=         | Array of thematic elements                   |
| =#+story_type:=         | =storyType=      | full-story, vignette, snapshot, fragment, conversation |
| =#+incomplete:=         | =incomplete=     | Boolean - story is unfinished                |
| =#+connection_temporal:= | =connections.temporal= | Related stories by time             |
| =#+connection_emotional:= | =connections.emotional= | Related stories by emotion        |
| =#+connection_thematic:= | =connections.thematic= | Related stories by theme           |
| =#+media:=              | =media=          | Array of media attachments                   |

** Usage Notes
- Arrays accept quoted multi-word tokens (e.g., =#+people: "Mom's apartment"=)
- Comma-separated values preserve internal spaces (e.g., =#+places: Brooklyn, Hungry Ghost Coffee=)
- After enriching an Org note, re-export to confirm the MDX front matter includes the expected fields

* Theme Sections and Model Banners

For multi-AI blog posts, use ~#+THEME:~ and ~#+MODEL:~ keywords to create visually distinct sections.

** Placement Rules
- *Document level* (before any heading): ~#+THEME:~ goes to frontmatter only
- *Body level* (after a heading): ~#+THEME:~ and ~#+MODEL:~ emit inline markers

** Quick Reference
#+begin_src org
* Section Title

#+THEME: claude
#+MODEL: Claude Sonnet 4.5

#+begin_src user
User prompt here
#+end_src

AI response here...
#+end_src

** Supported Themes
- ~chatgpt~ — ChatGPT styling with green logo
- ~gemini~ — Gemini styling with sparkle logo
- ~claude~ — Claude styling with Anthropic logo
- ~default~ — Reset to site default (no wrapper)

** Common Patterns
- Single-AI post: Put ~#+THEME:~ at document level for page-wide styling
- Multi-AI post: Put ~#+THEME:~ + ~#+MODEL:~ after each section heading
- Author commentary: Use ~#+THEME: default~ to reset styling

* Reference
- Architecture: [[file:design-architecture.org]]
- Terminology: [[file:concept-map.org]]
- Debugging wisdom: [[file:codebase-wisdom.org]]
