#+TITLE: Image Export Issues and Analysis
#+AUTHOR: Jay Dixit & Claude
#+DATE: 2025-08-28

* Problem Summary

The ox-astro image handling has been improved, but a few gaps remain:

1. **Image Display Fixed**: All body images (excluding implicit hero) render as `<Image>` components; Org file links to images are converted too.
2. **Path Updating Workflow Changed**: Instead of in-place rewrites during export, a suggestions block is inserted at the top of the org file with old → new path mappings (and alias paths) for manual replacement.

* Current Behavior vs. Desired Behavior

** Current Behavior

*** Test Case: massimo-dutti.org (Updated Analysis)
*Original org file contains:*
- Line ~49: `/Users/jay/Downloads/masimo-dutti.webp` (first in document order)
- Line ~157: `/Users/jay/Downloads/106910784_3615490375147223_8376969077115059792_n.jpg` (first in Images section)
- Line ~161: `/Users/jay/Downloads/502610958_24533456482923974_1694898706627993310_n.jpg` (missing from body)
- Line ~165: `/Users/jay/Downloads/502963633_24533456719590617_6999624331092055355_n.jpg` (missing from body)  
- Line ~169: `/Users/jay/Downloads/Rachide-News-01(1).jpg` (shows in body)
- Line ~173: `/Users/jay/Downloads/2017021468194489.webp` (shows in body)

*After export:*
- ✅ All 6 images are detected and imported in MDX file
- ✅ Images are copied to `src/assets/images/posts/massimo-dutti/` with proper slug-based organization
- ✅ File links and raw absolute paths are converted to `<Image>` components in content where working
- ✅ Hero selection logic working correctly (collection order determines hero, not document order)
- ✅ A suggestions comment block is added at the top with old → new → alias mappings for manual replacement

*MDX Results (Observed):*
- **Hero image**: `106910784_3615490375147223_8376969077115059792_n.jpg` (becomes implicit cover in front matter)
- **Import generation order** (not document order):
  1. `hero` (106910784... - excluded from body as hero)
  2. `img502610958...` (imported but missing from body ❌)
  3. `img502963633...` (imported but missing from body ❌)  
  4. `RachideNews011` (shows in body ✅)
  5. `masimoDutti` (shows in body ✅)
  6. `img2017021468194489` (shows in body ✅)
- **Pattern**: Only first 2 images after hero in collection order fail to appear in body content
- **Root Issue**: Export pipeline state synchronization problem during transcoding phase

** Desired Behavior

- MDX: All images display properly (hero + body). Achieved.
- Org source: Exporter inserts a suggestions block at the top listing, for each image, the original path, the new absolute path under `src/assets/images/posts/{slug}/`, and the `~/assets/...` alias for MDX. Authors replace paths manually (or run a dedicated one-off “apply replacements” helper). No in-place overwrites during export.

* Root Cause Analysis

** Issue 1: Path Updating Reliability

- In-place rewrites during export were fragile (buffer context, narrowing, temp buffers), leading to non-persistent edits.
- Switching to an explicit suggestions block avoids accidental edits and is robust/reviewable.

** Issue 2: Incomplete Image Display (Partially Fixed)

- File image links are converted in `org-astro-link` to `<Image>` using imports.
- Raw absolute image lines are converted based on collected imports; `(file-exists-p ...)` checks removed.
- Hero exclusion logic is applied consistently.
- Remaining problem: Body images with underscores in filenames (e.g., `..._n.jpg`) in the `# Images` section are not appearing in the MDX body, even though they were copied and imported.
  - Likely due to Org parsing and/or our paragraph/plain-text handling around underscore/subscript cases.
  - Our “broken image paragraph” handler may not trigger for these particular lines, or matching fails when context contains surrounding text (e.g., adjacent `ok`/`OK` lines).

* Implementation Attempts and Results

** Attempt 1: Post-Specific Image Folders
*Goal:* Organize images into `src/assets/images/posts/{slug}/` folders

*Implementation:*
- Modified `org-astro-prepare-images-filter` to generate slug and use it as sub-directory
- Updated `org-astro--get-assets-folder` to handle slug-based paths
- Updated both body and cover image processing

*Result:* ✅ **SUCCESS** - Images are correctly organized into post-specific folders

** Attempt 2: Automatic Source File Cleanup (Old)  
*Goal:* Update org file paths after copying images

*Implementation (Old):* In-place rewrite attempts during export.

*Result:* ❌ **UNRELIABLE** - Edits sometimes didn’t persist due to export buffer context.

** Attempt 3: Re-export Testing (Old)
*Goal:* Verify repeatability

*Result:* ❌ **FAILED** - Same persistence issues.

** Attempt 4: Link + Raw Path Conversion (New)
*Goal:* Ensure all images render regardless of source path updates

*Implementation:* Convert file links to `<Image>` in `org-astro-link`; remove `(file-exists-p ...)` dependency; unify hero exclusion.

*Result:* ✅ **SUCCESS** - All non-hero images render; hero is cover.

** Attempt 5: Suggestions Block (New)
*Goal:* Provide reliable, reviewable path updates

*Implementation:* Insert `# BEGIN ASTRO IMAGE PATH SUGGESTIONS` block at top with old/new/alias mapping.

*Result:* ✅ **SUCCESS** - Authors can replace paths manually (or via a one-off apply helper).

* Current Status (Updated 2025-08-28)

** Working Components ✅
- Image detection and collection from multiple sources (org links, raw paths)
- Image copying to organized folder structure (`posts/{slug}/`)
- MDX import generation for all detected images
- Filename sanitization and variable name generation
- Post-specific folder organization using slugs
- **Manual bracket wrapping**: Converting raw image paths to `[[path]]` format in source files before export
- Conversion of org-mode file links `[[path]]` to `<Image>` components (reliable)
- Hero image selection (first collected image becomes cover image)
- Import matching logic (tested and confirmed functional)
- Regex patterns for image detection (both underscore and non-underscore paths)

** New Approach: Manual Bracket Wrapping ✅
- **Manual Solution**: Use Emacs batch command to wrap all raw image paths in `[[ ]]` brackets before export
- **Command**: `emacs --batch --eval "(progn (find-file \"file.org\") (goto-char (point-min)) (while (re-search-forward \"^\\\\s-*\\\\(/[^[:space:]]*\\\\.\\\\(?:png\\\\|jpe?g\\\\|webp\\\\)\\\\)\\\\s-*$\" nil t) (let ((path (match-string 1))) (unless (save-match-data (string-match-p \"\\\\[\\\\[.*\\\\]\\\\]\" (match-string 0))) (replace-match (concat \"[[\" path \"]]\"))))) (save-buffer))"`
- **Result**: All 6 images successfully converted to `<Image>` components in final MDX
- **Verification**: Tested with massimo-dutti.org - all raw paths converted from `/Users/jay/Downloads/...` to `[[/Users/jay/Downloads/...]]`

** Automatic Filter Issues ❌
- **Attempted**: `org-astro-normalize-raw-image-paths-filter` to automatically wrap raw paths during export
- **Result**: Filter registers correctly but doesn't modify source files persistently
- **Root Causes**:
  1. **Buffer Context**: Export process uses temporary/narrowed buffers where changes don't persist to source files
  2. **Timing Issues**: Filter runs during parse tree processing, before final transcoding
  3. **State Management**: Changes made to parse tree elements don't reflect back to source buffer
- **Evidence**: Manual wrapping works perfectly, but automatic filter during export fails to persist changes

** Remaining Gaps ❌
- **Automatic wrapping during export**: The `org-astro-normalize-raw-image-paths-filter` doesn't successfully modify source files
  - Filter executes but changes don't persist to the actual org file on disk
  - Export pipeline buffer management prevents source file modifications
  - Manual pre-processing is required instead
- **User Experience**: Requires two-step process (wrap paths, then export) instead of seamless one-step export
- Document implicit hero behavior (first image excluded from body when no `#+COVER_IMAGE`).

* Next Steps for Resolution

** Priority 1: Fix Automatic Bracket Wrapping 
- **Issue**: Current filter approach doesn't modify source files during export
- **Investigation Needed**: 
  - Understand org-mode export buffer management and timing
  - Find correct hook/filter that can modify source files before parse tree generation
  - Consider pre-export hook instead of parse-tree filter
- **Alternative**: Create separate interactive command for bracket wrapping that runs before export

** Testing Results (2025-08-28) ✅
- **Test Case**: massimo-dutti.org with 6 images (5 raw paths + 1 already wrapped)
- **Before bracket wrapping**: Only 1 image appeared in final MDX output
- **After manual bracket wrapping**: All 6 images successfully converted to `<Image>` components
- **Source file changes**: All raw paths like `/Users/jay/Downloads/image.jpg` became `[[/Users/jay/Downloads/image.jpg]]`
- **MDX output verification**: 
  - Hero image: `masimoDutti` (first collected image used as cover)
  - Body images: All 5 remaining images appear as `<Image src={varName} alt="..." />` components
  - Import generation: All 6 images have corresponding import statements

** Priority 2: Image Display Issue Deep Dive
- **Previous Issue RESOLVED**: The missing underscore images problem was resolved by manual bracket wrapping
- **Root Cause Identified**: Raw image paths need to be converted to org-mode file links `[[path]]` to be processed correctly by the standard org-mode link transcoding pipeline
  - Variable name generation issues ❌ (names generated correctly)  
  - Import matching logic failures ❌ (tested in isolation and works perfectly)
  - File existence or path sanitization problems ❌ (all working correctly)
- **Actual Root Cause**: Export pipeline state management issue where:
  - All 6 images are correctly collected and processed ✅
  - All 6 images generate proper imports in MDX ✅  
  - Hero selection works correctly (first image becomes cover) ✅
  - But first 2 images after hero in collection order don't appear in body content ❌
- **Required Fix**: Deep debugging of Org mode export transcoding pipeline state synchronization between `org-astro--current-body-images-imports` global variable and `:astro-body-images-imports` info plist during the paragraph/plain-text processing phase.
- **Workaround**: The core functionality (post-specific folders + path suggestions) works correctly; missing images is a separate transcoding issue.

** Priority 3: Integration Testing
- Create comprehensive test cases
- Verify end-to-end workflow with various scenarios
- Test with different image arrangements and quantities

* Technical Notes

** Export Process Flow
1. **Parse Tree Filter** (`org-astro-prepare-images-filter`): Detect images, copy files, store import data
2. **Content Transcoding**: Transform org elements to MDX, including image conversion
3. **Final Assembly**: Combine front matter, imports, and body content

** Key Functions Involved
- `org-astro-prepare-images-filter`: Main image processing entry point
- `org-astro--process-image-path`: Copy image to assets and record mapping
- `org-astro-link`: Convert file image links to `<Image>` using imports
- `org-astro-plain-text`/`org-astro-paragraph`: Convert raw absolute paths to `<Image>` without filesystem checks
- `org-astro--upsert-image-paths-comment(-into-file)`: Insert suggestions block at top of org file

With these changes, MDX output is complete and correct. Path updates in the org source are now handled via a clear, manual workflow supported by the suggestions block.
